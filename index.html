<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>BeLive ALPS Management Dashboard</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;background:#f5f6fa;height:100vh;overflow:hidden}
    .dashboard{display:flex;height:100vh}
    .sidebar{width:280px;background:#2c3e50;color:#fff;padding:20px;overflow-y:auto}
    .nav-item{padding:15px;margin:5px 0;border-radius:8px;cursor:pointer;display:flex;gap:10px;align-items:center;transition:.2s}
    .nav-item:hover,.nav-item.active{background:#34495e;transform:translateX(4px)}
    .nav-icon{font-size:20px}
    .main-content{flex:1;display:flex;flex-direction:column;overflow:hidden}
    .header{background:#fff;padding:20px;box-shadow:0 2px 10px rgba(0,0,0,.08);display:flex;justify-content:space-between;align-items:center}
    .content-area{flex:1;padding:20px;overflow-y:auto}
    .page{display:none}.page.active{display:block}

    /* Live pill */
    .live-indicator{display:inline-flex;gap:6px;align-items:center;background:#e74c3c;color:#fff;padding:5px 10px;border-radius:14px;font-size:12px;font-weight:700}
    .pulse-dot{width:8px;height:8px;border-radius:50%;background:#fff;animation:pulse 2s infinite}
    @keyframes pulse{0%{opacity:1}50%{opacity:.5}100%{opacity:1}}

    /* Agent cards */
    .agents-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:20px;margin-bottom:30px}
    .agent-card{background:#fff;border-radius:15px;padding:20px;box-shadow:0 4px 14px rgba(0,0,0,.08);cursor:pointer;border-left:5px solid #3498db;transition:.2s}
    .agent-card:hover{transform:translateY(-4px)}
    .agent-card.top-sales{border-left-color:#f39c12;background:linear-gradient(135deg,#fff9e6,#fff)}
    .agent-card.available{border-left-color:#2ecc71}
    .agent-card.busy{border-left-color:#e74c3c}
    .agent-card.away{border-left-color:#95a5a6}
    .agent-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
    .agent-name{font-weight:700}
    .agent-status{padding:5px 12px;border-radius:20px;font-size:12px;font-weight:700}
    .status-available{background:#2ecc71;color:#fff}
    .status-busy{background:#e74c3c;color:#fff}
    .status-away{background:#f39c12;color:#fff}
    .capacity-bar{background:#ecf0f1;height:12px;border-radius:6px;overflow:hidden;margin:10px 0}
    .capacity-fill{height:100%;border-radius:6px;transition:width .4s}
    .capacity-low{background:#2ecc71}.capacity-medium{background:#f39c12}.capacity-high{background:#e74c3c}
    .agent-stats{display:flex;justify-content:space-between;margin-top:12px}
    .stat-item{text-align:center}.stat-number{font-weight:800;color:#2c3e50}

    .queue-management{background:#fff;border-radius:15px;padding:20px;box-shadow:0 4px 14px rgba(0,0,0,.08)}
    .queue-item{display:flex;justify-content:space-between;align-items:center;padding:14px;margin:10px 0;background:#f8f9fa;border-left:4px solid #3498db;border-radius:10px;cursor:move}
    .drag-handle{cursor:grab;color:#7f8c8d;font-size:18px}

    /* Leads */
    .leads-container{display:grid;grid-template-columns:1fr 1fr;gap:30px;height:100%}
    .leads-section{background:#fff;border-radius:15px;padding:20px;box-shadow:0 4px 14px rgba(0,0,0,.08);display:flex;flex-direction:column;overflow:hidden}
    .section-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;padding-bottom:12px;border-bottom:2px solid #ecf0f1}
    .leads-list{flex:1;overflow-y:auto}
    .lead-item{display:flex;gap:12px;align-items:center;background:#f8f9fa;border-radius:12px;padding:14px;margin:10px 0;border-left:4px solid #95a5a6;cursor:pointer;transition:.2s}
    .lead-item:hover{transform:translateX(4px)}
    .lead-item.hot{border-left-color:#e74c3c;background:linear-gradient(135deg,#ffebee,#f8f9fa)}
    .lead-item.warm{border-left-color:#f39c12;background:linear-gradient(135deg,#fff8e1,#f8f9fa)}
    .lead-score{width:56px;height:56px;border-radius:50%;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:800}
    .score-hot{background:linear-gradient(135deg,#e74c3c,#c0392b)}
    .score-warm{background:linear-gradient(135deg,#f39c12,#e67e22)}
    .score-cold{background:linear-gradient(135deg,#95a5a6,#7f8c8d)}
    .lead-name{font-weight:700}
    .lead-details{font-size:14px;color:#7f8c8d}
    .lead-timestamp{font-size:12px;color:#b4bcc2}

    /* Chat */
    .chat-container{background:#fff;border-radius:15px;box-shadow:0 4px 14px rgba(0,0,0,.08);height:100%;display:flex;flex-direction:column;position:relative}
    .chat-header{background:#25D366;color:#fff;padding:18px;border-radius:15px 15px 0 0;display:flex;justify-content:space-between}
    .chat-messages{flex:1;overflow-y:auto;padding:18px;background:#e5ddd5}
    .message{max-width:70%;padding:12px 16px;margin:10px 0;border-radius:18px;animation:msg .2s ease-out}
    @keyframes msg{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
    .message-bot{background:#fff;align-self:flex-start;border-bottom-left-radius:4px;box-shadow:0 1px 2px rgba(0,0,0,.08)}
    .message-user{background:#DCF8C6;align-self:flex-end;border-bottom-right-radius:4px;margin-left:auto;box-shadow:0 1px 2px rgba(0,0,0,.08)}
    .message-system{background:#fff3cd!important;border:2px solid #ffeaa7!important;text-align:center!important;max-width:90%!important;margin:10px auto!important}

    /* Floating ALPS card (always visible beside chat) */
    .score-display{position:absolute;top:84px;right:18px;background:rgba(255,255,255,.96);padding:14px;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,.12);min-width:220px;z-index:5}
    .score-bar{height:20px;background:#e0e0e0;border-radius:10px;overflow:hidden;margin:8px 0}
    .score-fill{height:100%;border-radius:10px;transition:width .4s}
    .score-fill.score-hot{background:linear-gradient(90deg,#e74c3c,#c0392b)}
    .score-fill.score-warm{background:linear-gradient(90deg,#f39c12,#e67e22)}
    .score-fill.score-cold{background:linear-gradient(90deg,#95a5a6,#7f8c8d)}

    /* Consistent multi-select styling */
    .checkbox-group{display:flex;flex-direction:column;gap:8px;margin-top:10px}
    .checkbox-item{display:flex;align-items:center;gap:10px;padding:12px 14px;border:2px solid #e0e0e0;background:#f8f9fa;border-radius:16px;cursor:pointer;transition:.15s}
    .checkbox-item:hover{border-color:#25D366;background:#eafaf0}
    .checkbox-item.selected{border-color:#25D366;background:#25D366;color:#fff}
    .checkbox-item input{transform:scale(1.2)}
    .continue-btn{align-self:flex-start;margin-top:4px;padding:10px 16px;border:none;border-radius:999px;background:#25D366;color:#fff;font-weight:700;cursor:pointer}

    /* SLA */
    .sla-container{display:grid;grid-template-columns:1fr 2fr;gap:20px;height:100%}
    .conversations-list{background:#fff;border-radius:15px;padding:20px;box-shadow:0 4px 14px rgba(0,0,0,.08);overflow-y:auto}
    .conversation-item{padding:14px;margin:10px 0;background:#f8f9fa;border-radius:10px;border-left:4px solid #3498db;cursor:pointer;transition:.2s}
    .conversation-item:hover{background:#e3f2fd;transform:translateX(4px)}
    .conversation-item.sla-warning{border-left-color:#f39c12;background:#fff8e1}
    .conversation-item.sla-breach{border-left-color:#e74c3c;background:#ffebee}
    .sla-timer{display:flex;gap:10px;align-items:center;margin-top:8px}
    .timer-negative{background:#f39c12;color:#fff;padding:5px 10px;border-radius:14px;font-weight:800}
    .timer-positive{background:#e74c3c;color:#fff;padding:5px 10px;border-radius:14px;font-weight:800}
    .sla-chat-area{background:#fff;border-radius:15px;box-shadow:0 4px 14px rgba(0,0,0,.08);display:flex;flex-direction:column}
    .sla-chat-header{background:#34495e;color:#fff;padding:18px;border-radius:15px 15px 0 0;display:flex;justify-content:space-between}
    .sla-messages{flex:1;overflow-y:auto;padding:18px;background:#f8f9fa}
    .sla-input{display:flex;gap:10px;padding:18px;border-top:1px solid #ecf0f1}
    .sla-input input{flex:1;padding:12px;border:2px solid #ecf0f1;border-radius:22px;outline:none}
    .sla-input button{padding:12px 18px;border:none;border-radius:22px;color:#fff;background:#25D366;cursor:pointer}
    .options-container{display:flex;flex-direction:column;gap:8px;margin-top:10px}
    .option-button{padding:10px 14px;background:#f0f0f0;border:2px solid #e0e0e0;border-radius:20px;cursor:pointer;text-align:center}
    .option-button:hover{background:#25D366;color:#fff;border-color:#25D366}
    .property-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:10px;margin-top:10px}
    .property-item{padding:12px;background:#f8f9fa;border:2px solid #e9ecef;border-radius:12px;text-align:center;cursor:pointer}
    .property-item:hover{background:#25D366;color:#fff;border-color:#25D366}
    .input-field{width:100%;padding:12px;border:2px solid #e0e0e0;border-radius:20px;margin-top:10px}
    .typing-indicator{display:none;background:#fff;padding:14px;border-radius:18px;max-width:70%;border-bottom-left-radius:4px}
    .typing-dots{display:flex;gap:4px}.typing-dot{width:8px;height:8px;background:#999;border-radius:50%;animation:typing 1.4s infinite}
    .typing-dot:nth-child(2){animation-delay:.2s}.typing-dot:nth-child(3){animation-delay:.4s}
    @keyframes typing{0%,60%,100%{transform:translateY(0)}30%{transform:translateY(-8px)}}

    /* Modal */
    .modal{display:none;position:fixed;z-index:1000;inset:0;background:rgba(0,0,0,.5)}
    .modal-content{background:#fff;margin:5% auto;padding:24px;border-radius:14px;width:80%;max-width:820px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
    .close{float:right;font-size:26px;cursor:pointer;color:#666}
    .btn{padding:10px 18px;border:none;border-radius:8px;cursor:pointer;font-weight:700}
    .btn-primary{background:#3498db;color:#fff}.btn-danger{background:#e74c3c;color:#fff}

    /* SLA alert */
    .sla-alert{position:fixed;z-index:1100;top:50%;left:50%;transform:translate(-50%,-50%);background:#fff;padding:26px;border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.3);display:none;border-left:5px solid #e74c3c}
    .alert-actions{display:flex;gap:12px;margin-top:16px;justify-content:center}

    @media(max-width:900px){
      .leads-container{grid-template-columns:1fr}
      .sla-container{grid-template-columns:1fr}
      .score-display{position:relative;top:0;right:0;margin:10px}
    }
  </style>
</head>
<body>
  <div class="dashboard">
    <!-- Sidebar -->
    <div class="sidebar">
      <h2 style="margin-bottom:24px">üè† BeLive ALPS</h2>

      <div class="nav-item active" data-page="agents"><span class="nav-icon">üë•</span><span>Agent Status</span></div>
      <div class="nav-item" data-page="leads"><span class="nav-icon">üìä</span><span>Lead Management</span></div>
      <div class="nav-item" data-page="chat"><span class="nav-icon">üí¨</span><span>Chat Window</span></div>
      <div class="nav-item" data-page="sla"><span class="nav-icon">‚è±Ô∏è</span><span>SLA Monitoring</span></div>

      <div style="margin-top:36px;padding:16px;background:rgba(255,255,255,.1);border-radius:10px">
        <div class="live-indicator"><div class="pulse-dot"></div>LIVE</div>
        <div style="margin-top:10px;font-size:14px">
          System Status: Active<br/>
          Last Update: <span id="lastUpdate">--:--:--</span>
        </div>
      </div>
    </div>

    <!-- Main -->
    <div class="main-content">
      <div class="header">
        <div>
          <h1 id="pageTitle">Agent Status Dashboard</h1>
          <p id="pageSubtitle">Real-time agent monitoring and queue management</p>
        </div>
        <div class="live-indicator"><div class="pulse-dot"></div>LIVE DASHBOARD</div>
      </div>

      <div class="content-area">
        <!-- Agents -->
        <div id="agents" class="page active">
          <div class="agents-grid">
            <div class="agent-card top-sales available" data-agent="agent1">
              <div class="agent-header">
                <div class="agent-name">üëë Sarah Chen</div>
                <div class="agent-status status-available">Available</div>
              </div>
              <div class="role-line">Top Sales ‚Ä¢ Queue Position: <span class="pos">1</span></div>
              <div class="capacity-bar"><div class="capacity-fill capacity-low" style="width:30%"></div></div>
              <div class="capacity-text">Capacity: 3/10 chats</div>
              <div class="agent-stats">
                <div class="stat-item"><div class="stat-number">95%</div><div class="stat-label">SLA Rate</div></div>
                <div class="stat-item"><div class="stat-number">8.7</div><div class="stat-label">Avg Score</div></div>
                <div class="stat-item"><div class="stat-number">24</div><div class="stat-label">Leads Today</div></div>
              </div>
            </div>

            <div class="agent-card busy" data-agent="agent2">
              <div class="agent-header">
                <div class="agent-name">Mike Johnson</div>
                <div class="agent-status status-busy">Busy</div>
              </div>
              <div class="role-line">Agent ‚Ä¢ Queue Position: <span class="pos">2</span></div>
              <div class="capacity-bar"><div class="capacity-fill capacity-high" style="width:80%"></div></div>
              <div class="capacity-text">Capacity: 8/10 chats</div>
              <div class="agent-stats">
                <div class="stat-item"><div class="stat-number">88%</div><div class="stat-label">SLA Rate</div></div>
                <div class="stat-item"><div class="stat-number">7.9</div><div class="stat-label">Avg Score</div></div>
                <div class="stat-item"><div class="stat-number">18</div><div class="stat-label">Leads Today</div></div>
              </div>
            </div>

            <div class="agent-card available" data-agent="agent3">
              <div class="agent-header">
                <div class="agent-name">Lisa Wong</div>
                <div class="agent-status status-available">Available</div>
              </div>
              <div class="role-line">Agent ‚Ä¢ Queue Position: <span class="pos">3</span></div>
              <div class="capacity-bar"><div class="capacity-fill capacity-medium" style="width:50%"></div></div>
              <div class="capacity-text">Capacity: 5/10 chats</div>
              <div class="agent-stats">
                <div class="stat-item"><div class="stat-number">92%</div><div class="stat-label">SLA Rate</div></div>
                <div class="stat-item"><div class="stat-number">8.2</div><div class="stat-label">Avg Score</div></div>
                <div class="stat-item"><div class="stat-number">15</div><div class="stat-label">Leads Today</div></div>
              </div>
            </div>

            <div class="agent-card away" data-agent="agent4">
              <div class="agent-header">
                <div class="agent-name">David Lim</div>
                <div class="agent-status status-away">Break</div>
              </div>
              <div class="role-line">Agent ‚Ä¢ Queue Position: <span class="pos">4</span></div>
              <div class="capacity-bar"><div class="capacity-fill capacity-low" style="width:0%"></div></div>
              <div class="capacity-text">Capacity: 0/10 chats</div>
              <div class="agent-stats">
                <div class="stat-item"><div class="stat-number">85%</div><div class="stat-label">SLA Rate</div></div>
                <div class="stat-item"><div class="stat-number">7.4</div><div class="stat-label">Avg Score</div></div>
                <div class="stat-item"><div class="stat-number">12</div><div class="stat-label">Leads Today</div></div>
              </div>
            </div>

            <div class="agent-card available" data-agent="agent5">
              <div class="agent-header">
                <div class="agent-name">Jennifer Tan</div>
                <div class="agent-status status-available">Available</div>
              </div>
              <div class="role-line">Agent ‚Ä¢ Queue Position: <span class="pos">5</span></div>
              <div class="capacity-bar"><div class="capacity-fill capacity-low" style="width:20%"></div></div>
              <div class="capacity-text">Capacity: 2/10 chats</div>
              <div class="agent-stats">
                <div class="stat-item"><div class="stat-number">78%</div><div class="stat-label">SLA Rate</div></div>
                <div class="stat-item"><div class="stat-number">6.8</div><div class="stat-label">Avg Score</div></div>
                <div class="stat-item"><div class="stat-number">9</div><div class="stat-label">Leads Today</div></div>
              </div>
            </div>
          </div>

          <div class="queue-management">
            <h3 style="margin-bottom:12px">üìã Agent Queue Management</h3>
            <p style="margin-bottom:10px;color:#7f8c8d">Drag to reorder priority ‚Ä¢ Position 1 automatically becomes <strong>Top Sales</strong></p>

            <div id="queueList">
              <div class="queue-item" draggable="true" data-agent="agent1" data-position="1">
                <div style="display:flex;align-items:center;gap:12px">
                  <div class="drag-handle">‚â°</div><div class="queue-label">üëë <strong>Sarah Chen</strong> - Top Sales</div>
                </div><div class="position-text">Position: 1</div>
              </div>
              <div class="queue-item" draggable="true" data-agent="agent2" data-position="2">
                <div style="display:flex;align-items:center;gap:12px">
                  <div class="drag-handle">‚â°</div><div class="queue-label"><strong>Mike Johnson</strong> - Agent</div>
                </div><div class="position-text">Position: 2</div>
              </div>
              <div class="queue-item" draggable="true" data-agent="agent3" data-position="3">
                <div style="display:flex;align-items:center;gap:12px">
                  <div class="drag-handle">‚â°</div><div class="queue-label"><strong>Lisa Wong</strong> - Agent</div>
                </div><div class="position-text">Position: 3</div>
              </div>
              <div class="queue-item" draggable="true" data-agent="agent4" data-position="4">
                <div style="display:flex;align-items:center;gap:12px">
                  <div class="drag-handle">‚â°</div><div class="queue-label"><strong>David Lim</strong> - Agent</div>
                </div><div class="position-text">Position: 4</div>
              </div>
              <div class="queue-item" draggable="true" data-agent="agent5" data-position="5">
                <div style="display:flex;align-items:center;gap:12px">
                  <div class="drag-handle">‚â°</div><div class="queue-label"><strong>Jennifer Tan</strong> - Agent</div>
                </div><div class="position-text">Position: 5</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Leads -->
        <div id="leads" class="page">
          <div class="leads-container">
            <div class="leads-section">
              <div class="section-header">
                <h3>üî• Ongoing Leads</h3>
                <div class="live-indicator"><div class="pulse-dot"></div>LIVE</div>
              </div>
              <div class="leads-list" id="ongoingLeads">
                <!-- Seed items -->
                <div class="lead-item hot" data-lead="lead1" onclick="showLeadChart('lead1')">
                  <div class="lead-score score-hot">87</div>
                  <div class="lead-info">
                    <div class="lead-name">üî• Lead #2024001</div>
                    <div class="lead-details">Area: Mont Kiara ‚Ä¢ Budget: RM1200<br/>Move-in: 3 days ‚Ä¢ Agent: Sarah Chen</div>
                    <div class="lead-timestamp">Started: 14:32 ‚Ä¢ Duration: 12 mins</div>
                  </div>
                </div>
                <div class="lead-item hot" data-lead="lead2" onclick="showLeadChart('lead2')">
                  <div class="lead-score score-hot">82</div>
                  <div class="lead-info">
                    <div class="lead-name">üî• Lead #2024002</div>
                    <div class="lead-details">Area: KL/Selangor ‚Ä¢ Budget: RM900<br/>Move-in: 1 week ‚Ä¢ Agent: Mike Johnson</div>
                    <div class="lead-timestamp">Started: 14:45 ‚Ä¢ Duration: 8 mins</div>
                  </div>
                </div>
                <div class="lead-item warm" data-lead="lead3" onclick="showLeadChart('lead3')">
                  <div class="lead-score score-warm">65</div>
                  <div class="lead-info">
                    <div class="lead-name">‚≠ê Lead #2024003</div>
                    <div class="lead-details">Area: Petaling Jaya ‚Ä¢ Budget: RM750<br/>Move-in: 2 weeks ‚Ä¢ Agent: Lisa Wong</div>
                    <div class="lead-timestamp">Started: 14:52 ‚Ä¢ Duration: 5 mins</div>
                  </div>
                </div>
              </div>
            </div>

            <div class="leads-section">
              <div class="section-header">
                <h3>üìã Past Leads</h3>
                <div style="font-size:14px;color:#7f8c8d">Last 24 hours</div>
              </div>
              <div class="leads-list" id="pastLeads">
                <div class="lead-item hot" data-lead="past1" onclick="showLeadChart('past1')">
                  <div class="lead-score score-hot">91</div>
                  <div class="lead-info">
                    <div class="lead-name">‚úÖ Lead #2024-100</div>
                    <div class="lead-details">Converted ‚Ä¢ Final Score: 91<br/>Agent: Sarah Chen ‚Ä¢ Duration: 25 mins</div>
                    <div class="lead-timestamp">Completed: 13:45</div>
                  </div>
                </div>
                <div class="lead-item warm" data-lead="past2" onclick="showLeadChart('past2')">
                  <div class="lead-score score-warm">67</div>
                  <div class="lead-info">
                    <div class="lead-name">üìû Lead #2024-099</div>
                    <div class="lead-details">Callback Scheduled ‚Ä¢ Final Score: 67<br/>Agent: Mike Johnson ‚Ä¢ Duration: 18 mins</div>
                    <div class="lead-timestamp">Completed: 12:30</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Chat -->
        <div id="chat" class="page">
          <div class="chat-container">
            <div class="chat-header">
              <div>
                <h3>ü§ñ BeLive AI Assistant</h3>
                <div>Lead Qualification Chat ‚Ä¢ No Timer (AI Handling)</div>
              </div>
            </div>

            <div class="score-display">
              <h4>ALPS Score</h4>
              <div class="score-bar"><div class="score-fill score-cold" id="chatScoreBar" style="width:0%"></div></div>
              <div id="chatScoreText">0 / 100</div>
              <div id="chatScoreCategory">Getting Started</div>
            </div>

            <div class="chat-messages" id="chatMessages">
              <div class="typing-indicator" id="typingIndicator">
                <div class="typing-dots"><div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div></div>
              </div>
            </div>
          </div>
        </div>

        <!-- SLA -->
        <div id="sla" class="page">
          <div class="sla-container">
            <div class="conversations-list">
              <h3 style="margin-bottom:12px">üí¨ Active Conversations</h3>
              <div style="margin-bottom:10px;font-size:14px;color:#7f8c8d">Click on any conversation to manage</div>

              <div id="convList">
                <!-- Seed items that count down/up in real time -->
                <div class="conversation-item" onclick="openSLAChat('conv1')">
                  <div style="display:flex;justify-content:space-between;align-items:start">
                    <div>
                      <div><strong>Lead #2024001</strong> ‚Ä¢ Sarah Chen</div>
                      <div style="font-size:14px;color:#7f8c8d">Mont Kiara ‚Ä¢ ALPS: 87</div>
                    </div>
                    <div style="text-align:right"><div class="status-indicator" style="font-size:12px;color:#2ecc71">‚úÖ Active</div></div>
                  </div>
                  <div class="sla-timer"><div class="timer-negative">-7:23</div><div style="font-size:12px">Next response due</div></div>
                </div>

                <div class="conversation-item sla-warning" onclick="openSLAChat('conv2')">
                  <div style="display:flex;justify-content:space-between;align-items:start">
                    <div>
                      <div><strong>Lead #2024002</strong> ‚Ä¢ Mike Johnson</div>
                      <div style="font-size:14px;color:#7f8c8d">KL/Selangor ‚Ä¢ ALPS: 82</div>
                    </div>
                    <div style="text-align:right"><div class="status-indicator" style="font-size:12px;color:#f39c12">‚ö†Ô∏è Warning</div></div>
                  </div>
                  <div class="sla-timer"><div class="timer-negative">-2:15</div><div style="font-size:12px">Response overdue</div></div>
                </div>

                <div class="conversation-item sla-breach" onclick="openSLAChat('conv3')">
                  <div style="display:flex;justify-content:space-between;align-items:start">
                    <div>
                      <div><strong>Lead #2024003</strong> ‚Ä¢ Lisa Wong</div>
                      <div style="font-size:14px;color:#7f8c8d">Petaling Jaya ‚Ä¢ ALPS: 65</div>
                    </div>
                    <div style="text-align:right"><div class="status-indicator" style="font-size:12px;color:#e74c3c">üö® Breach</div></div>
                  </div>
                  <div class="sla-timer"><div class="timer-positive">+3:45</div><div style="font-size:12px">SLA breached</div></div>
                </div>

                <div class="conversation-item" onclick="openSLAChat('conv4')">
                  <div style="display:flex;justify-content:space-between;align-items:start">
                    <div>
                      <div><strong>Lead #2024004</strong> ‚Ä¢ In Queue</div>
                      <div style="font-size:14px;color:#7f8c8d">JB/Penang ‚Ä¢ ALPS: 58</div>
                    </div>
                    <div style="text-align:right"><div class="status-indicator" style="font-size:12px;color:#3498db">‚è≥ Waiting</div></div>
                  </div>
                  <div class="sla-timer"><div class="timer-negative">-8:42</div><div style="font-size:12px">Initial assignment</div></div>
                </div>
              </div>

              <div style="margin-top:18px;padding:12px;background:#e8f4fd;border-radius:10px">
                <h4>üìä SLA Statistics</h4>
                <div style="margin-top:8px;font-size:14px">
                  <div>‚úÖ On Time: 2/4 (50%)</div>
                  <div>‚ö†Ô∏è Warning: 1/4 (25%)</div>
                  <div>üö® Breached: 1/4 (25%)</div>
                </div>
              </div>
            </div>

            <div class="sla-chat-area">
              <div class="sla-chat-header">
                <div>
                  <h3 id="slaCurrentChat">Select a conversation</h3>
                  <div id="slaCurrentDetails">Click on a conversation to view details</div>
                </div>
                <div id="slaCurrentTimer" style="background:rgba(255,255,255,.2);padding:10px;border-radius:10px">--:--</div>
              </div>

              <div class="sla-messages" id="slaMessages">
                <div style="text-align:center;color:#7f8c8d;margin-top:40px">
                  <h3>üí¨ SLA Chat Monitor</h3>
                  <p>Select a conversation from the left to view and manage the chat</p>
                </div>
              </div>

              <div class="sla-input" id="slaInputArea" style="display:none">
                <input id="slaMessageInput" type="text" placeholder="Type your message..." onkeypress="handleSLAMessage(event)"/>
                <button onclick="sendSLAMessage()">Send</button>
                <button onclick="escalateConversation()" style="background:#e74c3c">Escalate</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Lead Chart Modal -->
  <div id="chartModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeModal()">&times;</span>
      <h2 id="chartTitle">Lead Score Progression</h2>
      <canvas id="leadChart" width="400" height="200"></canvas>
      <div id="chartDetails" style="margin-top:12px"></div>
    </div>
  </div>

  <!-- SLA Alert -->
  <div id="slaAlert" class="sla-alert">
    <h3>üö® SLA BREACH ALERT</h3>
    <p>Agent has not responded within the SLA timeframe</p>
    <div style="margin:12px 0;padding:12px;background:#fff3cd;border-radius:8px">
      <strong>Conversation:</strong> <span id="alertConversation">-</span><br/>
      <strong>Agent:</strong> <span id="alertAgent">-</span><br/>
      <strong>Time Exceeded:</strong> <span id="alertTime">+0:01</span>
    </div>
    <div class="alert-actions">
      <button class="btn btn-primary" onclick="goToConversation()">Go to Conversation</button>
      <button class="btn btn-danger" onclick="reassignConversation()">Reassign</button>
    </div>
  </div>

  <script>
    'use strict';

    /* =======================
       GLOBAL STATE
    ======================== */
    let currentPage = 'agents';
    let selectedConversation = null;
    let alertConvId = null; // for SLA alert
    let leadChart = null;
    let realTimeInterval;

    // capacities match order of cards (agent1..agent5)
    let agentCapacities = [3,8,5,0,2];

    // SLA legacy timers (seed list)
    let slaTimers = {
      conv1:{negative:443,positive:0,breached:false},
      conv2:{negative:135,positive:0,breached:false},
      conv3:{negative:0,positive:225,breached:true},
      conv4:{negative:522,positive:0,breached:false}
    };

    // Runtime lead/conversation tracking
    let nextLeadId = 2024006;
    let completedLeads = [];
    let activeConversations = {}; // convId -> conversation object
    let agentConversations = {agent1:[],agent2:[],agent3:[],agent4:[],agent5:[]};

    // Chat state
    let chatCurrentStep = 0;
    let chatUserResponses = {};
    let chatAlpsScore = 0;

    const PROPERTIES = [
      "121 Residence","7 Tree Seven","Acacia Residence","Ara Damansara","Ampang","Arte Cheras","Astoria",
      "Austin Regency","Bandar Sri Permaisuri","Bora Residence","Bukit Jalil","Cheras","D'Cosmos","Duta Park",
      "Emporis Kota Damansara","Epic Residence","HighPark Suites","Icon City","Kelana Jaya","Keramat",
      "Kota Damansara","M Vertica","Majestic Maxim","Medini Signature","Meta City","MH Platinum 2","Mont Kiara",
      "One Cochrane","Parc3","Petaling Jaya","Pinnacle","Platinum Splendor","Razak City Residences","Rica Residence",
      "Sentul","Setapak","Subang Jaya","Sunway Avila","Sunway Serene","Trion KL","Vista Sentul","Vivo Residence"
    ];
    const AREAS = ["KL/Selangor","Perak","JB/Penang","Negeri Sembilan","Genting Highlands"];

    const questions = [
      {id:'area',text:"Hi! Welcome to BeLive. I'm here to help you find the perfect room. Choose an area:",type:'select',options:AREAS,weight:15},
      {id:'property',text:"Great choice! Here are the available properties in your selected area:",type:'property_select',weight:10},
      {id:'budget',text:'What\'s your budget range for monthly rent?',type:'input',placeholder:'e.g., 800',weight:25},
      {id:'pax',text:'How many people will be staying?',type:'select',options:['1 person','2 people','More than 2'],weight:10},
      {id:'car',text:'Do you have a car?',type:'select',options:['Yes','No'],weight:5},
      {id:'parking',text:'Do you need a car park lot?',type:'select',options:['Yes','No'],weight:5},
      {id:'movein',text:'When are you planning to move in?',type:'date',weight:20},
      {id:'tenancy',text:'What\'s your preferred tenancy period?',type:'select',options:['6 months','12 months'],weight:5},
      {id:'gender',text:'What\'s your gender?',type:'select',options:['Male','Female'],weight:0},
      {id:'unit_spec',text:'What type of unit do you prefer? (You can select multiple)',type:'multiple',options:['Female unit','Male unit','Mixed Gender unit'],weight:5},
      {id:'workplace',text:'Where is your workplace? This helps us recommend the closest property.',type:'input',placeholder:'e.g., KLCC, Cyberjaya',weight:10},
      {id:'nationality',text:'What\'s your nationality?',type:'select',options:['Malaysian','Others'],weight:0}
    ];

    /* =======================
       INIT
    ======================== */
    document.addEventListener('DOMContentLoaded', initializeDashboard);

    function initializeDashboard(){
      // Sidebar routing
      document.querySelectorAll('.nav-item').forEach(item=>{
        item.addEventListener('click',()=>switchPage(item.dataset.page));
      });

      // Agent card click -> agent conversations
      document.querySelectorAll('.agent-card').forEach(card=>{
        card.addEventListener('click',()=>{
          const agentId = card.getAttribute('data-agent');
          goToAgentConversations(agentId);
        });
      });

      initializeDragAndDrop();
      startRealTimeUpdates();
    }

    /* =======================
       PAGE ROUTER
    ======================== */
    function switchPage(pageName){
      document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
      document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
      document.getElementById(pageName).classList.add('active');
      document.querySelector(`.nav-item[data-page="${pageName}"]`).classList.add('active');
      currentPage = pageName;
      updatePageHeader(pageName);
      if(pageName==='chat'){ setTimeout(initializeChat,300); }
    }
    function updatePageHeader(page){
      const t={agents:'Agent Status Dashboard',leads:'Lead Management',chat:'AI Chat Interface',sla:'SLA Monitoring'};
      const s={agents:'Real-time agent monitoring and queue management',leads:'Lead scoring and progression tracking',chat:'AI-powered lead qualification system',sla:'Response time monitoring and escalation'};
      document.getElementById('pageTitle').textContent=t[page];
      document.getElementById('pageSubtitle').textContent=s[page];
    }

    /* =======================
       REAL-TIME LOOP
    ======================== */
    function startRealTimeUpdates(){
      if(realTimeInterval) clearInterval(realTimeInterval);
      realTimeInterval = setInterval(()=>{
        document.getElementById('lastUpdate').textContent=new Date().toLocaleTimeString();
        updateAgentStats();
        updateSLATimers();
        // keep alert timer running
        updateAlertTimerDisplay();
      },1000);
    }

    function updateAgentStats(){
      const cards = document.querySelectorAll('.agent-card');
      cards.forEach((card,idx)=>{
        if(Math.random()<0.05){
          const delta = Math.random()<0.5?-1:1;
          agentCapacities[idx] = Math.max(0,Math.min(10,agentCapacities[idx]+delta));
        }
        const fill = card.querySelector('.capacity-fill');
        const text = card.querySelector('.capacity-text');
        const pct = agentCapacities[idx]/10*100;
        fill.style.width = pct+'%';
        fill.className = 'capacity-fill ' + (pct<=30?'capacity-low':pct<=70?'capacity-medium':'capacity-high');
        text.textContent = `Capacity: ${agentCapacities[idx]}/10 chats`;
      });
    }

    /* =======================
       SLA TIMERS
    ======================== */
    function updateSLATimers(){
      // Active conversations (created from chat)
      Object.values(activeConversations).forEach(conv=>{
        const t = conv.slaTimer;
        if(!t) return;

        if(t.timeRemaining>0){
          t.timeRemaining--;
          if(t.timeRemaining<=0){
            if(t.type==='initial'){ reassignToNextAgent(conv); }
            else{
              t.alertTriggered=true; t.overdue=1;
              triggerSLAAlert(conv.id);
            }
          }
        }else if(t.overdue>0 || t.alertTriggered){
          t.overdue++;
        }
        updateConversationUI(conv);
      });

      // Legacy seeded items
      Object.keys(slaTimers).forEach(id=>{
        const t = slaTimers[id];
        const el = document.querySelector(`[onclick="openSLAChat('${id}')"]`);
        if(!t || !el) return;

        const timerEl = el.querySelector('.timer-negative, .timer-positive');
        if(!t.breached){
          t.negative--;
          if(t.negative<=0){ t.breached=true; t.positive=Math.abs(t.negative); t.negative=0; triggerSLAAlert(id); }
          const m = Math.floor(t.negative/60), s = (t.negative%60).toString().padStart(2,'0');
          timerEl.textContent = `-${m}:${s}`;
          timerEl.className='timer-negative';
          el.className = 'conversation-item' + (t.negative<=120?' sla-warning':'');

          // if header is on this conv, update it
          if(selectedConversation===id){ document.getElementById('slaCurrentTimer').textContent=`-${m}:${s}`; document.getElementById('slaCurrentTimer').style.background='rgba(46,204,113,.2)'; }
        }else{
          t.positive++;
          const m = Math.floor(t.positive/60), s = (t.positive%60).toString().padStart(2,'0');
          timerEl.textContent = `+${m}:${s}`;
          timerEl.className='timer-positive';
          el.className='conversation-item sla-breach';
          if(selectedConversation===id){ document.getElementById('slaCurrentTimer').textContent=`+${m}:${s}`; document.getElementById('slaCurrentTimer').style.background='rgba(231,76,60,.2)'; }
        }
      });

      // keep header timer live for selected ACTIVE conversation
      if(selectedConversation && activeConversations[selectedConversation]){
        const info = getConversationTimer(activeConversations[selectedConversation]);
        const tEl = document.getElementById('slaCurrentTimer');
        tEl.textContent = info.text;
        tEl.style.background = info.class==='timer-positive'?'rgba(231,76,60,.2)':'rgba(46,204,113,.2)';
      }
    }

    function updateConversationUI(conv){
      const el = document.querySelector(`[onclick="openSLAChat('${conv.id}')"]`);
      if(!el) return;
      const timerInfo = getConversationTimer(conv);
      const statusInfo = getConversationStatus(conv);
      const timerEl = el.querySelector('.timer-negative, .timer-positive');
      const statusEl = el.querySelector('.status-indicator');

      timerEl.textContent = timerInfo.text;
      timerEl.className = timerInfo.class;
      statusEl.textContent = statusInfo.status;
      statusEl.style.color = statusInfo.color;
      el.className = getConversationClass(conv);
    }

    function triggerSLAAlert(convId){
      alertConvId = convId;
      const active = activeConversations[convId];
      if(active){
        document.getElementById('alertConversation').textContent = `Lead ${active.leadNumber}`;
        document.getElementById('alertAgent').textContent = active.agentName;
      }else{
        const map={conv1:['Lead #2024001','Sarah Chen'],conv2:['Lead #2024002','Mike Johnson'],conv3:['Lead #2024003','Lisa Wong'],conv4:['Lead #2024004','In Queue']};
        const d = map[convId]; if(d){document.getElementById('alertConversation').textContent=d[0];document.getElementById('alertAgent').textContent=d[1];}
      }
      document.getElementById('slaAlert').style.display = 'block';
      updateAlertTimerDisplay(); // start with a fresh value
    }

    function updateAlertTimerDisplay(){
      if(!alertConvId) return;
      const active = activeConversations[alertConvId];
      let txt = '+0:01';
      if(active){
        const over = Math.max(1, active.slaTimer.overdue||0);
        const m = Math.floor(over/60), s = (over%60).toString().padStart(2,'0'); txt = `+${m}:${s}`;
      }else if(slaTimers[alertConvId]){
        const over = Math.max(1, slaTimers[alertConvId].breached ? slaTimers[alertConvId].positive : 0);
        const m = Math.floor(over/60), s = (over%60).toString().padStart(2,'0'); txt = `+${m}:${s}`;
      }
      document.getElementById('alertTime').textContent = txt;
    }

    function goToConversation(){
      if(!alertConvId) return;
      document.getElementById('slaAlert').style.display='none';
      switchPage('sla');
      setTimeout(()=>openSLAChat(alertConvId),300);
      alertConvId = null;
    }

    function reassignConversation(){
      if(!alertConvId) return;
      const active = activeConversations[alertConvId];
      if(active){ reassignToNextAgent(active); }
      else if(slaTimers[alertConvId]){ slaTimers[alertConvId] = {negative:600,positive:0,breached:false}; }
      document.getElementById('slaAlert').style.display='none';
      alertConvId = null;
    }

    /* =======================
       ROUTING / AGENTS
    ======================== */
    function findBestAgent(){
      for(let i=1;i<=5;i++){
        const id = `agent${i}`;
        const idx = i-1;
        const card = document.querySelector(`[data-agent="${id}"]`);
        const available = card && card.classList.contains('available');
        if(available && agentCapacities[idx] < 10){ return {id, name:card.querySelector('.agent-name').textContent.replace('üëë ','')}; }
      }
      return null;
    }
    function findNextAgent(currentId){
      const ids=['agent1','agent2','agent3','agent4','agent5'];
      const start = ids.indexOf(currentId);
      const rotated = [...ids.slice(start+1),...ids.slice(0,start)];
      for(const id of rotated){
        const idx = Number(id.replace('agent',''))-1;
        const card = document.querySelector(`[data-agent="${id}"]`);
        const available = card && card.classList.contains('available');
        if(available && agentCapacities[idx] < 10){ return {id,name:card.querySelector('.agent-name').textContent.replace('üëë ','')}; }
      }
      return null;
    }

    function reassignToNextAgent(conv){
      const next = findNextAgent(conv.agentId);
      if(next){
        const arr = agentConversations[conv.agentId];
        const ix = arr.findIndex(c=>c.id===conv.id);
        if(ix>-1) arr.splice(ix,1);
        agentCapacities[Number(conv.agentId.replace('agent',''))-1]--;

        conv.agentId = next.id;
        conv.agentName = next.name;
        conv.assignedTime = new Date();
        conv.status = 'waiting_agent_response';
        conv.slaTimer = {type:'initial',timeRemaining:300,alertTriggered:false,overdue:0};
        agentConversations[next.id].push(conv);
        agentCapacities[Number(next.id.replace('agent',''))-1]++;

        conv.messages.push({type:'system',text:`Conversation reassigned to ${next.name} due to initial response timeout.`,time:new Date().toLocaleTimeString()});
        updateLeadAgent(conv.leadId,next.name);
        showNotification(`Lead ${conv.leadNumber} reassigned to ${next.name}`,'warning');
      }else{
        conv.status='unassigned';
        conv.slaTimer.overdue++;
        showNotification(`No agent available for Lead ${conv.leadNumber}`,'error');
      }
    }

    function updateLeadAgent(leadId, name){
      const el = document.querySelector(`[data-lead="${leadId}"]`);
      if(!el) return;
      const details = el.querySelector('.lead-details');
      details.innerHTML = details.innerHTML.replace(/Agent: [^<]*/,'Agent: '+name);
    }

    function showNotification(msg,type='info'){
      const n = document.createElement('div');
      n.style.cssText = "position:fixed;top:20px;right:20px;padding:14px 18px;border-radius:8px;color:#fff;font-weight:700;z-index:1200;max-width:320px;box-shadow:0 8px 18px rgba(0,0,0,.2)";
      n.style.background = type==='success'?'#2ecc71':type==='warning'?'#f39c12':type==='error'?'#e74c3c':'#3498db';
      n.textContent = msg;
      document.body.appendChild(n);
      setTimeout(()=>n.remove(),4500);
    }

    /* =======================
       LEADS (UI helpers)
    ======================== */
    function addToOngoingLeads(lead){
      const cont = document.getElementById('ongoingLeads');
      const cls = lead.score>=70?'hot':lead.score>=40?'warm':'cold';
      const scoreCls = lead.score>=70?'score-hot':lead.score>=40?'score-warm':'score-cold';
      const agentText = lead.agent ? lead.agent : (lead.status==='in_queue'?'In Queue':'AI Bot');
      const statusText = lead.status==='assigned'?'Assigned':(lead.status==='in_queue'?'Queued':'AI Handling');
      const el = document.createElement('div');
      el.className = `lead-item ${cls}`;
      el.setAttribute('data-lead',lead.id);
      el.onclick = ()=>showLeadChart(lead.id);
      el.innerHTML = `
        <div class="lead-score ${scoreCls}">${lead.score}</div>
        <div class="lead-info">
          <div class="lead-name">${lead.score>=70?'üî•':''} Lead ${lead.leadNumber}</div>
          <div class="lead-details">Area: ${lead.area} ‚Ä¢ Budget: RM${lead.budget}<br/>Move-in: ${lead.movein} ‚Ä¢ Agent: ${agentText}</div>
          <div class="lead-timestamp">Started: ${new Date(lead.timestamp).toLocaleTimeString()} ‚Ä¢ Status: ${statusText}</div>
        </div>`;
      cont.prepend(el);
      completedLeads.push(lead);
    }

    function addToSLAMonitoring(conversation){
      const list = document.getElementById('convList');
      const div = document.createElement('div');
      div.className = 'conversation-item';
      div.setAttribute('onclick',`openSLAChat('${conversation.id}')`);
      div.innerHTML = `
        <div style="display:flex;justify-content:space-between;align-items:start">
          <div>
            <div><strong>Lead ${conversation.leadNumber}</strong> ‚Ä¢ ${conversation.agentName}</div>
            <div style="font-size:14px;color:#7f8c8d">${conversation.area} ‚Ä¢ ALPS: ${conversation.score}</div>
          </div>
          <div style="text-align:right"><div class="status-indicator" style="font-size:12px;color:#f39c12">‚è≥ Waiting</div></div>
        </div>
        <div class="sla-timer">
          <div class="timer-negative">-5:00</div>
          <div style="font-size:12px">Initial response due</div>
        </div>`;
      list.prepend(div);
    }

    /* =======================
       LEAD CHART
    ======================== */
    function showLeadChart(leadId){
      const data = getLeadData(leadId);
      document.getElementById('chartTitle').textContent = `${data.name} - Score Progression`;
      const modal = document.getElementById('chartModal');
      modal.style.display='block';
      setTimeout(()=>{
        createLeadChart(data);
        updateChartDetails(data);
      },80);
    }
    function getLeadData(leadId){
      const c = completedLeads.find(l=>l.id===leadId);
      if(c){
        const scores=[0]; let cur=0;
        questions.forEach(q=>{
          const r = c.responses[q.id]; if(!r) return;
          let inc=0;
          if(q.id==='area'||q.id==='property') inc=q.weight;
          else if(q.id==='budget'){ const b=parseInt(r); inc=b>=800?q.weight:b>=600?q.weight*.7:b>=400?q.weight*.4:q.weight*.1; }
          else if(q.id==='movein'){ const d=new Date(r), t=new Date(), diff=Math.ceil((d-t)/(1000*60*60*24)); inc=diff<=7?q.weight:diff<=30?q.weight*.8:diff<=60?q.weight*.6:q.weight*.3; }
          else inc=q.weight*.8;
          cur+=inc; scores.push(Math.round(cur));
        });
        return {name:`Lead ${c.leadNumber}`,scores, messages:['Initial','Area','Property','Budget','Pax','Car','Move-in','Tenancy','Gender','Final'], details:`${c.area} ‚Ä¢ Budget: RM${c.budget} ‚Ä¢ Move-in: ${c.movein} ‚Ä¢ Status: ${c.status}`};
      }
      return {name:'Lead #2024001',scores:[0,15,25,40,55,67,72,78,82,87],messages:['Initial','Area','Property','Budget','Pax','Car','Move-in','Tenancy','Gender','Final'],details:'Sample'};
    }
    function createLeadChart(d){
      const ctx = document.getElementById('leadChart').getContext('2d');
      if(leadChart) leadChart.destroy();
      leadChart = new Chart(ctx,{
        type:'line',
        data:{labels:d.messages,datasets:[{label:'ALPS Score',data:d.scores,borderColor:'#3498db',backgroundColor:'rgba(52,152,219,.1)',borderWidth:3,fill:true,tension:.4,pointBackgroundColor:'#3498db',pointBorderColor:'#fff',pointBorderWidth:2,pointRadius:5}]},
        options:{responsive:true,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true,max:100},x:{}}}
      });
    }
    function updateChartDetails(d){
      const final = d.scores[d.scores.length-1];
      let cat='Cold Lead', color='#95a5a6';
      if(final>=70){cat='Hot Lead';color='#e74c3c';} else if(final>=40){cat='Warm Lead';color='#f39c12';}
      document.getElementById('chartDetails').innerHTML = `
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:14px">
          <div style="background:#f8f9fa;padding:12px;border-radius:10px">
            <h4>Final Score</h4><div style="font-size:22px;font-weight:800;color:${color}">${final}/100</div><div style="color:${color};font-weight:700">${cat}</div>
          </div>
          <div style="background:#f8f9fa;padding:12px;border-radius:10px">
            <h4>Score Range</h4>
            <div>Min: ${Math.min(...d.scores)}</div>
            <div>Max: ${Math.max(...d.scores)}</div>
            <div>Growth: +${final-d.scores[0]}</div>
          </div>
          <div style="background:#f8f9fa;padding:12px;border-radius:10px">
            <h4>Details</h4><div style="font-size:14px">${d.details}</div>
          </div>
        </div>`;
    }
    function closeModal(){ document.getElementById('chartModal').style.display='none'; if(leadChart){leadChart.destroy();leadChart=null;} }

    /* =======================
       SLA CHAT VIEW
    ======================== */
    function openSLAChat(convId){
      selectedConversation = convId;
      const conv = activeConversations[convId];
      if(conv) return loadActiveConversation(conv);

      // Legacy seeded demos
      const legacy={
        conv1:{title:'Lead #2024001 - Sarah Chen',details:'Mont Kiara ‚Ä¢ ALPS: 87 ‚Ä¢ Active for 12 mins',messages:[
          {type:'customer',text:'Hi, I\'m looking for a room in Mont Kiara area',time:'14:32'},
          {type:'agent',text:'Hello! Happy to help. What\'s your budget?',time:'14:33'},
          {type:'customer',text:'Around RM1200. Need to move in within 3 days.',time:'14:34'},
          {type:'agent',text:'Great! I have several options. Sharing now‚Ä¶',time:'14:35'}
        ]},
        conv2:{title:'Lead #2024002 - Mike Johnson',details:'KL/Selangor ‚Ä¢ ALPS: 82 ‚Ä¢ Response overdue',messages:[
          {type:'customer',text:'Hello, I saw your KL listing.',time:'14:45'},
          {type:'agent',text:'Hi! Which area in KL?',time:'14:46'},
          {type:'customer',text:'Near public transport. Budget ~RM900',time:'14:47'}
        ]},
        conv3:{title:'Lead #2024003 - Lisa Wong',details:'Petaling Jaya ‚Ä¢ ALPS: 65 ‚Ä¢ SLA Breached',messages:[
          {type:'customer',text:'Hi, looking for accommodation in PJ',time:'14:52'},
          {type:'agent',text:'Sure! What type are you after?',time:'14:53'},
          {type:'customer',text:'Single room, RM750. When can I view?',time:'14:54'}
        ]},
        conv4:{title:'Lead #2024004 - In Queue',details:'JB/Penang ‚Ä¢ ALPS: 58 ‚Ä¢ Initial assignment',messages:[
          {type:'customer',text:'Hello, any room available next month?',time:'10:20'}
        ]}
      };
      const l = legacy[convId];
      if(!l) return;

      document.getElementById('slaCurrentChat').textContent=l.title;
      document.getElementById('slaCurrentDetails').textContent=l.details;

      const t = slaTimers[convId];
      const timerEl = document.getElementById('slaCurrentTimer');
      if(t && !t.breached){ const m=Math.floor(t.negative/60),s=(t.negative%60).toString().padStart(2,'0'); timerEl.textContent=`-${m}:${s}`; timerEl.style.background='rgba(46,204,113,.2)'; }
      else if(t){ const m=Math.floor(t.positive/60),s=(t.positive%60).toString().padStart(2,'0'); timerEl.textContent=`+${m}:${s}`; timerEl.style.background='rgba(231,76,60,.2)'; }

      const box = document.getElementById('slaMessages');
      box.innerHTML='';
      l.messages.forEach(m=>{
        const d=document.createElement('div');
        d.className='message ' + (m.type==='customer'?'message-user':'message-bot');
        d.innerHTML=`<div>${m.text}</div><div style="font-size:12px;color:#7f8c8d;margin-top:5px">${m.time}</div>`;
        box.appendChild(d);
      });
      box.scrollTop=box.scrollHeight;
      document.getElementById('slaInputArea').style.display='flex';
    }

    function loadActiveConversation(conv){
      document.getElementById('slaCurrentChat').textContent = `Lead ${conv.leadNumber} - ${conv.agentName}`;
      document.getElementById('slaCurrentDetails').textContent = `${conv.area} ‚Ä¢ ALPS: ${conv.score} ‚Ä¢ ${getStatusText(conv.status)}`;

      const info = getConversationTimer(conv);
      const tEl = document.getElementById('slaCurrentTimer');
      tEl.textContent = info.text;
      tEl.style.background = info.class==='timer-positive'?'rgba(231,76,60,.2)':'rgba(46,204,113,.2)';

      const box = document.getElementById('slaMessages');
      box.innerHTML='';
      conv.messages.forEach(m=>{
        const div=document.createElement('div');
        const cls = m.type==='customer' ? 'message-user' : (m.type==='system'?'message-system':'message-bot');
        div.className='message '+cls;
        div.innerHTML=`<div>${m.text}</div><div style="font-size:12px;color:#7f8c8d;margin-top:5px">${m.time}</div>`;
        box.appendChild(div);
      });
      box.scrollTop=box.scrollHeight;
      document.getElementById('slaInputArea').style.display='flex';
    }

    function handleSLAMessage(e){ if(e.key==='Enter') sendSLAMessage(); }

    function sendSLAMessage(){
      const input = document.getElementById('slaMessageInput');
      const text = input.value.trim(); if(!text) return;
      input.value='';

      const box = document.getElementById('slaMessages');
      const d=document.createElement('div');
      d.className='message message-bot';
      d.innerHTML=`<div>${text}</div><div style="font-size:12px;color:#7f8c8d;margin-top:5px">${new Date().toLocaleTimeString()}</div>`;
      box.appendChild(d); box.scrollTop=box.scrollHeight;

      const conv = activeConversations[selectedConversation];
      if(conv){
        conv.messages.push({type:'agent',text,time:new Date().toLocaleTimeString()});
        if(conv.status==='waiting_agent_response'){
          conv.status='ongoing';
          conv.slaTimer={type:'ongoing',timeRemaining:600,alertTriggered:false,overdue:0};
        }else{
          conv.slaTimer.timeRemaining=600; conv.slaTimer.alertTriggered=false; conv.slaTimer.overdue=0;
        }
        setTimeout(()=>{
          const replies=["Thanks! That helps.","Great, what are next steps?","I'm interested to view.","Sounds good!","üëç"];
          const r=replies[Math.floor(Math.random()*replies.length)];
          const u=document.createElement('div');
          u.className='message message-user';
          u.innerHTML=`<div>${r}</div><div style="font-size:12px;color:#7f8c8d;margin-top:5px">${new Date().toLocaleTimeString()}</div>`;
          box.appendChild(u); box.scrollTop=box.scrollHeight;
          conv.messages.push({type:'customer',text:r,time:new Date().toLocaleTimeString()});
          conv.slaTimer.timeRemaining=600;
        },2500);
      }else{
        if(selectedConversation && slaTimers[selectedConversation]){
          slaTimers[selectedConversation].negative=1200;
          slaTimers[selectedConversation].positive=0;
          slaTimers[selectedConversation].breached=false;
        }
      }
    }

    function escalateConversation(){
      if(!selectedConversation) return;
      const box=document.getElementById('slaMessages');
      const div=document.createElement('div');
      div.className='message message-system';
      div.innerHTML=`<div><strong>Conversation Escalated</strong></div><div>Supervisor will take over.</div><div style="font-size:12px;color:#7f8c8d;margin-top:5px">${new Date().toLocaleTimeString()}</div>`;
      box.appendChild(div); box.scrollTop=box.scrollHeight;
      setTimeout(()=>alert('Escalated. Supervisor will take over within 2 minutes.'),600);
    }

    function getConversationClass(conv){
      if(!conv.slaTimer) return 'conversation-item';
      if(conv.slaTimer.type==='initial' && conv.slaTimer.timeRemaining<=60) return 'conversation-item sla-warning';
      if(conv.slaTimer.overdue>0) return 'conversation-item sla-breach';
      return 'conversation-item';
    }
    function getConversationStatus(conv){
      if(!conv.slaTimer) return {status:'‚úÖ Active',color:'#2ecc71'};
      if(conv.status==='waiting_agent_response') return {status:'‚è≥ Waiting',color:'#f39c12'};
      if(conv.slaTimer.overdue>0) return {status:'üö® Breach',color:'#e74c3c'};
      if(conv.slaTimer.alertTriggered) return {status:'‚ö†Ô∏è Alert',color:'#f39c12'};
      return {status:'‚úÖ Active',color:'#2ecc71'};
    }
    function getConversationTimer(conv){
      if(!conv.slaTimer) return {text:'--:--',class:'timer-negative',description:'No timer'};
      const t=conv.slaTimer;
      if(t.overdue>0){
        const m=Math.floor(t.overdue/60),s=(t.overdue%60).toString().padStart(2,'0');
        return {text:`+${m}:${s}`,class:'timer-positive',description:t.type==='initial'?'Initial response overdue':'Response overdue'};
      }
      if(t.timeRemaining>0){
        const m=Math.floor(t.timeRemaining/60),s=(t.timeRemaining%60).toString().padStart(2,'0');
        return {text:`-${m}:${s}`,class:'timer-negative',description:t.type==='initial'?'Initial response due':'Next response due'};
      }
      return {text:'0:00',class:'timer-negative',description:'Timer expired'};
    }
    function getStatusText(s){
      return s==='waiting_agent_response'?'Waiting for agent response':
             s==='ongoing'?'Ongoing conversation':
             s==='assigned'?'Assigned to agent':
             s==='in_queue'?'In queue':
             s==='unassigned'?'Unassigned':'Active';
    }

    /* =======================
       CHAT AI (ALPS)
    ======================== */
    function initializeChat(){
      chatCurrentStep=0; chatUserResponses={}; chatAlpsScore=0;
      const box=document.getElementById('chatMessages');
      box.innerHTML = `<div class="typing-indicator" id="typingIndicator"><div class="typing-dots"><div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div></div></div>`;
      updateChatScoreDisplay();
      setTimeout(()=>askQuestion(0),600);
    }
    function askQuestion(i){
      if(i>=questions.length){ return finalizeLead(); }
      const q=questions[i]; chatCurrentStep=i; showTyping();
      setTimeout(()=>{
        hideTyping();
        let html=`<div>${q.text}</div>`;
        if(q.type==='select'){
          html+=`<div class="options-container">`+
            q.options.map(o=>`<div class="option-button" onclick="selectOption('${q.id}','${o.replace(/'/g,"\\'")}')">${o}</div>`).join('')+
            `</div>`;
        }else if(q.type==='property_select'){
          const props=getPropertiesForArea(chatUserResponses.area||'KL/Selangor').slice(0,12);
          html+=`<div class="property-grid">`+
            props.map(p=>`<div class="property-item" onclick="selectOption('${q.id}','${p.replace(/'/g,"\\'")}')">${p}</div>`).join('')+
            `</div>`;
        }else if(q.type==='input'){
          html+=`<input class="input-field" type="text" placeholder="${q.placeholder}" onkeypress="handleInputKeypress(event,'${q.id}')">`;
        }else if(q.type==='date'){
          html+=`<input class="input-field" type="date" onchange="handleDateChange(event,'${q.id}')">`;
        }else if(q.type==='multiple'){
          html+=createMultipleChoiceOptions(q.id,q.options);
        }
        addMessage(html,'bot');
      },900);
    }
    function createMultipleChoiceOptions(id,opts){
      let c=`<div class="checkbox-group" id="checkboxGroup_${id}">`;
      opts.forEach((o,idx)=>{
        const oid=`${id}_${idx}`;
        c+=`<div class="checkbox-item" data-option-id="${oid}" onclick="toggleMultipleChoice('${oid}','${id}')"><input type="checkbox" id="${oid}" value="${o}"><label for="${oid}">${o}</label></div>`;
      });
      c+=`<button class="continue-btn" onclick="submitMultipleChoice('${id}')">Continue</button></div>`;
      return c;
    }
    function toggleMultipleChoice(oid,id){
      const cb=document.getElementById(oid);
      const item=document.querySelector(`[data-option-id="${oid}"]`);
      cb.checked=!cb.checked;
      item.classList.toggle('selected',cb.checked);
    }
    function submitMultipleChoice(id){
      const vals=[...document.querySelectorAll(`#checkboxGroup_${id} input[type="checkbox"]:checked`)].map(cb=>cb.value);
      if(!vals.length) return alert('Please select at least one option');
      chatUserResponses[id]=vals; addMessage(vals.join(', '),'user');
      const q=questions.find(q=>q.id===id); calculateAlpsScore(id,vals,q.weight); setTimeout(()=>askQuestion(chatCurrentStep+1),600);
    }
    function addMessage(html,who){ const box=document.getElementById('chatMessages'); const d=document.createElement('div'); d.className='message message-'+who; d.innerHTML=html; box.appendChild(d); box.scrollTop=box.scrollHeight; }
    function showTyping(){ const el=document.getElementById('typingIndicator'); if(el){el.style.display='block'; document.getElementById('chatMessages').scrollTop=document.getElementById('chatMessages').scrollHeight;}}
    function hideTyping(){ const el=document.getElementById('typingIndicator'); if(el) el.style.display='none'; }
    function selectOption(id,val){ chatUserResponses[id]=val; addMessage(val,'user'); const q=questions.find(q=>q.id===id); calculateAlpsScore(id,val,q.weight); setTimeout(()=>askQuestion(chatCurrentStep+1),500); }
    function handleInputKeypress(e,id){ if(e.key==='Enter'){ const v=e.target.value.trim(); if(v) selectOption(id,v); } }
    function handleDateChange(e,id){ const v=e.target.value; if(v) selectOption(id,v); }
    function calculateAlpsScore(id,val,weight){
      let inc=0;
      if(id==='area'||id==='property'){ inc=weight; }
      else if(id==='budget'){ const b=parseInt(val); inc=b>=800?weight:b>=600?weight*.7:b>=400?weight*.4:weight*.1; }
      else if(id==='movein'){ const d=new Date(val), t=new Date(), diff=Math.ceil((d-t)/(1000*60*60*24)); inc=diff<=7?weight:diff<=30?weight*.8:diff<=60?weight*.6:weight*.3; }
      else inc=weight*.8;
      chatAlpsScore=Math.min(100,chatAlpsScore+inc);
      updateChatScoreDisplay();
    }
    function updateChatScoreDisplay(){
      const bar=document.getElementById('chatScoreBar');
      const text=document.getElementById('chatScoreText');
      const cat=document.getElementById('chatScoreCategory');
      const pct=Math.min(chatAlpsScore,100);
      bar.style.width=pct+'%';
      bar.className='score-fill '+(chatAlpsScore>=70?'score-hot':chatAlpsScore>=40?'score-warm':'score-cold');
      text.textContent=`${Math.round(chatAlpsScore)} / 100`;
      cat.textContent = chatAlpsScore>=70?'Hot Lead üî•':chatAlpsScore>=40?'Warm Lead ‚≠ê':'Cold Lead ‚ùÑÔ∏è';
    }
    function getPropertiesForArea(area){ return PROPERTIES; }

    function finalizeLead(){
      showTyping();
      setTimeout(()=>{
        hideTyping();
        const newLead = {
          id:`lead${nextLeadId}`,
          leadNumber:`#${nextLeadId}`,
          score:Math.round(chatAlpsScore),
          area:chatUserResponses.area||'KL/Selangor',
          budget:chatUserResponses.budget||'Not specified',
          movein:chatUserResponses.movein||'Not specified',
          property:chatUserResponses.property||'Not specified',
          responses:{...chatUserResponses},
          timestamp:new Date(),
          status:'pending_assignment'
        };

        if(chatAlpsScore>=60){
          addMessage(`
            <div style="background:#e8f5e8;padding:12px;border-radius:12px;border-left:4px solid #2ecc71">
              <h3>High Priority Lead Detected!</h3>
              <p><strong>Your ALPS Score: ${Math.round(chatAlpsScore)}/100</strong></p>
              <p>This lead will be routed to our top sales agent for immediate attention.</p>
              <p>Routing to agent now...</p>
            </div>`,'bot');
          setTimeout(()=>routeLeadToAgent(newLead),1200);
        }else{
          addMessage(`
            <div style="background:#fff8e1;padding:12px;border-radius:12px;border-left:4px solid #f39c12">
              <h3>Lead Information Collected</h3>
              <p><strong>ALPS Score: ${Math.round(chatAlpsScore)}/100</strong></p>
              <p>Our AI will continue to assist you.</p>
            </div>`,'bot');
          addToOngoingLeads(newLead);
        }
        nextLeadId++;
      },600);
    }

    function routeLeadToAgent(lead){
      const best = findBestAgent();
      if(best){
        lead.agent = best.name; lead.agentId = best.id; lead.status='assigned';

        const convId = `conv_${lead.id}`;
        const conv = {
          id:convId, leadId:lead.id, leadNumber:lead.leadNumber,
          agentId:best.id, agentName:best.name,
          score:lead.score, area:lead.area, budget:lead.budget,
          status:'waiting_agent_response',
          assignedTime:new Date(),
          messages:[{type:'system',text:`Lead ${lead.leadNumber} has been assigned to you. Area: ${lead.area}, Budget: ${lead.budget}, Move-in: ${lead.movein}`,time:new Date().toLocaleTimeString()}],
          slaTimer:{type:'initial',timeRemaining:300,alertTriggered:false,overdue:0}
        };

        agentConversations[best.id].push(conv);
        activeConversations[convId]=conv;
        agentCapacities[Number(best.id.replace('agent',''))-1]++;

        addToOngoingLeads(lead);
        addToSLAMonitoring(conv);

        setTimeout(()=>addMessage(`
          <div style="background:#e3f2fd;padding:12px;border-radius:12px;border-left:4px solid #2196f3">
            <h3>Lead Successfully Routed!</h3>
            <p><strong>Assigned to:</strong> ${best.name}</p>
            <p><strong>Lead ID:</strong> ${lead.leadNumber}</p>
            <p>Our agent will contact you shortly!</p>
          </div>`,'bot'),600);
      }else{
        lead.status='in_queue'; addToOngoingLeads(lead);
        addMessage(`
          <div style="background:#fff3e0;padding:12px;border-radius:12px;border-left:4px solid #ff9800">
            <h3>Added to Priority Queue</h3>
            <p>All agents are currently busy. You've been added to our priority queue.</p>
            <p>Estimated wait time: 3‚Äì5 minutes</p>
          </div>`,'bot');
      }
    }

    /* =======================
       AGENT LIST NAV
    ======================== */
    function goToAgentConversations(agentId){
      switchPage('sla');
      setTimeout(()=>showAgentConversationsList(agentId),250);
    }
    function showAgentConversationsList(agentId){
      const names={agent1:'Sarah Chen',agent2:'Mike Johnson',agent3:'Lisa Wong',agent4:'David Lim',agent5:'Jennifer Tan'};
      const list=document.querySelector('.conversations-list');
      const convs=agentConversations[agentId]||[];
      list.innerHTML = `
        <h3 style="margin-bottom:12px">üí¨ ${names[agentId]}'s Conversations</h3>
        <div style="margin-bottom:10px;font-size:14px;color:#7f8c8d">Active: ${convs.length} conversations</div>
        <button onclick="showAllConversations()" class="btn btn-primary" style="margin-bottom:10px">‚Üê Back to All Conversations</button>
        <div id="convList"></div>
      `;
      const container = list.querySelector('#convList');
      if(!convs.length){
        container.innerHTML = `<div style="text-align:center;color:#7f8c8d;margin-top:40px"><p>No active conversations</p></div>`;
        return;
      }
      convs.forEach(c=>{
        const el=document.createElement('div');
        el.className=getConversationClass(c);
        el.setAttribute('onclick',`openSLAChat('${c.id}')`);
        const s=getConversationStatus(c), t=getConversationTimer(c);
        el.innerHTML=`
          <div style="display:flex;justify-content:space-between;align-items:start">
            <div><div><strong>Lead ${c.leadNumber}</strong> ‚Ä¢ ${c.agentName}</div><div style="font-size:14px;color:#7f8c8d">${c.area} ‚Ä¢ ALPS: ${c.score}</div></div>
            <div style="text-align:right"><div class="status-indicator" style="font-size:12px">${s.status}</div></div>
          </div>
          <div class="sla-timer"><div class="${t.class}">${t.text}</div><div style="font-size:12px">${t.description}</div></div>`;
        container.appendChild(el);
      });
    }
    function showAllConversations(){
      const list=document.querySelector('.conversations-list');
      list.innerHTML = `
        <h3 style="margin-bottom:12px">üí¨ Active Conversations</h3>
        <div style="margin-bottom:10px;font-size:14px;color:#7f8c8d">Click on any conversation to manage</div>
        <div id="convList"></div>
      `;
      const container=list.querySelector('#convList');
      Object.values(activeConversations).forEach(c=>{
        const el=document.createElement('div');
        el.className=getConversationClass(c);
        el.setAttribute('onclick',`openSLAChat('${c.id}')`);
        const s=getConversationStatus(c), t=getConversationTimer(c);
        el.innerHTML=`
          <div style="display:flex;justify-content:space-between;align-items:start">
            <div><div><strong>Lead ${c.leadNumber}</strong> ‚Ä¢ ${c.agentName}</div><div style="font-size:14px;color:#7f8c8d">${c.area} ‚Ä¢ ALPS: ${c.score}</div></div>
            <div style="text-align:right"><div class="status-indicator" style="font-size:12px">${s.status}</div></div>
          </div>
          <div class="sla-timer"><div class="${t.class}">${t.text}</div><div style="font-size:12px">${t.description}</div></div>`;
        container.appendChild(el);
      });

      ['conv1','conv2','conv3','conv4'].forEach(id=>{
        const meta={conv1:['Lead #2024001 ‚Ä¢ Sarah Chen','Mont Kiara',87,'Active'],conv2:['Lead #2024002 ‚Ä¢ Mike Johnson','KL/Selangor',82,'Warning'],conv3:['Lead #2024003 ‚Ä¢ Lisa Wong','Petaling Jaya',65,'Breach'],conv4:['Lead #2024004 ‚Ä¢ In Queue','JB/Penang',58,'Waiting']};
        const m=meta[id];
        const el=document.createElement('div');
        el.className = 'conversation-item ' + (m[3]==='Warning'?'sla-warning':m[3]==='Breach'?'sla-breach':'');
        el.setAttribute('onclick',`openSLAChat('${id}')`);
        const t=slaTimers[id];
        let text='--:--', cls='timer-negative', desc='Timer';
        if(t && !t.breached){ const mm=Math.floor(t.negative/60),ss=(t.negative%60).toString().padStart(2,'0'); text=`-${mm}:${ss}`; desc=m[3]==='Warning'?'Response overdue':'Next response due'; }
        else if(t){ const mm=Math.floor(t.positive/60),ss=(t.positive%60).toString().padStart(2,'0'); text=`+${mm}:${ss}`; cls='timer-positive'; desc='SLA breached'; }
        el.innerHTML=`
          <div style="display:flex;justify-content:space-between;align-items:start">
            <div><div><strong>${m[0]}</strong></div><div style="font-size:14px;color:#7f8c8d">${m[1]} ‚Ä¢ ALPS: ${m[2]}</div></div>
            <div style="text-align:right"><div class="status-indicator" style="font-size:12px">${m[3]}</div></div>
          </div>
          <div class="sla-timer"><div class="${cls}">${text}</div><div style="font-size:12px">${desc}</div></div>`;
        container.appendChild(el);
      });
    }

    /* =======================
       DRAG QUEUE
    ======================== */
    function initializeDragAndDrop(){
      const list=document.getElementById('queueList');
      let dragged=null;
      list.addEventListener('dragstart',e=>{
        if(e.target.classList.contains('queue-item')){ dragged=e.target; e.target.style.opacity='.5'; }
      });
      list.addEventListener('dragend',e=>{ if(e.target.classList.contains('queue-item')) e.target.style.opacity=''; });
      list.addEventListener('dragover',e=>e.preventDefault());
      list.addEventListener('drop',e=>{
        e.preventDefault();
        const t=e.target.closest('.queue-item');
        if(dragged && t && t!==dragged){
          const rect=t.getBoundingClientRect(); const mid=rect.top+rect.height/2;
          if(e.clientY<mid) list.insertBefore(dragged,t); else list.insertBefore(dragged,t.nextSibling);
          updateQueuePositions();
          applyTopSalesFromQueue();
        }
        dragged=null;
      });
    }
    function updateQueuePositions(){
      const items=[...document.querySelectorAll('#queueList .queue-item')];
      items.forEach((it,i)=>{ it.querySelector('.position-text').textContent=`Position: ${i+1}`; it.dataset.position=i+1; });
      // update positions on agent cards too
      items.forEach((it,i)=>{
        const id = it.dataset.agent;
        const card = document.querySelector(`.agent-card[data-agent="${id}"]`);
        if(card){ card.querySelector('.role-line .pos').textContent = (i+1); }
      });
    }
    function applyTopSalesFromQueue(){
      const items=[...document.querySelectorAll('#queueList .queue-item')];
      // determine top (position 1)
      const topId = items[0].dataset.agent;
      document.querySelectorAll('.agent-card').forEach(card=>{
        const id = card.dataset.agent;
        const nameEl = card.querySelector('.agent-name');
        const roleLine = card.querySelector('.role-line');
        if(id===topId){
          card.classList.add('top-sales');
          if(!nameEl.textContent.startsWith('üëë')) nameEl.textContent = 'üëë ' + nameEl.textContent.replace('üëë ','');
          roleLine.childNodes[0].nodeValue = 'Top Sales ‚Ä¢ Queue Position: '; // keep span(pos)
        }else{
          card.classList.remove('top-sales');
          nameEl.textContent = nameEl.textContent.replace('üëë ','');
          roleLine.childNodes[0].nodeValue = 'Agent ‚Ä¢ Queue Position: ';
        }
      });
      // update queue labels text too
      items.forEach((it,i)=>{
        const label=it.querySelector('.queue-label');
        const name=label.textContent.replace('üëë ','').replace(' - Top Sales','').replace(' - Agent','');
        if(i===0){ label.innerHTML = 'üëë <strong>'+name+'</strong> - Top Sales'; }
        else{ label.innerHTML = '<strong>'+name+'</strong> - Agent'; }
      });
    }

    /* =======================
       CLICK OUTSIDE MODALS
    ======================== */
    window.addEventListener('click',e=>{
      const modal=document.getElementById('chartModal');
      if(e.target===modal) closeModal();
      const alertBox=document.getElementById('slaAlert');
      if(e.target===alertBox) alertBox.style.display='none';
    });

    /* =======================
       CHAT HELPERS
    ======================== */
    function handleSLAMessage(event){} // (already wired inside sendSLAMessage)
  </script>
</body>
</html>




