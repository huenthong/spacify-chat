<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>BeLive ALPS Management Dashboard</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
<style>
  *{margin:0;padding:0;box-sizing:border-box}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;background:#f5f6fa;height:100vh;overflow:hidden}
  .dashboard{display:flex;height:100vh}
  .sidebar{width:280px;background:#2c3e50;color:#fff;padding:20px;overflow-y:auto}
  .nav-item{padding:15px;margin:5px 0;border-radius:8px;cursor:pointer;display:flex;gap:10px;align-items:center;transition:.2s}
  .nav-item:hover,.nav-item.active{background:#34495e;transform:translateX(4px)}
  .nav-icon{font-size:20px}
  .main-content{flex:1;display:flex;flex-direction:column;overflow:hidden}
  .header{background:#fff;padding:20px;box-shadow:0 2px 10px rgba(0,0,0,.08);display:flex;justify-content:space-between;align-items:center}
  .content-area{flex:1;padding:20px;overflow-y:auto}
  .page{display:none}.page.active{display:block}

  .live-indicator{display:inline-flex;gap:6px;align-items:center;background:#e74c3c;color:#fff;padding:5px 10px;border-radius:14px;font-size:12px;font-weight:700}
  .pulse-dot{width:8px;height:8px;border-radius:50%;background:#fff;animation:pulse 2s infinite}
  @keyframes pulse{0%{opacity:1}50%{opacity:.5}100%{opacity:1}}

  .agents-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:20px;margin-bottom:30px}
  .agent-card{background:#fff;border-radius:15px;padding:20px;box-shadow:0 4px 14px rgba(0,0,0,.08);cursor:pointer;border-left:5px solid #3498db;transition:.2s}
  .agent-card:hover{transform:translateY(-4px)}
  .agent-card.top-sales{border-left-color:#f39c12;background:linear-gradient(135deg,#fff9e6,#fff)}
  .agent-card.available{border-left-color:#2ecc71}
  .agent-card.busy{border-left-color:#e74c3c}
  .agent-card.away{border-left-color:#95a5a6}
  .agent-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
  .agent-name{font-weight:700}
  .agent-status{padding:5px 12px;border-radius:20px;font-size:12px;font-weight:700}
  .status-available{background:#2ecc71;color:#fff}
  .status-busy{background:#e74c3c;color:#fff}
  .status-away{background:#f39c12;color:#fff}
  .capacity-bar{background:#ecf0f1;height:12px;border-radius:6px;overflow:hidden;margin:10px 0}
  .capacity-fill{height:100%;border-radius:6px;transition:width .4s}
  .capacity-low{background:#2ecc71}.capacity-medium{background:#f39c12}.capacity-high{background:#e74c3c}
  .agent-stats{display:flex;justify-content:space-between;margin-top:12px}
  .stat-item{text-align:center}.stat-number{font-weight:800;color:#2c3e50}

  .queue-management{background:#fff;border-radius:15px;padding:20px;box-shadow:0 4px 14px rgba(0,0,0,.08)}
  .queue-item{display:flex;justify-content:space-between;align-items:center;padding:14px;margin:10px 0;background:#f8f9fa;border-left:4px solid #3498db;border-radius:10px;cursor:move}
  .drag-handle{cursor:grab;color:#7f8c8d;font-size:18px}

  .leads-container{display:grid;grid-template-columns:1fr 1fr;gap:30px;height:100%}
  .leads-section{background:#fff;border-radius:15px;padding:20px;box-shadow:0 4px 14px rgba(0,0,0,.08);display:flex;flex-direction:column;overflow:hidden}
  .section-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;padding-bottom:12px;border-bottom:2px solid #ecf0f1}
  .leads-list{flex:1;overflow-y:auto}
  .lead-item{display:flex;gap:12px;align-items:center;background:#f8f9fa;border-radius:12px;padding:14px;margin:10px 0;border-left:4px solid #95a5a6;cursor:pointer;transition:.2s}
  .lead-item:hover{transform:translateX(4px)}
  .lead-item.hot{border-left-color:#e74c3c;background:linear-gradient(135deg,#ffebee,#f8f9fa)}
  .lead-item.warm{border-left-color:#f39c12;background:linear-gradient(135deg,#fff8e1,#f8f9fa)}
  .lead-score{width:56px;height:56px;border-radius:50%;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:800}
  .score-hot{background:linear-gradient(135deg,#e74c3c,#c0392b)}
  .score-warm{background:linear-gradient(135deg,#f39c12,#e67e22)}
  .score-cold{background:linear-gradient(135deg,#95a5a6,#7f8c8d)}
  .lead-name{font-weight:700}
  .lead-details{font-size:14px;color:#7f8c8d}
  .lead-timestamp{font-size:12px;color:#b4bcc2}

  .chat-container{background:#fff;border-radius:15px;box-shadow:0 4px 14px rgba(0,0,0,.08);height:100%;display:flex;flex-direction:column;position:relative}
  .chat-header{background:#25D366;color:#fff;padding:18px;border-radius:15px 15px 0 0;display:flex;justify-content:space-between}
  .chat-messages{flex:1;overflow-y:auto;padding:18px;background:#e5ddd5;position:relative}
  .message{max-width:70%;padding:12px 16px;margin:10px 0;border-radius:18px;display:flex;flex-direction:column}
  .message-bot{background:#fff;align-self:flex-start;border-bottom-left-radius:4px;box-shadow:0 1px 2px rgba(0,0,0,.08)}
  .message-user{background:#DCF8C6;align-self:flex-end;border-bottom-right-radius:4px;margin-left:auto;box-shadow:0 1px 2px rgba(0,0,0,.08)}
  .message-system{background:#fff3cd!important;border:2px solid #ffeaa7!important;text-align:center!important;max-width:90%!important;margin:10px auto!important}
  .message-ai-takeover{background:#e3f2fd!important;border:2px solid #2196f3!important;text-align:center!important;max-width:90%!important;margin:10px auto!important}

  .score-display{position:fixed;top:130px;right:20px;background:rgba(255,255,255,.98);padding:14px;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,.12);min-width:200px;z-index:1000}
  .score-bar{height:20px;background:#e0e0e0;border-radius:10px;overflow:hidden;margin:8px 0}
  .score-fill{height:100%;border-radius:10px;transition:width .4s}

  .sla-container{display:grid;grid-template-columns:1fr 2fr;gap:20px;height:100%}
  .conversations-list{background:#fff;border-radius:15px;padding:20px;box-shadow:0 4px 14px rgba(0,0,0,.08);overflow-y:auto}
  .conversation-item{padding:14px;margin:10px 0;background:#f8f9fa;border-radius:10px;border-left:4px solid #3498db;cursor:pointer;transition:.2s;position:relative}
  .conversation-item:hover{background:#e3f2fd;transform:translateX(4px)}
  .conversation-item.sla-warning{border-left-color:#f39c12;background:#fff8e1}
  .conversation-item.sla-breach{border-left-color:#e74c3c;background:#ffebee}
  .sla-timer{display:flex;gap:10px;align-items:center;margin-top:8px}
  .timer-negative{background:#f39c12;color:#fff;padding:5px 10px;border-radius:14px;font-weight:800}
  .timer-positive{background:#e74c3c;color:#fff;padding:5px 10px;border-radius:14px;font-weight:800}
  .sla-chat-area{background:#fff;border-radius:15px;box-shadow:0 4px 14px rgba(0,0,0,.08);display:flex;flex-direction:column}
  .sla-chat-header{background:#34495e;color:#fff;padding:18px;border-radius:15px 15px 0 0;display:flex;justify-content:space-between;align-items:center}
  .sla-messages{flex:1;overflow-y:auto;padding:18px;background:#f8f9fa}
  .sla-input{display:flex;gap:10px;padding:18px;border-top:1px solid #ecf0f1}
  .sla-input input{flex:1;padding:12px;border:2px solid #ecf0f1;border-radius:22px;outline:none}
  .sla-input button{padding:12px 18px;border:none;border-radius:22px;color:#fff;background:#25D366;cursor:pointer}

  .options-container{display:flex;flex-direction:column;gap:8px;margin-top:10px}
  .option-button{padding:10px 14px;background:#f0f0f0;border:2px solid #e0e0e0;border-radius:20px;cursor:pointer;text-align:center}
  .option-button:hover{background:#25D366;color:#fff;border-color:#25D366}
  .property-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:10px;margin-top:10px}
  .property-item{padding:12px;background:#f8f9fa;border:2px solid #e9ecef;border-radius:12px;text-align:center;cursor:pointer}
  .property-item:hover{background:#25D366;color:#fff;border-color:#25D366}
  .input-field{width:100%;padding:12px;border:2px solid #e0e0e0;border-radius:20px;margin-top:10px}
  .typing-indicator{display:none;background:#fff;padding:14px;border-radius:18px;max-width:70%;border-bottom-left-radius:4px}
  .typing-dots{display:flex;gap:4px}.typing-dot{width:8px;height:8px;background:#999;border-radius:50%;animation:typing 1.4s infinite}
  .typing-dot:nth-child(2){animation-delay:.2s}.typing-dot:nth-child(3){animation-delay:.4s}
  @keyframes typing{0%,60%,100%{transform:translateY(0)}30%{transform:translateY(-8px)}}

  .checkbox-group{margin-top:10px}
  .checkbox-item{display:flex;align-items:center;gap:8px;padding:8px;margin:4px 0;border-radius:8px;cursor:pointer}
  .checkbox-item:hover,.checkbox-item.selected{background:#e8f5e8}
  .checkbox-item input{margin:0}
  .continue-btn{margin-top:10px;padding:10px 20px;background:#25D366;color:#fff;border:none;border-radius:20px;cursor:pointer}

  .modal{display:none;position:fixed;z-index:1000;inset:0;background:rgba(0,0,0,.5)}
  .modal-content{background:#fff;margin:5% auto;padding:24px;border-radius:14px;width:80%;max-width:820px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
  .close{float:right;font-size:26px;cursor:pointer;color:#666}
  .btn{padding:10px 18px;border:none;border-radius:8px;cursor:pointer;font-weight:700}
  .btn-primary{background:#3498db;color:#fff}.btn-danger{background:#e74c3c;color:#fff}

  .sla-alert{position:fixed;z-index:1100;top:50%;left:50%;transform:translate(-50%,-50%);background:#fff;padding:26px;border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.3);display:none;border-left:5px solid #e74c3c}
  .alert-actions{display:flex;gap:12px;margin-top:16px;justify-content:center}

  .live-score-badge{position:absolute;top:5px;right:5px;background:#3498db;color:#fff;padding:2px 8px;border-radius:10px;font-size:11px;font-weight:700}

  .message-score{position:absolute;top:5px;right:5px;background:rgba(52,152,219,.1);border:1px solid #3498db;color:#3498db;padding:2px 6px;border-radius:8px;font-size:10px;font-weight:700}

  @media(max-width:900px){
    .leads-container{grid-template-columns:1fr}
    .sla-container{grid-template-columns:1fr}
    .chat-container{padding-right:0}
    .score-display{position:relative;top:0;right:0;margin:10px}
  }
</style>
</head>
<body>
<div class="dashboard">
  <div class="sidebar">
    <h2 style="margin-bottom:24px">🏠 BeLive ALPS</h2>
    <div class="nav-item active" data-page="agents"><span class="nav-icon">👥</span><span>Agent Status</span></div>
    <div class="nav-item" data-page="leads"><span class="nav-icon">📊</span><span>Lead Management</span></div>
    <div class="nav-item" data-page="chat"><span class="nav-icon">💬</span><span>Chat Window</span></div>
    <div class="nav-item" data-page="sla"><span class="nav-icon">⏱️</span><span>SLA Monitoring</span></div>

    <div style="margin-top:36px;padding:16px;background:rgba(255,255,255,.1);border-radius:10px">
      <div class="live-indicator"><div class="pulse-dot"></div>LIVE</div>
      <div style="margin-top:10px;font-size:14px">
        System Status: Active<br/>Last Update: <span id="lastUpdate">--:--:--</span>
      </div>
    </div>
  </div>

  <div class="main-content">
    <div class="header">
      <div>
        <h1 id="pageTitle">Agent Status Dashboard</h1>
        <p id="pageSubtitle">Real-time agent monitoring and queue management</p>
      </div>
      <div class="live-indicator"><div class="pulse-dot"></div>LIVE DASHBOARD</div>
    </div>

    <div class="content-area">
      <!-- Agents -->
      <div id="agents" class="page active">
        <div class="agents-grid" id="agentsGrid">
          <!-- populated by JS -->
        </div>

        <div class="queue-management">
          <h3 style="margin-bottom:12px">📋 Agent Queue Management</h3>
          <p style="margin-bottom:10px;color:#7f8c8d">Drag to reorder priority • Position 1 automatically becomes Top Sales</p>
          <div id="queueList"></div>
        </div>
      </div>

      <!-- Leads -->
      <div id="leads" class="page">
        <div class="leads-container">
          <div class="leads-section">
            <div class="section-header">
              <h3>🔥 Ongoing Leads</h3>
              <div class="live-indicator"><div class="pulse-dot"></div>LIVE</div>
            </div>
            <div class="leads-list" id="ongoingLeads"></div>
          </div>

          <div class="leads-section">
            <div class="section-header">
              <h3>📋 Past Leads</h3>
              <div style="font-size:14px;color:#7f8c8d">Last 24 hours</div>
            </div>
            <div class="leads-list" id="pastLeads"></div>
          </div>
        </div>
      </div>

      <!-- Chat -->
      <div id="chat" class="page">
        <div class="chat-container">
          <div class="chat-header">
            <div>
              <h3>🤖 BeLive AI Assistant</h3>
              <div>Lead Qualification Chat • No Timer (AI Handling)</div>
            </div>
          </div>

          <div class="chat-messages" id="chatMessages">
            <div class="typing-indicator" id="typingIndicator">
              <div class="typing-dots">
                <div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- SLA -->
      <div id="sla" class="page">
        <div class="sla-container">
          <div class="conversations-list" id="conversationsList">
            <!-- populated by JS -->
          </div>

          <div class="sla-chat-area">
            <div class="sla-chat-header">
              <div>
                <h3 id="slaCurrentChat">Select a conversation</h3>
                <div id="slaCurrentDetails">Click on a conversation to view details</div>
              </div>
              <div id="slaCurrentTimer" style="background:rgba(255,255,255,.2);padding:10px;border-radius:10px">--:--</div>
            </div>

            <div class="sla-messages" id="slaMessages">
              <div style="text-align:center;color:#7f8c8d;margin-top:40px">
                <h3>💬 SLA Chat Monitor</h3>
                <p>Select a conversation from the left to view and manage the chat</p>
              </div>
            </div>

            <div class="sla-input" id="slaInputArea" style="display:none">
              <input id="slaMessageInput" type="text" placeholder="Type your message..." onkeypress="handleSLAMessage(event)"/>
              <button onclick="sendSLAMessage()">Send</button>
              <button onclick="escalateConversation()" style="background:#e74c3c">Escalate</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Fixed Score Display -->
<div class="score-display" id="scoreFloater" style="display:none">
  <h4>ALPS Score</h4>
  <div class="score-bar"><div class="score-fill score-cold" id="chatScoreBar" style="width:0%"></div></div>
  <div id="chatScoreText">0 / 100</div>
  <div id="chatScoreCategory">Getting Started</div>
</div>

<!-- Lead Chart Modal -->
<div id="chartModal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeModal()">&times;</span>
    <h2 id="chartTitle">Lead Score Progression</h2>
    <canvas id="leadChart" width="400" height="200"></canvas>
    <div id="chartDetails" style="margin-top:12px"></div>
  </div>
</div>

<!-- SLA Alert -->
<div id="slaAlert" class="sla-alert">
  <h3>🚨 SLA BREACH ALERT</h3>
  <p>Agent has not responded within the SLA timeframe</p>
  <div style="margin:12px 0;padding:12px;background:#fff3cd;border-radius:8px">
    <strong>Conversation:</strong> <span id="alertConversation">Lead #</span><br/>
    <strong>Agent:</strong> <span id="alertAgent">-</span><br/>
    <strong>Time Exceeded:</strong> <span id="alertTime">+0:01</span>
  </div>
  <div class="alert-actions">
    <button class="btn btn-primary" onclick="goToConversation()">Go to Conversation</button>
    <button class="btn btn-danger" onclick="reassignConversation()">Reassign</button>
  </div>
</div>

<script>
'use strict';

/* ======= CONFIG ======= */
const MODEL_SOURCE = 'server'; // Using server-side pickle model
const SCORE_ENDPOINT = 'https://web-production-11d29.up.railway.app/api/score'; // Replace with your Heroku app URL
const LOW_SCORE_THRESHOLD = 30;
const INITIAL_RESPONSE_TIMEOUT = 300;

// Random Forest Model Weights (based on your feature importance)
const MODEL_WEIGHTS = {
  // Top features with their importance scores
  initial_contact_date: 0.380348,
  move_in_date: 0.165708,
  contact_hour: 0.105576,
  rental_proposed: 0.074638,
  customer_journey_unknown: 0.038706,
  nationality_standard: 0.037654,
  no_of_pax: 0.030717,
  is_business_hours: 0.030683,
  contact_wednesday: 0.030378,
  budget_category: 0.018691,
  contact_monday: 0.017803,
  budget: 0.016609,
  move_urgency: 0.014629,
  is_weekend: 0.010283,
  contact_month: 0.007865
};

// Encoding mappings (adjust based on your training data)
const ENCODINGS = {
  nationality: {
    'Malaysian': 1,
    'Singaporean': 2,
    'Indonesian': 3,
    'Filipino': 4,
    'Indian': 5,
    'Chinese': 6,
    'Others': 7
  },
  budget_category: {
    'low': 1,        // < 600
    'medium': 2,     // 600-1000  
    'high': 3,       // 1000-1500
    'premium': 4     // > 1500
  },
  pax_mapping: {
    '1 person': 1,
    '2 people': 2,
    'More than 2': 3
  },
  urgency_mapping: {
    'immediate': 1,    // <= 7 days
    'soon': 2,         // 8-30 days
    'flexible': 3      // > 30 days
  }
};

// Helper functions for feature engineering
function getContactHour() {
  return new Date().getHours();
}

function isBusinessHours(hour = null) {
  const h = hour || getContactHour();
  return h >= 9 && h <= 17 ? 1 : 0;
}

function isWeekend() {
  const day = new Date().getDay();
  return (day === 0 || day === 6) ? 1 : 0;
}

function getContactDay() {
  const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
  return days[new Date().getDay()];
}

function getBudgetCategory(budget) {
  const b = parseInt(budget) || 0;
  if (b < 600) return 'low';
  if (b <= 1000) return 'medium';
  if (b <= 1500) return 'high';
  return 'premium';
}

function getMoveUrgency(moveInDate) {
  if (!moveInDate) return 'flexible';
  const moveDate = new Date(moveInDate);
  const today = new Date();
  const diffDays = Math.ceil((moveDate - today) / (1000 * 60 * 60 * 24));
  
  if (diffDays <= 7) return 'immediate';
  if (diffDays <= 30) return 'soon';
  return 'flexible';
}

function calculateDaysDifference(date1, date2 = new Date()) {
  const diff = Math.abs(new Date(date1) - date2);
  return Math.ceil(diff / (1000 * 60 * 60 * 24));
}

// Main Random Forest scoring function
function randomForestScore(features) {
  let totalScore = 0;
  const currentDate = new Date();
  const contactHour = getContactHour();
  const contactDay = getContactDay();
  const contactMonth = currentDate.getMonth() + 1;
  
  // Feature: Initial Contact Date (most important - 38.03%)
  const contactDateScore = 50; // Base score for immediate contact
  totalScore += contactDateScore * MODEL_WEIGHTS.initial_contact_date;
  
  // Feature: Move in Date (16.57%)
  if (features.movein) {
    const moveUrgency = getMoveUrgency(features.movein);
    const urgencyScore = ENCODINGS.urgency_mapping[moveUrgency] || 2;
    const moveDateScore = (4 - urgencyScore) * 25; // Higher urgency = higher score
    totalScore += moveDateScore * MODEL_WEIGHTS.move_in_date;
  }
  
  // Feature: Contact Hour (10.56%)
  const hourScore = isBusinessHours(contactHour) ? 80 : 40;
  totalScore += hourScore * MODEL_WEIGHTS.contact_hour;
  
  // Feature: Rental Proposed / Budget (7.46%)
  if (features.budget) {
    const budget = parseInt(features.budget) || 0;
    const budgetScore = Math.min(100, (budget / 2000) * 100); // Normalize to 0-100
    totalScore += budgetScore * MODEL_WEIGHTS.rental_proposed;
  }
  
  // Feature: Customer Journey Unknown (3.87%)
  // This represents how much information we have
  const knownFields = Object.keys(features).filter(k => features[k]).length;
  const journeyScore = Math.min(100, (knownFields / 12) * 100);
  totalScore += journeyScore * MODEL_WEIGHTS.customer_journey_unknown;
  
  // Feature: Nationality (3.77%)
  if (features.nationality) {
    const natScore = ENCODINGS.nationality[features.nationality] || 7;
    const nationalityScore = (8 - natScore) * 14.3; // Malaysian gets highest score
    totalScore += nationalityScore * MODEL_WEIGHTS.nationality_standard;
  }
  
  // Feature: Number of Pax (3.07%)
  if (features.pax) {
    const paxValue = ENCODINGS.pax_mapping[features.pax] || 1;
    const paxScore = (4 - paxValue) * 33.3; // 1 person gets highest score
    totalScore += paxScore * MODEL_WEIGHTS.no_of_pax;
  }
  
  // Feature: Is Business Hours (3.07%)
  const businessHoursScore = isBusinessHours() ? 100 : 20;
  totalScore += businessHoursScore * MODEL_WEIGHTS.is_business_hours;
  
  // Feature: Contact Day Wednesday (3.04%)
  if (contactDay === 'Wednesday') {
    totalScore += 100 * MODEL_WEIGHTS.contact_wednesday;
  }
  
  // Feature: Budget Category (1.87%)
  if (features.budget) {
    const category = getBudgetCategory(features.budget);
    const categoryScore = ENCODINGS.budget_category[category] * 25;
    totalScore += categoryScore * MODEL_WEIGHTS.budget_category;
  }
  
  // Feature: Contact Monday (1.78%)
  if (contactDay === 'Monday') {
    totalScore += 100 * MODEL_WEIGHTS.contact_monday;
  }
  
  // Feature: Raw Budget (1.66%)
  if (features.budget) {
    const budgetNormalized = Math.min(100, (parseInt(features.budget) / 3000) * 100);
    totalScore += budgetNormalized * MODEL_WEIGHTS.budget;
  }
  
  // Feature: Move Urgency (1.46%)
  if (features.movein) {
    const urgency = getMoveUrgency(features.movein);
    const urgencyScore = ENCODINGS.urgency_mapping[urgency];
    totalScore += urgencyScore * 25 * MODEL_WEIGHTS.move_urgency;
  }
  
  // Feature: Is Weekend (1.03%)
  const weekendScore = isWeekend() ? 30 : 70; // Weekdays are better for business
  totalScore += weekendScore * MODEL_WEIGHTS.is_weekend;
  
  // Feature: Contact Month (0.79%)
  const monthScore = (contactMonth / 12) * 100;
  totalScore += monthScore * MODEL_WEIGHTS.contact_month;
  
  // Additional factors from other form fields
  if (features.area) totalScore += 5;
  if (features.property) totalScore += 3;
  if (features.workplace) totalScore += 4;
  if (features.car === 'Yes') totalScore += 2;
  if (features.parking === 'Yes') totalScore += 2;
  
  // Normalize to 0-100 range
  return Math.max(0, Math.min(100, Math.round(totalScore)));
}

// Updated scoring function
function recomputeScoreFromFeatures(features){
  return Promise.resolve(randomForestScore(features));
}

// Updated heuristic score to use Random Forest
function heuristicScore(features){
  return randomForestScore(features);
}

/* ======= GLOBAL STATE ======= */
let currentPage = 'agents';
let currentListView = {type:'all', id:null};
let selectedConversation = null;
let lastAlertConvId = null;

let leadChart = null;
let realTimeInterval;
let nextAgentIndex = 0; // Round robin counter

const agentOrder = ['agent1','agent2','agent3','agent4','agent5'];
const AGENTS = {
  agent1:{name:'Sarah Chen', role:'Agent', status:'available'},
  agent2:{name:'Mike Johnson', role:'Agent', status:'busy'},
  agent3:{name:'Lisa Wong', role:'Agent', status:'available'},
  agent4:{name:'David Lim', role:'Agent', status:'away'},
  agent5:{name:'Jennifer Tan', role:'Agent', status:'available'}
};
const agentConversations = {agent1:[],agent2:[],agent3:[],agent4:[],agent5:[]};
const activeConversations = {};

const legacySLAs = {
  conv1:{negative:443,positive:0,breached:false,meta:{title:'Lead #2024001 • Sarah Chen',area:'Mont Kiara',score:87,status:'Active'}},
  conv2:{negative:135,positive:0,breached:false,meta:{title:'Lead #2024002 • Mike Johnson',area:'KL/Selangor',score:82,status:'Warning'}},
  conv3:{negative:0,positive:225,breached:true, meta:{title:'Lead #2024003 • Lisa Wong',area:'Petaling Jaya',score:65,status:'Breach'}},
  conv4:{negative:522,positive:0,breached:false,meta:{title:'Lead #2024004 • In Queue',area:'JB/Penang',score:58,status:'Waiting'}}
};

let nextLeadId = 2024010;
let completedLeads = [];
let allLeadsDatabase = []; // Store all leads for Lead Management page

// Chat state
let chatCurrentStep = 0;
let chatUserResponses = {};
let chatAlpsScore = 0;

const AREAS = ["KL/Selangor","Perak","JB/Penang","Negeri Sembilan","Genting Highlands"];
const PROPERTIES = ["121 Residence","7 Tree Seven","Acacia Residence","Ara Damansara","Ampang","Arte Cheras","Astoria","Austin Regency","Bandar Sri Permaisuri","Bora Residence","Bukit Jalil","Cheras","D'Cosmos","Duta Park","Emporis Kota Damansara","Epic Residence","HighPark Suites","Icon City","Kelana Jaya","Keramat","Kota Damansara","M Vertica","Majestic Maxim","Medini Signature","Meta City","MH Platinum 2","Mont Kiara","One Cochrane","Parc3","Petaling Jaya","Pinnacle","Platinum Splendor","Razak City Residences","Rica Residence","Sentul","Setapak","Subang Jaya","Sunway Avila","Sunway Serene","Trion KL","Vista Sentul","Vivo Residence"];

const questions = [
  {id:'area',text:"Hi! Welcome to BeLive. I'm here to help you find the perfect room. Choose an area:",type:'select',options:AREAS,weight:15},
  {id:'property',text:"Great choice! Here are the available properties in your selected area:",type:'property_select',weight:10},
  {id:'budget',text:"What's your budget range for monthly rent?",type:'input',placeholder:'e.g., 800',weight:25},
  {id:'pax',text:'How many people will be staying?',type:'select',options:['1 person','2 people','More than 2'],weight:10},
  {id:'car',text:'Do you have a car?',type:'select',options:['Yes','No'],weight:5},
  {id:'parking',text:'Do you need a car park lot?',type:'select',options:['Yes','No'],weight:5},
  {id:'movein',text:'When are you planning to move in?',type:'date',weight:20},
  {id:'tenancy',text:"What's your preferred tenancy period?",type:'select',options:['6 months','12 months'],weight:5},
  {id:'gender',text:"What's your gender?",type:'select',options:['Male','Female'],weight:0},
  {id:'unit_spec',text:'What type of unit do you prefer? (You can select multiple)',type:'multiple',options:['Female unit','Male unit','Mixed Gender unit'],weight:5},
  {id:'workplace',text:'Where is your workplace? This helps us recommend the closest property.',type:'input',placeholder:'e.g., KLCC, Cyberjaya',weight:10},
  {id:'nationality',text:"What's your nationality?",type:'select',options:['Malaysian','Others'],weight:8}
];

/* ======= INIT ======= */
document.addEventListener('DOMContentLoaded', () => {
  document.querySelectorAll('.nav-item').forEach(item=>{
    item.addEventListener('click',()=>switchPage(item.dataset.page));
  });

  renderAgentsGrid();
  renderQueueFromAgents();

  document.getElementById('agentsGrid').addEventListener('click', (e)=>{
    const card = e.target.closest('.agent-card');
    if(!card) return;
    goToAgentConversations(card.dataset.agent);
  });

  initializeDragAndDrop();
  startRealTimeLoop();
  seedDemoConversations();
  seedInitialLeads();
});

/* ======= NAV ======= */
function switchPage(pageName){
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
  document.getElementById(pageName).classList.add('active');
  document.querySelector(`.nav-item[data-page="${pageName}"]`).classList.add('active');
  currentPage = pageName;
  const t={agents:'Agent Status Dashboard',leads:'Lead Management',chat:'AI Chat Interface',sla:'SLA Monitoring'};
  const s={agents:'Real-time agent monitoring and queue management',leads:'Lead scoring and progression tracking',chat:'AI-powered lead qualification system',sla:'Response time monitoring and escalation'};
  document.getElementById('pageTitle').textContent=t[pageName];
  document.getElementById('pageSubtitle').textContent=s[pageName];
  
  if(pageName==='chat'){ 
    setTimeout(initializeChat,200); 
    document.getElementById('scoreFloater').style.display = 'block';
  } else {
    document.getElementById('scoreFloater').style.display = 'none';
  }
  if(pageName==='sla'){ showAllConversations(); }
  if(pageName==='leads'){ refreshLeadsView(); }
}

/* ======= REAL-TIME LOOP ======= */
function startRealTimeLoop(){
  clearInterval(realTimeInterval);
  realTimeInterval = setInterval(()=>{
    document.getElementById('lastUpdate').textContent=new Date().toLocaleTimeString();
    syncAgentCapacitiesToConversations();
    tickSLATimers();
    if(currentPage === 'leads') refreshLeadsView();
  },1000);
}

/* ======= AGENTS ======= */
function syncAgentCapacitiesToConversations(){
  agentOrder.forEach(agentId=>{
    const card = document.querySelector(`.agent-card[data-agent="${agentId}"]`);
    if(!card) return;
    const count = agentConversations[agentId].length;
    const bar = card.querySelector('.capacity-fill');
    const txt = card.querySelector('.capacity-text');
    const pct = Math.min(100, (count/10)*100);
    bar.style.width = pct+'%';
    bar.className = 'capacity-fill ' + (pct<=30?'capacity-low':pct<=70?'capacity-medium':'capacity-high');
    txt.textContent = `Capacity: ${count}/10 chats`;
  });
}

function renderAgentsGrid(){
  const grid = document.getElementById('agentsGrid');
  grid.innerHTML = '';
  agentOrder.forEach((id, index)=>{
    const a = AGENTS[id];
    const cap = agentConversations[id].length;
    const statusClass = a.status==='available'?'status-available':a.status==='busy'?'status-busy':'status-away';
    const borderClass = a.status==='available'?'available':a.status==='busy'?'busy':'away';
    const isTopSales = index === 0;
    const avgScore = (8.70 - index * 0.20).toFixed(2);
    grid.innerHTML += `
      <div class="agent-card ${borderClass} ${isTopSales?'top-sales':''}" data-agent="${id}">
        <div class="agent-header">
          <div class="agent-name">${isTopSales?'👑 ':''}${a.name}</div>
          <div class="agent-status ${statusClass}">${a.status==='available'?'Available':a.status==='busy'?'Busy':'Break'}</div>
        </div>
        <div>${isTopSales?'Top Sales Agent':'Agent'} • Queue Position: ${index+1}</div>
        <div class="capacity-bar"><div class="capacity-fill capacity-low" style="width:${(cap/10)*100}%"></div></div>
        <div class="capacity-text">Capacity: ${cap}/10 chats</div>
        <div class="agent-stats">
          <div class="stat-item"><div class="stat-number">${90-index*2}%</div><div class="stat-label">SLA Rate</div></div>
          <div class="stat-item"><div class="stat-number">${avgScore}</div><div class="stat-label">Avg Score</div></div>
          <div class="stat-item"><div class="stat-number">${24-index*3}</div><div class="stat-label">Leads Today</div></div>
        </div>
      </div>`;
  });
}

function renderQueueFromAgents(){
  const q = document.getElementById('queueList');
  q.innerHTML = '';
  agentOrder.forEach((id, i)=>{
    const isTopSales = i === 0;
    q.innerHTML += `
      <div class="queue-item" draggable="true" data-agent="${id}" data-position="${i+1}">
        <div style="display:flex;align-items:center;gap:12px">
          <div class="drag-handle">≡</div>
          <div>${isTopSales?'👑 ':''}<strong>${AGENTS[id].name}</strong> - ${isTopSales?'Top Sales':'Agent'}</div>
        </div>
        <div class="position-text">Position: ${i+1}</div>
      </div>`;
  });
}

/* ======= ROUND ROBIN AGENT SELECTION ======= */
function getNextAvailableAgent(){
  for(let i = 0; i < agentOrder.length; i++){
    const agentId = agentOrder[nextAgentIndex];
    nextAgentIndex = (nextAgentIndex + 1) % agentOrder.length;
    
    if(AGENTS[agentId].status !== 'away' && agentConversations[agentId].length < 10){
      return {id: agentId, name: AGENTS[agentId].name};
    }
  }
  return null;
}

/* ======= LEADS MANAGEMENT ======= */
function seedInitialLeads(){
  const initialLeads = [
    {area:'Mont Kiara', score:87, agent:'Sarah Chen', status:'assigned'},
    {area:'KL/Selangor', score:82, agent:'Mike Johnson', status:'assigned'},
    {area:'Negeri Sembilan', score:76, agent:'Lisa Wong', status:'assigned'},
    {area:'JB/Penang', score:65, agent:'AI Bot', status:'ai_handling'},
    {area:'Genting Highlands', score:58, agent:'In Queue', status:'in_queue'}
  ];
  
  initialLeads.forEach((lead, index) => {
    const leadData = {
      id: `lead${nextLeadId}`,
      leadNumber: `#${nextLeadId}`,
      score: lead.score,
      area: lead.area,
      budget: 800 + (index * 100),
      movein: new Date(Date.now() + (index + 1) * 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
      property: PROPERTIES[Math.floor(Math.random() * PROPERTIES.length)],
      agent: lead.agent,
      status: lead.status,
      timestamp: new Date(Date.now() - (index * 30 * 60 * 1000)),
      responses: {}
    };
    
    allLeadsDatabase.push(leadData);
    nextLeadId++;
  });
}

function refreshLeadsView(){
  const ongoingContainer = document.getElementById('ongoingLeads');
  const pastContainer = document.getElementById('pastLeads');
  
  ongoingContainer.innerHTML = '';
  pastContainer.innerHTML = '';
  
  allLeadsDatabase.forEach(lead => {
    const isOngoing = ['assigned', 'ai_handling', 'in_queue', 'ai_takeover'].includes(lead.status);
    const container = isOngoing ? ongoingContainer : pastContainer;
    
    const leadElement = createLeadElement(lead);
    container.appendChild(leadElement);
  });
}

function createLeadElement(lead){
  const cls = lead.score >= 70 ? 'hot' : lead.score >= 40 ? 'warm' : 'cold';
  const scoreCls = lead.score >= 70 ? 'score-hot' : lead.score >= 40 ? 'score-warm' : 'score-cold';
  const statusText = getLeadStatusText(lead.status);
  
  const el = document.createElement('div');
  el.className = `lead-item ${cls}`;
  el.setAttribute('data-lead', lead.id);
  el.onclick = () => showLeadChart(lead.id);
  
  el.innerHTML = `
    <div class="lead-score ${scoreCls}">${lead.score}</div>
    <div class="lead-info">
      <div class="lead-name">${lead.score >= 70 ? '🔥' : ''} Lead ${lead.leadNumber}</div>
      <div class="lead-details">Area: ${lead.area} • Budget: RM${lead.budget}<br/>Move-in: ${lead.movein} • Agent: ${lead.agent}</div>
      <div class="lead-timestamp">Started: ${lead.timestamp.toLocaleTimeString()} • Status: ${statusText}</div>
    </div>`;
  
  return el;
}

function getLeadStatusText(status){
  switch(status){
    case 'assigned': return 'Assigned';
    case 'ai_handling': return 'AI Handling';
    case 'ai_takeover': return 'AI Takeover';
    case 'in_queue': return 'Queued';
    case 'completed': return 'Completed';
    case 'cancelled': return 'Cancelled';
    default: return 'Pending';
  }
}

/* ======= SLA / CONVERSATIONS ======= */
function tickSLATimers(){
  Object.values(activeConversations).forEach(conv=>{
    const t = conv.slaTimer;
    if(!t) return;

    if(t.timeRemaining > 0){
      t.timeRemaining--;
      if(t.timeRemaining <= 0){
        if(t.type === 'initial'){
          // Auto route to next agent after 5 minutes
          reassignToNextAgent(conv);
        } else {
          t.alertTriggered = true;
          t.overdue = 1;
          showSlaAlert(conv.id);
        }
      }
    } else if(t.overdue > 0 || t.alertTriggered){
      t.overdue++;
    }
    updateConversationListItem(conv.id);
    if(selectedConversation === conv.id) loadActiveConversation(conv);
  });

  Object.keys(legacySLAs).forEach(id=>{
    const t = legacySLAs[id];
    if(!t) return;
    const el = document.querySelector(`[data-legacy="${id}"] .timer-badge`);
    const wrapper = document.querySelector(`[data-legacy="${id}"]`);
    if(!el || !wrapper) return;

    if(!t.breached){
      t.negative--;
      if(t.negative <= 0){ 
        t.breached = true; 
        t.positive = Math.abs(t.negative); 
        t.negative = 0; 
      }
      const m = Math.floor(t.negative/60);
      const s = (t.negative % 60).toString().padStart(2,'0');
      el.textContent = `-${m}:${s}`;
      el.className = 'timer-badge timer-negative';
      wrapper.className = 'conversation-item' + (t.negative <= 120 ? ' sla-warning' : '');
    } else {
      t.positive++;
      const m = Math.floor(t.positive/60);
      const s = (t.positive % 60).toString().padStart(2,'0');
      el.textContent = `+${m}:${s}`;
      el.className = 'timer-badge timer-positive';
      wrapper.className = 'conversation-item sla-breach';
    }
  });
}

function updateConversationListItem(convId){
  const conv = activeConversations[convId];
  if(!conv) return;
  const row = document.querySelector(`[data-conv="${convId}"]`);
  if(!row) return;

  const tInfo = getConversationTimer(conv);
  const sInfo = getConversationStatus(conv);
  row.querySelector('.status-indicator').textContent = sInfo.status;
  row.querySelector('.status-indicator').style.color = sInfo.color;
  const timer = row.querySelector('.timer-badge');
  timer.textContent = tInfo.text;
  timer.className = 'timer-badge ' + tInfo.class;
  row.className = getConversationClass(conv) + ' conversation-item';
  
  const scoreBadge = row.querySelector('.live-score-badge');
  if(scoreBadge) {
    scoreBadge.textContent = conv.score;
    scoreBadge.style.background = conv.score >= 70 ? '#e74c3c' : conv.score >= 40 ? '#f39c12' : '#95a5a6';
  }
}

function showAllConversations(){
  currentListView = {type:'all', id:null};
  const list = document.getElementById('conversationsList');
  list.innerHTML = `
    <h3 style="margin-bottom:12px">💬 Active Conversations</h3>
    <div style="margin-bottom:10px;font-size:14px;color:#7f8c8d">Click on any conversation to manage</div>
    <div id="convList"></div>`;
  const container = list.querySelector('#convList');

  Object.values(activeConversations).forEach(c => container.appendChild(buildConversationRow(c)));

  Object.entries(legacySLAs).forEach(([id,t])=>{
    const wrap = document.createElement('div');
    wrap.className = 'conversation-item ' + (t.meta.status==='Warning'?'sla-warning':t.meta.status==='Breach'?'sla-breach':'');
    wrap.dataset.legacy = id;
    wrap.onclick = ()=>openSLAChat(id);
    const mm = !t.breached ? Math.floor(t.negative/60) : Math.floor(t.positive/60);
    const ss = (!t.breached ? t.negative%60 : t.positive%60).toString().padStart(2,'0');
    const sign = t.breached?'+':'-';
    const klass = t.breached?'timer-positive':'timer-negative';
    wrap.innerHTML = `
      <div style="display:flex;justify-content:space-between;align-items:start">
        <div><div><strong>${t.meta.title}</strong></div><div style="font-size:14px;color:#7f8c8d">${t.meta.area} • ALPS: ${t.meta.score}</div></div>
        <div style="text-align:right"><div class="status-indicator" style="font-size:12px">${t.meta.status}</div></div>
      </div>
      <div class="sla-timer"><div class="timer-badge ${klass}">${sign}${mm}:${ss}</div><div style="font-size:12px">${t.meta.status==='Breach'?'SLA breached':'Next response due'}</div></div>
      <div class="live-score-badge">${t.meta.score}</div>`;
    container.appendChild(wrap);
  });
}

function showAgentConversationsList(agentId){
  currentListView = {type:'agent', id:agentId};
  const list = document.getElementById('conversationsList');
  const name = AGENTS[agentId].name;
  const convs = agentConversations[agentId];

  list.innerHTML = `
    <h3 style="margin-bottom:12px">💬 ${name}'s Conversations</h3>
    <div style="margin-bottom:10px;font-size:14px;color:#7f8c8d">Active: ${convs.length} conversations</div>
    <button onclick="showAllConversations()" class="btn btn-primary" style="margin-bottom:10px">← Back to All Conversations</button>
    <div id="convList"></div>`;
  const container = list.querySelector('#convList');

  if(!convs.length){
    container.innerHTML = `<div style="text-align:center;color:#7f8c8d;margin-top:40px"><p>No active conversations</p></div>`;
    selectedConversation = null;
    document.getElementById('slaMessages').innerHTML = `<div style="text-align:center;color:#7f8c8d;margin-top:40px"><p>Select a conversation</p></div>`;
    document.getElementById('slaInputArea').style.display='none';
    return;
  }

  convs.forEach(c => container.appendChild(buildConversationRow(c)));
  const openFirst = !selectedConversation || !convs.some(c => c.id === selectedConversation);
  if(openFirst) openSLAChat(convs[0].id);
}

function buildConversationRow(conv){
  const el = document.createElement('div');
  el.className = getConversationClass(conv) + ' conversation-item';
  el.dataset.conv = conv.id;
  el.onclick = () => openSLAChat(conv.id);
  const s = getConversationStatus(conv);
  const t = getConversationTimer(conv);
  const scoreColor = conv.score >= 70 ? '#e74c3c' : conv.score >= 40 ? '#f39c12' : '#95a5a6';
  
  el.innerHTML = `
    <div style="display:flex;justify-content:space-between;align-items:start">
      <div><div><strong>Lead ${conv.leadNumber}</strong> • ${conv.agentName}</div><div style="font-size:14px;color:#7f8c8d">${conv.area} • ALPS: ${conv.score}</div></div>
      <div style="text-align:right"><div class="status-indicator" style="font-size:12px">${s.status}</div></div>
    </div>
    <div class="sla-timer"><div class="timer-badge ${t.class}">${t.text}</div><div style="font-size:12px">${t.description}</div></div>
    <div class="live-score-badge" style="background:${scoreColor}">${conv.score}</div>`;
  return el;
}

function openSLAChat(id){
  selectedConversation = id;

  if(activeConversations[id]){
    loadActiveConversation(activeConversations[id]);
    return;
  }

  // Legacy demo handling remains the same
  const l = {
    conv1:{title:'Lead #2024001 - Sarah Chen',details:'Mont Kiara • ALPS: 87 • Active for 12 mins',messages:[
      {type:'customer',text:"Hi, I'm looking for a room in Mont Kiara area",time:'14:32'},
      {type:'agent',text:'Hello! Happy to help. What\'s your budget?',time:'14:33'},
      {type:'customer',text:'Around RM1200. Need to move in within 3 days.',time:'14:34'},
      {type:'agent',text:'Great! I have several options. Sharing now…',time:'14:35'}
    ]},
    conv2:{title:'Lead #2024002 - Mike Johnson',details:'KL/Selangor • ALPS: 82 • Response overdue',messages:[
      {type:'customer',text:'Hello, I saw your KL listing.',time:'14:45'},
      {type:'agent',text:'Hi! Which area in KL?',time:'14:46'},
      {type:'customer',text:'Near public transport. Budget ~RM900',time:'14:47'}
    ]},
    conv3:{title:'Lead #2024003 - Lisa Wong',details:'Petaling Jaya • ALPS: 65 • SLA Breached',messages:[
      {type:'customer',text:'Hi, looking for accommodation in PJ',time:'14:52'},
      {type:'agent',text:'Sure! What type are you after?',time:'14:53'},
      {type:'customer',text:'Single room, RM750. When can I view?',time:'14:54'}
    ]},
    conv4:{title:'Lead #2024004 - In Queue',details:'JB/Penang • ALPS: 58 • Waiting',messages:[
      {type:'system',text:'Waiting for agent assignment',time:'--:--'}
    ]}
  }[id];

  if(!l) return;
  document.getElementById('slaCurrentChat').textContent = l.title;
  document.getElementById('slaCurrentDetails').textContent = l.details;
  const t = legacySLAs[id];
  const timerEl = document.getElementById('slaCurrentTimer');
  if(t){
    const m = (!t.breached ? Math.floor(t.negative/60) : Math.floor(t.positive/60));
    const s = (!t.breached ? t.negative%60 : t.positive%60).toString().padStart(2,'0');
    timerEl.textContent = `${t.breached?'+':'-'}${m}:${s}`;
    timerEl.style.background = t.breached?'rgba(231,76,60,.2)':'rgba(46,204,113,.2)';
  }
  const box = document.getElementById('slaMessages');
  box.innerHTML = '';
  l.messages.forEach(m=>{
    const d = document.createElement('div');
    d.className = 'message ' + (m.type==='customer'?'message-user':m.type==='system'?'message-system':'message-bot');
    d.innerHTML = `<div>${m.text}</div><div style="font-size:12px;color:#7f8c8d;margin-top:5px">${m.time}</div>`;
    box.appendChild(d);
  });
  box.scrollTop = box.scrollHeight;
  document.getElementById('slaInputArea').style.display = 'flex';
}

function loadActiveConversation(conv){
  document.getElementById('slaCurrentChat').textContent = `Lead ${conv.leadNumber} - ${conv.agentName}`;
  document.getElementById('slaCurrentDetails').textContent = `${conv.area} • ALPS: ${conv.score} • ${getStatusText(conv.status)}`;

  const info = getConversationTimer(conv);
  const tEl = document.getElementById('slaCurrentTimer');
  tEl.textContent = info.text;
  tEl.style.background = info.class === 'timer-positive' ? 'rgba(231,76,60,.2)' : 'rgba(46,204,113,.2)';

  const box = document.getElementById('slaMessages');
  box.innerHTML = '';
  conv.messages.forEach((m, index)=>{
    const div = document.createElement('div');
    const cls = m.type === 'customer' ? 'message-user' : (m.type === 'system' ? 'message-system' : 'message-bot');
    div.className = 'message ' + cls;
    div.style.position = 'relative';
    div.innerHTML = `<div>${m.text}</div><div style="font-size:12px;color:#7f8c8d;margin-top:5px">${m.time}</div>`;
    
    // Add score badge to customer messages
    if(m.type === 'customer' && m.score){
      const scoreBadge = document.createElement('div');
      scoreBadge.className = 'message-score';
      scoreBadge.textContent = m.score;
      div.appendChild(scoreBadge);
    }
    
    box.appendChild(div);
  });
  box.scrollTop = box.scrollHeight;
  document.getElementById('slaInputArea').style.display = 'flex';
}

function handleSLAMessage(e){ 
  if(e.key === 'Enter') sendSLAMessage(); 
}

function sendSLAMessage(){
  const input = document.getElementById('slaMessageInput');
  const text = input.value.trim(); 
  if(!text) return; 
  input.value = '';
  
  const box = document.getElementById('slaMessages');
  const d = document.createElement('div');
  d.className = 'message message-bot';
  d.innerHTML = `<div>${text}</div><div style="font-size:12px;color:#7f8c8d;margin-top:5px">${new Date().toLocaleTimeString()}</div>`;
  box.appendChild(d); 
  box.scrollTop = box.scrollHeight;

  const conv = activeConversations[selectedConversation];
  if(conv){
    conv.messages.push({type:'agent', text, time:new Date().toLocaleTimeString()});
    if(conv.status === 'waiting_agent_response'){
      conv.status = 'ongoing';
      conv.slaTimer = {type:'ongoing', timeRemaining:600, alertTriggered:false, overdue:0};
    } else {
      conv.slaTimer.timeRemaining = 600; 
      conv.slaTimer.alertTriggered = false; 
      conv.slaTimer.overdue = 0;
    }
    
    setTimeout(() => {
      const replies = ["Thanks! That helps.", "Great, what are next steps?", "I'm interested to view.", "Sounds good!", "Actually, I'm not interested anymore", "The price is too high", "I changed my mind"];
      const r = replies[Math.floor(Math.random() * replies.length)];
      const u = document.createElement('div');
      u.className = 'message message-user';
      u.style.position = 'relative';
      u.innerHTML = `<div>${r}</div><div style="font-size:12px;color:#7f8c8d;margin-top:5px">${new Date().toLocaleTimeString()}</div>`;
      
      // Calculate new score based on customer response
      const newScore = calculateScoreFromResponse(r, conv.score);
      const scoreBadge = document.createElement('div');
      scoreBadge.className = 'message-score';
      scoreBadge.textContent = newScore;
      u.appendChild(scoreBadge);
      
      box.appendChild(u); 
      box.scrollTop = box.scrollHeight;
      
      const customerMessage = {type:'customer', text:r, time:new Date().toLocaleTimeString(), score: newScore};
      conv.messages.push(customerMessage);
      conv.score = newScore;
      conv.slaTimer.timeRemaining = 600;
      
      // Check if AI should take over
      if(newScore < LOW_SCORE_THRESHOLD && conv.status !== 'ai_takeover'){
        setTimeout(() => aiTakeoverConversation(conv), 2000);
      }
      
      updateConversationListItem(conv.id);
      
    }, 1500);
  }
}

function calculateScoreFromResponse(response, currentScore){
  const negativeResponses = ["not interested", "too high", "changed my mind", "no thank you", "expensive"];
  const positiveResponses = ["interested", "good", "sounds good", "great", "perfect"];
  
  let scoreChange = 0;
  const lowerResponse = response.toLowerCase();
  
  for(const neg of negativeResponses){
    if(lowerResponse.includes(neg)){
      scoreChange = -Math.floor(Math.random() * 20) - 10; // -10 to -30
      break;
    }
  }
  
  if(scoreChange === 0){
    for(const pos of positiveResponses){
      if(lowerResponse.includes(pos)){
        scoreChange = Math.floor(Math.random() * 10) + 2; // +2 to +12
        break;
      }
    }
  }
  
  if(scoreChange === 0){
    scoreChange = Math.floor(Math.random() * 6) - 3; // -3 to +3
  }
  
  return Math.max(5, Math.min(100, currentScore + scoreChange));
}

function aiTakeoverConversation(conv){
  conv.status = 'ai_takeover';
  conv.previousAgentId = conv.agentId;
  conv.previousAgentName = conv.agentName;
  conv.agentName = 'AI Assistant';
  
  // Remove from agent's conversation list to free capacity
  const agentConvs = agentConversations[conv.agentId];
  const index = agentConvs.findIndex(c => c.id === conv.id);
  if(index !== -1) {
    agentConvs.splice(index, 1);
  }
  
  // Add AI takeover message
  const aiMessage = {
    type: 'system',
    text: `🤖 AI Assistant has taken over this conversation due to low engagement score (${conv.score}). Agent capacity freed.`,
    time: new Date().toLocaleTimeString()
  };
  conv.messages.push(aiMessage);
  
  // Update lead status in database
  const leadIndex = allLeadsDatabase.findIndex(l => l.leadNumber === conv.leadNumber);
  if(leadIndex !== -1){
    allLeadsDatabase[leadIndex].status = 'ai_takeover';
    allLeadsDatabase[leadIndex].agent = 'AI Assistant';
    allLeadsDatabase[leadIndex].score = conv.score;
  }
  
  // If conversation is currently open, refresh it
  if(selectedConversation === conv.id) {
    const box = document.getElementById('slaMessages');
    const div = document.createElement('div');
    div.className = 'message message-ai-takeover';
    div.innerHTML = `<div>${aiMessage.text}</div><div style="font-size:12px;color:#7f8c8d;margin-top:5px">${aiMessage.time}</div>`;
    box.appendChild(div);
    box.scrollTop = box.scrollHeight;
    
    loadActiveConversation(conv);
  }
  
  showNotification(`AI takeover: Lead ${conv.leadNumber} (Score: ${conv.score})`, 'warning');
  refreshCurrentListView();
}

function reassignToNextAgent(conv){
  const next = getNextAvailableAgent();
  
  // Remove from current agent's list
  const arr = agentConversations[conv.agentId];
  const ix = arr.findIndex(c => c.id === conv.id);
  if(ix > -1) arr.splice(ix, 1);

  if(next){
    conv.agentId = next.id;
    conv.agentName = next.name;
    conv.assignedTime = new Date();
    conv.status = 'waiting_agent_response';
    conv.slaTimer = {type:'initial', timeRemaining:INITIAL_RESPONSE_TIMEOUT, alertTriggered:false, overdue:0};
    agentConversations[next.id].push(conv);
    conv.messages.push({type:'system', text:`Conversation reassigned to ${next.name} due to initial response timeout.`, time:new Date().toLocaleTimeString()});

    if(selectedConversation === conv.id) loadActiveConversation(conv);
    refreshCurrentListView();
    showNotification(`Lead ${conv.leadNumber} reassigned to ${next.name}`, 'warning');
  } else {
    conv.status = 'unassigned';
    conv.slaTimer.overdue++;
    showNotification(`No agent available for Lead ${conv.leadNumber}`, 'error');
  }
}

function escalateConversation(){
  if(!selectedConversation) return;
  const box = document.getElementById('slaMessages');
  const div = document.createElement('div');
  div.className = 'message message-system';
  div.innerHTML = `<div><strong>Conversation Escalated</strong></div><div>Supervisor will take over.</div><div style="font-size:12px;color:#7f8c8d;margin-top:5px">${new Date().toLocaleTimeString()}</div>`;
  box.appendChild(div); 
  box.scrollTop = box.scrollHeight;
  alert('Escalated. Supervisor will take over soon.');
}

function refreshCurrentListView(){
  syncAgentCapacitiesToConversations();
  if(currentListView.type === 'all') showAllConversations();
  if(currentListView.type === 'agent') showAgentConversationsList(currentListView.id);
}

function getConversationClass(conv){
  if(!conv.slaTimer) return 'conversation-item';
  if(conv.slaTimer.type === 'initial' && conv.slaTimer.timeRemaining <= 60) return 'sla-warning';
  if(conv.slaTimer.overdue > 0) return 'sla-breach';
  return '';
}

function getConversationStatus(conv){
  if(!conv.slaTimer) return {status:'✅ Active', color:'#2ecc71'};
  if(conv.status === 'waiting_agent_response') return {status:'⏳ Waiting', color:'#f39c12'};
  if(conv.status === 'ai_takeover') return {status:'🤖 AI Handling', color:'#3498db'};
  if(conv.slaTimer.overdue > 0) return {status:'🚨 Breach', color:'#e74c3c'};
  if(conv.slaTimer.alertTriggered) return {status:'⚠️ Alert', color:'#f39c12'};
  return {status:'✅ Active', color:'#2ecc71'};
}

function getConversationTimer(conv){
  if(!conv.slaTimer) return {text:'--:--', class:'timer-negative', description:'No timer'};
  const t = conv.slaTimer;
  if(t.overdue > 0){
    const m = Math.floor(t.overdue/60);
    const s = (t.overdue % 60).toString().padStart(2,'0');
    return {text:`+${m}:${s}`, class:'timer-positive', description:t.type==='initial'?'Initial response overdue':'Response overdue'};
  }
  if(t.timeRemaining > 0){
    const m = Math.floor(t.timeRemaining/60);
    const s = (t.timeRemaining % 60).toString().padStart(2,'0');
    return {text:`-${m}:${s}`, class:'timer-negative', description:t.type==='initial'?'Initial response due':'Next response due'};
  }
  return {text:'0:00', class:'timer-negative', description:'Timer expired'};
}

function getStatusText(s){
  return s === 'waiting_agent_response' ? 'Waiting for agent response' :
         s === 'ongoing' ? 'Ongoing conversation' :
         s === 'assigned' ? 'Assigned to agent' :
         s === 'ai_takeover' ? 'AI handling' :
         s === 'in_queue' ? 'In queue' :
         s === 'unassigned' ? 'Unassigned' : 'Active';
}

/* ======= ALERT ======= */
let alertInterval = null;
function showSlaAlert(convId){
  lastAlertConvId = convId;
  const c = activeConversations[convId];
  document.getElementById('alertConversation').textContent = `Lead ${c.leadNumber}`;
  document.getElementById('alertAgent').textContent = c.agentName;
  let secs = 1;
  const timeEl = document.getElementById('alertTime');
  clearInterval(alertInterval);
  alertInterval = setInterval(() => { 
    secs++; 
    const m = Math.floor(secs/60);
    const s = (secs % 60).toString().padStart(2,'0'); 
    timeEl.textContent = `+${m}:${s}`;
  }, 1000);
  document.getElementById('slaAlert').style.display = 'block';
}

function goToConversation(){
  document.getElementById('slaAlert').style.display = 'none';
  if(lastAlertConvId){
    switchPage('sla');
    setTimeout(() => openSLAChat(lastAlertConvId), 200);
  }
}

function reassignConversation(){
  document.getElementById('slaAlert').style.display = 'none';
  if(lastAlertConvId && activeConversations[lastAlertConvId]){
    reassignToNextAgent(activeConversations[lastAlertConvId]);
  }
}

/* ======= CHART MODAL ======= */
function showLeadChart(leadId){
  const lead = allLeadsDatabase.find(l => l.id === leadId) || completedLeads.find(l => l.id === leadId);
  if(!lead) return;
  
  const data = buildLeadChartData(lead);
  document.getElementById('chartTitle').textContent = `${data.name} - Score Progression`;
  document.getElementById('chartModal').style.display = 'block';
  setTimeout(() => { 
    createLeadChart(data); 
    updateChartDetails(data); 
  }, 50);
}

function buildLeadChartData(lead){
  if(lead.responses && Object.keys(lead.responses).length > 0){
    const scores = [0]; 
    let cur = 0;
    questions.forEach(q => {
      const r = lead.responses[q.id]; 
      if(!r) return;
      let inc = 0;
      if(q.id === 'area' || q.id === 'property') inc = q.weight;
      else if(q.id === 'budget'){ 
        const b = parseInt(r); 
        inc = b >= 800 ? q.weight : b >= 600 ? q.weight * 0.7 : b >= 400 ? q.weight * 0.4 : q.weight * 0.1; 
      }
      else if(q.id === 'movein'){ 
        const d = new Date(r);
        const t = new Date();
        const diff = Math.ceil((d - t) / (1000 * 60 * 60 * 24)); 
        inc = diff <= 7 ? q.weight : diff <= 30 ? q.weight * 0.8 : diff <= 60 ? q.weight * 0.6 : q.weight * 0.3; 
      }
      else if(q.id === 'nationality'){ 
        inc = r === 'Malaysian' ? q.weight * 0.8 : q.weight; 
      }
      else inc = q.weight * 0.8;
      cur = Math.min(100, cur + inc); 
      scores.push(Math.round(cur));
    });
    return {
      name: `Lead ${lead.leadNumber}`,
      scores, 
      messages: ['Start','Area','Property','Budget','Pax','Car','Move-in','Tenancy','Gender','Unit','Workplace','Nationality','Final'], 
      details: `${lead.area} • Budget: RM${lead.budget} • Move-in: ${lead.movein} • Status: ${getLeadStatusText(lead.status)}`
    };
  }
  
  const progression = [0, 15, 25, 40, 50, 60, Math.min(100, lead.score)];
  return {
    name: `Lead ${lead.leadNumber}`,
    scores: progression,
    messages: ['Start','Area','Property','Budget','Contact','Final'],
    details: `${lead.area} • Budget: RM${lead.budget} • Move-in: ${lead.movein} • Status: ${getLeadStatusText(lead.status)}`
  };
}

function createLeadChart(d){
  const ctx = document.getElementById('leadChart').getContext('2d');
  if(leadChart) leadChart.destroy();
  leadChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: d.messages,
      datasets: [{
        label: 'ALPS Score',
        data: d.scores,
        borderColor: '#3498db',
        backgroundColor: 'rgba(52,152,219,.1)',
        borderWidth: 3,
        fill: true,
        tension: 0.4,
        pointBackgroundColor: '#3498db',
        pointBorderColor: '#fff',
        pointBorderWidth: 2,
        pointRadius: 5
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { display: false }
      },
      scales: {
        y: { beginAtZero: true, max: 100 }
      }
    }
  });
}

function updateChartDetails(d){
  const final = d.scores[d.scores.length - 1];
  let cat = 'Cold Lead', color = '#95a5a6';
  if(final >= 70){ cat = 'Hot Lead'; color = '#e74c3c'; } 
  else if(final >= 40){ cat = 'Warm Lead'; color = '#f39c12'; }
  
  document.getElementById('chartDetails').innerHTML = `
    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:14px">
      <div style="background:#f8f9fa;padding:12px;border-radius:10px">
        <h4>Final Score</h4>
        <div style="font-size:22px;font-weight:800;color:${color}">${final}/100</div>
        <div style="color:${color};font-weight:700">${cat}</div>
      </div>
      <div style="background:#f8f9fa;padding:12px;border-radius:10px">
        <h4>Score Range</h4>
        <div>Min: ${Math.min(...d.scores)}</div>
        <div>Max: ${Math.max(...d.scores)}</div>
        <div>Growth: +${final - d.scores[0]}</div>
      </div>
      <div style="background:#f8f9fa;padding:12px;border-radius:10px">
        <h4>Details</h4>
        <div style="font-size:14px">${d.details}</div>
      </div>
    </div>`;
}

function closeModal(){ 
  document.getElementById('chartModal').style.display = 'none'; 
  if(leadChart){ leadChart.destroy(); leadChart = null; } 
}

/* ======= CHAT / ALPS ======= */
function initializeChat(){
  chatCurrentStep = 0; 
  chatUserResponses = {}; 
  chatAlpsScore = 0;
  const box = document.getElementById('chatMessages');
  box.innerHTML = `<div class="typing-indicator" id="typingIndicator"><div class="typing-dots"><div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div></div></div>`;
  updateChatScoreDisplay();
  setTimeout(() => askQuestion(0), 400);
}

function askQuestion(i){
  if(i >= questions.length){ return finalizeLead(); }
  const q = questions[i]; 
  chatCurrentStep = i; 
  showTyping();
  setTimeout(() => {
    hideTyping();
    let html = `<div>${q.text}</div>`;
    if(q.type === 'select'){
      html += `<div class="options-container">` +
        q.options.map(o => `<div class="option-button" onclick="selectOption('${q.id}','${o.replace(/'/g,"\\'")}')">${o}</div>`).join('') +
        `</div>`;
    } else if(q.type === 'property_select'){
      const props = getPropertiesForArea(chatUserResponses.area || 'KL/Selangor').slice(0, 12);
      html += `<div class="property-grid">` + 
        props.map(p => `<div class="property-item" onclick="selectOption('${q.id}','${p.replace(/'/g,"\\'")}')">${p}</div>`).join('') + 
        `</div>`;
    } else if(q.type === 'input'){
      html += `<input class="input-field" type="text" placeholder="${q.placeholder}" onkeypress="handleInputKeypress(event,'${q.id}')">`;
    } else if(q.type === 'date'){
      html += `<input class="input-field" type="date" onchange="handleDateChange(event,'${q.id}')">`;
    } else if(q.type === 'multiple'){
      html += createMultipleChoiceOptions(q.id, q.options);
    }
    addMessage(html, 'bot');
  }, 600);
}

function createMultipleChoiceOptions(id, opts){
  let c = `<div class="checkbox-group" id="checkboxGroup_${id}">`;
  opts.forEach((o, idx) => {
    const oid = `${id}_${idx}`;
    c += `<div class="checkbox-item" data-option-id="${oid}" onclick="toggleMultipleChoice('${oid}','${id}')">
            <input type="checkbox" id="${oid}" value="${o}">
            <label for="${oid}">${o}</label>
          </div>`;
  });
  c += `<button class="continue-btn" onclick="submitMultipleChoice('${id}')">Continue</button></div>`;
  return c;
}

function toggleMultipleChoice(oid, id){ 
  const cb = document.getElementById(oid); 
  const item = document.querySelector(`[data-option-id="${oid}"]`); 
  cb.checked = !cb.checked; 
  item.classList.toggle('selected', cb.checked); 
}

function submitMultipleChoice(id){
  const vals = [...document.querySelectorAll(`#checkboxGroup_${id} input[type="checkbox"]:checked`)].map(cb => cb.value);
  if(!vals.length) return alert('Please select at least one option');
  chatUserResponses[id] = vals; 
  addMessage(vals.join(', '), 'user');
  recalcScoreAndAdvance(id, vals);
}

function selectOption(id, val){
  if(id === 'nationality' && val === 'Others'){
    chatUserResponses[id] = val;
    addMessage(val, 'user');
    addMessage(`<div>Please specify your nationality:</div><input class="input-field" type="text" placeholder="e.g., Filipino, Iranian" onkeypress="handleInputKeypress(event,'nationality_other')">`, 'bot');
    return;
  }
  chatUserResponses[id] = val; 
  addMessage(val, 'user');
  recalcScoreAndAdvance(id, val);
}

function handleInputKeypress(e, id){ 
  if(e.key === 'Enter'){ 
    const v = e.target.value.trim(); 
    if(!v) return; 
    if(id === 'nationality_other'){ 
      chatUserResponses['nationality_detail'] = v; 
      addMessage(v, 'user'); 
      recalcScoreAndAdvance('nationality_detail', v); 
    } else { 
      selectOption(id, v); 
    } 
  } 
}

function handleDateChange(e, id){ 
  const v = e.target.value; 
  if(v) selectOption(id, v); 
}

function recalcScoreAndAdvance(lastId, val){
  recomputeScoreFromFeatures({...chatUserResponses}).then(score => {
    chatAlpsScore = Math.max(0, Math.min(100, score));
    updateChatScoreDisplay();
    setTimeout(() => askQuestion(chatCurrentStep + 1), 400);
  });
}

function updateChatScoreDisplay(){
  const bar = document.getElementById('chatScoreBar');
  const text = document.getElementById('chatScoreText');
  const cat = document.getElementById('chatScoreCategory');
  const pct = Math.min(chatAlpsScore, 100);
  bar.style.width = pct + '%';
  bar.className = 'score-fill ' + (chatAlpsScore >= 70 ? 'score-hot' : chatAlpsScore >= 40 ? 'score-warm' : 'score-cold');
  text.textContent = `${Math.round(chatAlpsScore)} / 100`;
  cat.textContent = chatAlpsScore >= 70 ? 'Hot Lead' : chatAlpsScore >= 40 ? 'Warm Lead' : 'Cold Lead';
}

function getPropertiesForArea(area){ 
  return PROPERTIES; 
}

function recomputeScoreFromFeatures(features){
  if(MODEL_SOURCE === 'server'){
    return fetch(SCORE_ENDPOINT, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(features)
    })
    .then(r => r.json())
    .then(d => Number(d.score) || 0)
    .catch(() => heuristicScore(features));
  }
  return Promise.resolve(heuristicScore(features));
}

function heuristicScore(f){
  let score = 0;
  if(f.area) score += 15;
  if(f.property) score += 10;
  if(f.budget){ 
    const b = parseInt(f.budget) || 0; 
    score += b >= 800 ? 25 : b >= 600 ? 18 : b >= 400 ? 10 : 3; 
  }
  if(f.pax) score += 8;
  if(f.car) score += 4;
  if(f.parking) score += 4;
  if(f.movein){ 
    const d = new Date(f.movein);
    const t = new Date();
    const diff = Math.ceil((d - t) / (1000 * 60 * 60 * 24)); 
    score += diff <= 7 ? 20 : diff <= 30 ? 16 : diff <= 60 ? 12 : 6; 
  }
  if(f.tenancy) score += 4;
  if(f.unit_spec) score += 4;
  if(f.workplace) score += 8;
  if(f.gender) score += 0;
  if(f.nationality === 'Malaysian') score += 6;
  if(f.nationality === 'Others'){ 
    score += 4; 
    if(f.nationality_detail) score += 2; 
  }
  return Math.max(0, Math.min(100, Math.round(score)));
}

function finalizeLead(){
  showTyping();
  setTimeout(() => {
    hideTyping();
    const newLead = {
      id: `lead${nextLeadId}`,
      leadNumber: `#${nextLeadId}`,
      score: Math.round(chatAlpsScore),
      area: chatUserResponses.area || 'KL/Selangor',
      budget: chatUserResponses.budget || 'Not specified',
      movein: chatUserResponses.movein || 'Not specified',
      property: chatUserResponses.property || 'Not specified',
      responses: {...chatUserResponses},
      timestamp: new Date(),
      status: 'pending_assignment'
    };

    if(chatAlpsScore >= 60){
      addMessage(`<div style="background:#e8f5e8;padding:12px;border-radius:12px;border-left:4px solid #2ecc71"><h3>High Priority Lead Detected!</h3><p><strong>Your ALPS Score: ${Math.round(chatAlpsScore)}/100</strong></p><p>This lead will be routed to our top sales agent for immediate attention.</p><p>Routing to agent now...</p></div>`, 'bot');
      setTimeout(() => routeLeadToAgent(newLead), 900);
    } else {
      addMessage(`<div style="background:#fff8e1;padding:12px;border-radius:12px;border-left:4px solid #f39c12"><h3>Lead Information Collected</h3><p><strong>ALPS Score: ${Math.round(chatAlpsScore)}/100</strong></p><p>Our AI will continue to assist you.</p></div>`, 'bot');
      newLead.agent = 'AI Bot';
      newLead.status = 'ai_handling';
      allLeadsDatabase.push(newLead);
    }
    nextLeadId++;
  }, 400);
}

function routeLeadToAgent(lead){
  const best = getNextAvailableAgent();
  if(best){
    const bestName = best.name;
    lead.agent = bestName; 
    lead.agentId = best.id; 
    lead.status = 'assigned';

    const convId = `conv_${lead.id}`;
    const conv = {
      id: convId, 
      leadId: lead.id, 
      leadNumber: lead.leadNumber,
      agentId: best.id, 
      agentName: bestName,
      score: lead.score, 
      area: lead.area, 
      budget: lead.budget,
      status: 'waiting_agent_response', 
      assignedTime: new Date(),
      messages: [{
        type: 'system',
        text: `Lead ${lead.leadNumber} has been assigned to you. Area: ${lead.area}, Budget: ${lead.budget}, Move-in: ${lead.movein}`,
        time: new Date().toLocaleTimeString()
      }],
      slaTimer: {type: 'initial', timeRemaining: INITIAL_RESPONSE_TIMEOUT, alertTriggered: false, overdue: 0}
    };

    allLeadsDatabase.push(lead);
    addToSLAMonitoring(conv);

    setTimeout(() => addMessage(`<div style="background:#e3f2fd;padding:12px;border-radius:12px;border-left:4px solid #2196f3"><h3>Lead Successfully Routed!</h3><p><strong>Assigned to:</strong> ${bestName}</p><p><strong>Lead ID:</strong> ${lead.leadNumber}</p><p>Our agent will contact you shortly!</p></div>`, 'bot'), 500);
  } else {
    lead.status = 'in_queue'; 
    lead.agent = 'In Queue';
    allLeadsDatabase.push(lead);
    addMessage(`<div style="background:#fff3e0;padding:12px;border-radius:12px;border-left:4px solid #ff9800"><h3>Added to Priority Queue</h3><p>All agents are currently busy. You've been added to our priority queue.</p><p>Estimated wait time: 3–5 minutes</p></div>`, 'bot');
  }
}

function addToSLAMonitoring(conversation){
  activeConversations[conversation.id] = conversation;
  agentConversations[conversation.agentId].push(conversation);
  refreshCurrentListView();
}

/* ======= UTIL ======= */
function addMessage(html, who){ 
  const box = document.getElementById('chatMessages'); 
  const d = document.createElement('div'); 
  d.className = 'message message-' + who; 
  d.innerHTML = html; 
  box.appendChild(d); 
  box.scrollTop = box.scrollHeight; 
}

function showTyping(){ 
  const el = document.getElementById('typingIndicator'); 
  if(el){
    el.style.display = 'block'; 
    document.getElementById('chatMessages').scrollTop = document.getElementById('chatMessages').scrollHeight;
  } 
}

function hideTyping(){ 
  const el = document.getElementById('typingIndicator'); 
  if(el) el.style.display = 'none'; 
}

function showNotification(msg, type = 'info'){
  const n = document.createElement('div');
  n.style.cssText = "position:fixed;top:20px;right:20px;padding:14px 18px;border-radius:8px;color:#fff;font-weight:700;z-index:1200;max-width:320px;box-shadow:0 8px 18px rgba(0,0,0,.2)";
  n.style.background = type === 'success' ? '#2ecc71' : type === 'warning' ? '#f39c12' : type === 'error' ? '#e74c3c' : '#3498db';
  n.textContent = msg; 
  document.body.appendChild(n); 
  setTimeout(() => n.remove(), 3000);
}

/* ======= QUEUE DRAG ======= */
function initializeDragAndDrop(){
  const list = document.getElementById('queueList');
  let dragged = null;
  
  list.addEventListener('dragstart', e => { 
    if(e.target.classList.contains('queue-item')){ 
      dragged = e.target; 
      e.target.style.opacity = '.5'; 
    }
  });
  
  list.addEventListener('dragend', e => { 
    if(e.target.classList.contains('queue-item')) e.target.style.opacity = ''; 
  });
  
  list.addEventListener('dragover', e => e.preventDefault());
  
  list.addEventListener('drop', e => {
    e.preventDefault();
    const t = e.target.closest('.queue-item');
    if(dragged && t && t !== dragged){
      const rect = t.getBoundingClientRect(); 
      const mid = rect.top + rect.height / 2;
      if(e.clientY < mid) list.insertBefore(dragged, t); 
      else list.insertBefore(dragged, t.nextSibling);
      updateQueuePositions();
    }
    dragged = null;
  });
}

function updateQueuePositions(){
  const items = [...document.querySelectorAll('#queueList .queue-item')];
  agentOrder.length = 0;
  items.forEach((it, i) => { 
    it.querySelector('.position-text').textContent = `Position: ${i + 1}`; 
    it.dataset.position = i + 1; 
    agentOrder.push(it.dataset.agent); 
  });
  
  // Update top sales designation automatically
  agentOrder.forEach((agentId, i) => {
    if(i === 0) {
      AGENTS[agentId].role = 'Top Sales Agent';
    } else {
      AGENTS[agentId].role = 'Agent';
    }
  });
  
  renderAgentsGrid(); 
  renderQueueFromAgents();
  syncAgentCapacitiesToConversations();
}

/* ======= SEED DEMO DATA ======= */
function seedDemoConversations(){
  const demo = [
    {agent: 'agent1', area: 'Mont Kiara', score: 87, leadNum: '#2024001'},
    {agent: 'agent2', area: 'KL/Selangor', score: 82, leadNum: '#2024002'},
    {agent: 'agent2', area: 'KL/Selangor', score: 78, leadNum: '#2024005'},
    {agent: 'agent3', area: 'Negeri Sembilan', score: 76, leadNum: '#2024006'}
  ];
  
  demo.forEach((d, i) => {
    const id = `conv_demo_${i}`;
    const conv = {
      id, 
      leadId: id, 
      leadNumber: d.leadNum,
      agentId: d.agent, 
      agentName: AGENTS[d.agent].name,
      score: d.score, 
      area: d.area, 
      budget: 800,
      status: 'waiting_agent_response',
      assignedTime: new Date(),
      messages: [{
        type: 'system',
        text: `Lead ${d.leadNum} has been assigned to you. Area: ${d.area}, Budget: 800, Move-in: ${new Date().toISOString().slice(0,10)}`,
        time: new Date().toLocaleTimeString()
      }],
      slaTimer: {type: 'initial', timeRemaining: INITIAL_RESPONSE_TIMEOUT, alertTriggered: false, overdue: 0}
    };
    addToSLAMonitoring(conv);
  });
}

/* ======= CLICK OUTSIDE ======= */
window.addEventListener('click', e => {
  const modal = document.getElementById('chartModal');
  if(e.target === modal) closeModal();
  const alertBox = document.getElementById('slaAlert');
  if(e.target === alertBox) alertBox.style.display = 'none';
});

/* ======= AGENT PAGE SHORTCUT ======= */
function goToAgentConversations(agentId){
  switchPage('sla');
  setTimeout(() => showAgentConversationsList(agentId), 150);
}
</script>
</body>
</html>






