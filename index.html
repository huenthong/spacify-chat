<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>BeLive ALPS Management Dashboard</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<style>
  :root{
    --bg:#f5f6fa; --card:#fff; --muted:#7f8c8d; --border:#ecf0f1;
    --primary:#3498db; --accent:#25D366; --warn:#f39c12; --danger:#e74c3c; --ok:#2ecc71; --ink:#2c3e50;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--ink);height:100vh;overflow:hidden}
  .dashboard{display:flex;height:100vh}
  /* SIDEBAR */
  .sidebar{width:280px;background:#2c3e50;color:#fff;padding:20px;overflow-y:auto}
  .sidebar h2{margin-bottom:24px}
  .nav-item{display:flex;gap:10px;align-items:center;padding:12px 14px;border-radius:10px;cursor:pointer;transition:.2s}
  .nav-item:hover,.nav-item.active{background:#34495e;transform:translateX(4px)}
  .nav-icon{font-size:20px}
  .live-indicator{display:inline-flex;gap:6px;align-items:center;background:var(--danger);color:#fff;font-weight:700;border-radius:999px;padding:6px 10px;font-size:12px}
  .pulse-dot{width:8px;height:8px;border-radius:50%;background:#fff;animation:pulse 2s infinite}
  @keyframes pulse{0%{opacity:1}50%{opacity:.5}100%{opacity:1}}
  /* MAIN */
  .main{flex:1;display:flex;flex-direction:column;overflow:hidden}
  .header{background:#fff;padding:18px 22px;display:flex;align-items:center;justify-content:space-between;box-shadow:0 2px 10px rgba(0,0,0,.06)}
  .content{flex:1;overflow:auto;padding:20px}
  .page{display:none}
  .page.active{display:block}
  /* AGENTS */
  .agents-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:18px;margin-bottom:20px}
  .agent-card{background:#fff;border-radius:14px;padding:16px;box-shadow:0 6px 18px rgba(0,0,0,.08);border-left:5px solid var(--primary);cursor:pointer;transition:.2s}
  .agent-card:hover{transform:translateY(-3px)}
  .agent-card.available{border-left-color:var(--ok)}
  .agent-card.busy{border-left-color:var(--danger)}
  .agent-card.away{border-left-color:#95a5a6}
  .agent-card.top-sales{border-left-color:var(--warn);background:linear-gradient(135deg,#fff9e6 0,#fff 60%)}
  .agent-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
  .agent-name{font-weight:700}
  .agent-status{font-size:12px;font-weight:700;border-radius:999px;padding:4px 10px;color:#fff}
  .status-available{background:var(--ok)}
  .status-busy{background:var(--danger)}
  .status-away{background:var(--warn)}
  .capacity-bar{height:10px;background:#eef2f4;border-radius:999px;overflow:hidden;margin:10px 0}
  .capacity-fill{height:100%;transition:width .4s;border-radius:999px}
  .capacity-low{background:var(--ok)} .capacity-medium{background:var(--warn)} .capacity-high{background:var(--danger)}
  .queue{background:#fff;border-radius:14px;box-shadow:0 6px 18px rgba(0,0,0,.08);padding:18px}
  .queue-item{display:flex;justify-content:space-between;align-items:center;background:#f7f9fb;border-left:4px solid var(--primary);padding:14px;border-radius:12px;margin:10px 0;cursor:move}
  .drag{color:#98a2ad;font-size:18px}
  /* LEADS */
  .leads{display:grid;grid-template-columns:1fr 1fr;gap:20px}
  .panel{background:#fff;border-radius:14px;box-shadow:0 6px 18px rgba(0,0,0,.08);padding:18px;display:flex;flex-direction:column;min-height:300px}
  .panel .top{display:flex;justify-content:space-between;align-items:center;border-bottom:2px solid var(--border);padding-bottom:10px;margin-bottom:12px}
  .leads-list{overflow:auto}
  .lead-item{display:flex;gap:14px;align-items:center;background:#f7f9fb;border-left:4px solid #95a5a6;border-radius:12px;padding:12px;margin:10px 0;cursor:pointer;transition:.15s}
  .lead-item:hover{transform:translateX(4px)}
  .lead-item.hot{border-left-color:var(--danger);background:linear-gradient(135deg,#ffebee 0,#f7f9fb 60%)}
  .lead-item.warm{border-left-color:var(--warn);background:linear-gradient(135deg,#fff8e1 0,#f7f9fb 60%)}
  .lead-score{width:56px;height:56px;border-radius:50%;font-weight:700;color:#fff;display:grid;place-items:center}
  .score-hot{background:linear-gradient(135deg,#e74c3c,#c0392b)}
  .score-warm{background:linear-gradient(135deg,#f39c12,#e67e22)}
  .score-cold{background:linear-gradient(135deg,#95a5a6,#7f8c8d)}
  .lead-name{font-weight:700}
  .lead-details{font-size:13px;color:var(--muted)}
  .lead-timestamp{font-size:12px;color:#b7c0c7}
  /* CHAT */
  .chat-wrap{background:#fff;border-radius:14px;box-shadow:0 6px 18px rgba(0,0,0,.08);overflow:hidden;position:relative}
  .chat-header{background:var(--accent);color:#fff;padding:18px}
  .chat-messages{height:520px;overflow:auto;background:#e5ddd5;padding:18px}
  .msg{max-width:70%;padding:12px 16px;border-radius:16px;margin:10px 0;box-shadow:0 1px 2px rgba(0,0,0,.06)}
  .bot{background:#fff;margin-right:auto;border-bottom-left-radius:4px}
  .user{background:#DCF8C6;margin-left:auto;border-bottom-right-radius:4px}
  .sys{background:#fff3cd;border:2px solid #ffe08a;margin:8px auto;text-align:center;max-width:90%}
  .options{display:flex;flex-direction:column;gap:8px;margin-top:8px}
  .opt-btn{padding:12px 16px;background:#f0f0f0;border:2px solid #e0e0e0;border-radius:20px;text-align:center;cursor:pointer;transition:.15s}
  .opt-btn:hover{background:var(--accent);border-color:var(--accent);color:#fff}
  .check-group{display:flex;flex-direction:column;gap:8px;margin-top:8px}
  .check-item{display:flex;align-items:center;gap:10px;padding:10px 14px;border:2px solid #e0e0e0;background:#f8f9fa;border-radius:16px;cursor:pointer;transition:.15s}
  .check-item:hover{border-color:var(--primary);background:#eaf3fe}
  .check-item input{transform:scale(1.2)}
  .continue{align-self:flex-start;margin-top:6px;padding:10px 18px;border:none;border-radius:999px;background:var(--accent);color:#fff;font-weight:700;cursor:pointer}
  /* Floating ALPS card */
  .alps-card{position:fixed; right:24px; top:110px; width:260px; background:#fff; border-radius:14px; box-shadow:0 12px 28px rgba(0,0,0,.12); padding:16px; z-index:999; display:none}
  .alps-bar{height:14px;background:#ececec;border-radius:999px;overflow:hidden;margin:8px 0}
  .alps-fill{height:100%;border-radius:999px;transition:width .4s}
  .fill-cold{background:linear-gradient(90deg,#95a5a6,#7f8c8d)}
  .fill-warm{background:linear-gradient(90deg,#f39c12,#e67e22)}
  .fill-hot{background:linear-gradient(90deg,#e74c3c,#c0392b)}
  /* SLA */
  .sla-grid{display:grid;grid-template-columns:1fr 2fr;gap:18px}
  .conv-list,.sla-chat{background:#fff;border-radius:14px;box-shadow:0 6px 18px rgba(0,0,0,.08)}
  .conv-list{padding:18px;overflow:auto}
  .conv{padding:14px;border-radius:12px;background:#f7f9fb;border-left:4px solid var(--primary);margin:10px 0;cursor:pointer}
  .conv:hover{background:#eaf3fe}
  .conv.warn{border-left-color:var(--warn);background:#fff8e1}
  .conv.breach{border-left-color:var(--danger);background:#ffebee}
  .sla-row{display:flex;justify-content:space-between;align-items:flex-start}
  .sla-pill{padding:6px 10px;border-radius:999px;font-weight:700;font-size:12px;color:#fff}
  .neg{background:var(--warn)} .pos{background:var(--danger)}
  .sla-chat-head{display:flex;justify-content:space-between;align-items:center;background:#1f3b53;color:#fff;padding:18px;border-radius:14px 14px 0 0}
  .sla-chat-body{height:460px;overflow:auto;padding:18px;background:#f8f9fa}
  .sla-input{display:flex;gap:10px;padding:18px;border-top:1px solid var(--border)}
  .sla-input input{flex:1;border:2px solid var(--border);border-radius:24px;padding:12px}
  .sla-input button{border:none;border-radius:24px;padding:12px 18px;color:#fff;background:var(--accent);cursor:pointer}
  .btn-danger{background:var(--danger)}
  /* Modal Alert */
  .alert{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;z-index:1000}
  .alert-card{width:min(540px,92vw);background:#fff;border-left:6px solid var(--danger);border-radius:14px;padding:18px 18px 22px;box-shadow:0 18px 40px rgba(0,0,0,.25)}
  .alert-head{font-weight:800;font-size:22px;margin-bottom:6px}
  .alert-box{background:#fff8cf;border:2px solid #ffe08a;border-radius:10px;padding:12px 14px;margin:10px 0}
  .alert-actions{display:flex;gap:10px;justify-content:center;margin-top:10px}
  /* Modal lead chart */
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;z-index:800}
  .modal-card{width:min(880px,94vw);background:#fff;border-radius:14px;padding:18px;box-shadow:0 16px 36px rgba(0,0,0,.35)}
  .close{float:right;font-size:26px;cursor:pointer}
  @media (max-width:900px){
    .alps-card{display:none!important}
    .sla-grid{grid-template-columns:1fr}
  }
</style>
</head>
<body>
  <div class="dashboard">
    <!-- SIDEBAR -->
    <aside class="sidebar">
      <h2>üè† BeLive ALPS</h2>
      <div class="nav-item active" data-page="agents"><span class="nav-icon">üë•</span><span>Agent Status</span></div>
      <div class="nav-item" data-page="leads"><span class="nav-icon">üìä</span><span>Lead Management</span></div>
      <div class="nav-item" data-page="chat"><span class="nav-icon">üí¨</span><span>Chat Window</span></div>
      <div class="nav-item" data-page="sla"><span class="nav-icon">‚è±Ô∏è</span><span>SLA Monitoring</span></div>
      <div style="margin-top:40px;background:rgba(255,255,255,.1);border-radius:12px;padding:14px">
        <div class="live-indicator"><div class="pulse-dot"></div>LIVE</div>
        <div style="margin-top:8px;font-size:13px">
          System Status: Active<br/>Last Update: <span id="lastUpdate">--:--:--</span>
        </div>
      </div>
    </aside>

    <!-- MAIN -->
    <main class="main">
      <div class="header">
        <div>
          <h1 id="pageTitle">Agent Status Dashboard</h1>
          <div style="color:var(--muted)" id="pageSubtitle">Real-time agent monitoring and queue management</div>
        </div>
        <div class="live-indicator"><div class="pulse-dot"></div>LIVE DASHBOARD</div>
      </div>

      <div class="content">

        <!-- AGENTS PAGE -->
        <section id="agents" class="page active">
          <div class="agents-grid" id="agentsGrid"></div>
          <div class="queue">
            <div class="top">
              <h3>üìã Agent Queue Management</h3>
              <div style="color:var(--muted);font-size:14px">Drag to reorder priority ‚Ä¢ Position 1 becomes <strong>Top Sales</strong></div>
            </div>
            <div id="queueList"></div>
          </div>
        </section>

        <!-- LEADS PAGE -->
        <section id="leads" class="page">
          <div class="leads">
            <div class="panel">
              <div class="top">
                <h3>üî• Ongoing Leads</h3>
                <div class="live-indicator"><div class="pulse-dot"></div>LIVE</div>
              </div>
              <div id="ongoingLeads" class="leads-list"></div>
            </div>
            <div class="panel">
              <div class="top"><h3>üìã Past Leads</h3><div style="color:var(--muted)">Last 24h</div></div>
              <div id="pastLeads" class="leads-list"></div>
            </div>
          </div>
        </section>

        <!-- CHAT PAGE -->
        <section id="chat" class="page">
          <div class="chat-wrap">
            <div class="chat-header">
              <div>
                <h3>ü§ñ BeLive AI Assistant</h3>
                <div>Lead Qualification Chat ‚Ä¢ No Timer (AI Handling)</div>
              </div>
            </div>
            <div id="chatMessages" class="chat-messages"></div>
          </div>
        </section>

        <!-- SLA PAGE -->
        <section id="sla" class="page">
          <div class="sla-grid">
            <div class="conv-list">
              <h3 style="margin-bottom:10px">üí¨ Active Conversations</h3>
              <div style="color:var(--muted);font-size:14px;margin-bottom:10px">Click to manage</div>
              <div id="convList"></div>
            </div>

            <div class="sla-chat">
              <div class="sla-chat-head">
                <div>
                  <h3 id="slaChatTitle">Select a conversation</h3>
                  <div id="slaChatSub" style="opacity:.9">Choose a conversation on the left</div>
                </div>
                <div id="slaHeaderTimer" class="sla-pill neg">--:--</div>
              </div>
              <div id="slaMessages" class="sla-chat-body">
                <div style="text-align:center;color:var(--muted);margin-top:40px">
                  <h3>üí¨ SLA Chat Monitor</h3>
                  <p>Select a conversation to view and reply</p>
                </div>
              </div>
              <div class="sla-input">
                <input id="slaInput" placeholder="Type your message..." />
                <button id="slaSend">Send</button>
                <button class="btn-danger" id="slaEscalate">Escalate</button>
              </div>
            </div>
          </div>
        </section>
      </div>
    </main>
  </div>

  <!-- Floating ALPS score (visible only on Chat page) -->
  <aside id="alpsCard" class="alps-card">
    <h4 style="margin:0 0 6px">ALPS Score</h4>
    <div class="alps-bar"><div id="alpsFill" class="alps-fill fill-cold" style="width:0%"></div></div>
    <div id="alpsText" style="font-weight:700">0 / 100</div>
    <div id="alpsCat" style="color:var(--muted)">Cold Lead ‚ùÑÔ∏è</div>
  </aside>

  <!-- Lead chart modal -->
  <div id="chartModal" class="modal">
    <div class="modal-card">
      <span class="close" id="chartClose">&times;</span>
      <h2 id="chartTitle">Lead Score Progression</h2>
      <canvas id="leadChart" height="160"></canvas>
      <div id="chartDetails" style="margin-top:14px"></div>
    </div>
  </div>

  <!-- SLA Alert -->
  <div id="slaAlert" class="alert">
    <div class="alert-card">
      <div class="alert-head">üö® SLA BREACH ALERT</div>
      <div style="color:var(--muted)">Agent has not responded within the SLA timeframe</div>
      <div class="alert-box">
        <div><strong>Conversation:</strong> <span id="alertConv">-</span></div>
        <div><strong>Agent:</strong> <span id="alertAgent">-</span></div>
        <div><strong>Time Exceeded:</strong> <span id="alertTime">+0:00</span></div>
      </div>
      <div class="alert-actions">
        <button id="alertGoto" class="live-indicator" style="background:var(--primary)">Go to Conversation</button>
        <button id="alertReassign" class="live-indicator" style="background:var(--danger)">Reassign</button>
      </div>
    </div>
  </div>

<script>
/* ===========================
   STATE
=========================== */
const agentProfiles = {
  agent1:{id:'agent1', name:'Sarah Chen', status:'available', capacity:3},
  agent2:{id:'agent2', name:'Mike Johnson', status:'busy', capacity:8},
  agent3:{id:'agent3', name:'Lisa Wong', status:'available', capacity:5},
  agent4:{id:'agent4', name:'David Lim', status:'away', capacity:0},
  agent5:{id:'agent5', name:'Jennifer Tan', status:'available', capacity:2},
};
let agentOrder = ['agent1','agent2','agent3','agent4','agent5']; // queue order (draggable)
let topSalesId = 'agent1';

let completedLeads = [];
let ongoingLeads = [];
let activeConversations = {};
let agentConversations = {agent1:[],agent2:[],agent3:[],agent4:[],agent5:[]};
let selectedConversationId = null;
let nextLeadId = 2024006;

/* Chat flow */
let chatStep = 0, chatResponses = {}, chatScore = 0;

/* Questions */
const AREAS = ['KL/Selangor','Perak','JB/Penang','Negeri Sembilan','Genting Highlands'];
const PROPERTIES = ["121 Residence","7 Tree Seven","Acacia Residence","Ampang","Ara Damansara","AraTre Residence","Armani SOHO","Arte Cheras","Astoria","Astoria Ampang","Austin Regency","Bandar Sri Permaisuri","Bora Residence","Bukit Jalil","Cheras","D'Cosmos","Duta Park","Emporis Kota Damansara","Epic Residence","Fairview Residence","HighPark Suites","Icon City","Kelana Jaya","Keramat","Kota Damansara","M Adora","M Vertica","Majestic Maxim","Marina Residence","Medini Signature","Meta City","MH Platinum 2","Mont Kiara","One Cochrane","Parc3","Petaling Jaya","Pinnacle","Pixel City Central","Platinum Splendor","Razak City Residences","Rica Residence","Sapphire Paradigm","Secoya Residence","Sentul","Seri Kembangan","Setapak","Sinaran","Sinaran Residence","Subang Jaya","Sungai Besi","Sunway Avila","Sunway Serene","The Andes","The Azure","The Azure Residences","The Birch","The OOAK","The PARC3","Trion KL","Unio Residence","Vertu Resort","Vista Sentul","Vivo Executive Apartment","Vivo Residence","Youth City"];
const questions = [
  {id:'area', text:`Hi! Welcome to BeLive. I'm here to help you find the perfect room. Choose an area:`, type:'select', options:AREAS, weight:15},
  {id:'property', text:'Great choice! Here are the available properties in your selected area:', type:'property_select', weight:10},
  {id:'budget', text:"What's your budget range for monthly rent?", type:'input', placeholder:'e.g., 800', weight:25},
  {id:'pax', text:'How many people will be staying?', type:'select', options:['1 person','2 people','More than 2'], weight:10},
  {id:'car', text:'Do you have a car?', type:'select', options:['Yes','No'], weight:5},
  {id:'parking', text:'Do you need a car park lot?', type:'select', options:['Yes','No'], weight:5},
  {id:'movein', text:'When are you planning to move in?', type:'date', weight:20},
  {id:'tenancy', text:'What\'s your preferred tenancy period?', type:'select', options:['6 months','12 months'], weight:5},
  {id:'gender', text:"What's your gender?", type:'select', options:['Male','Female'], weight:0},
  {id:'unit_spec', text:'What type of unit do you prefer? (You can select multiple)', type:'multiple', options:['Female unit','Male unit','Mixed Gender unit'], weight:5},
  {id:'workplace', text:'Where is your workplace? This helps us recommend the closest property.', type:'input', placeholder:'e.g., KLCC, Cyberjaya', weight:10},
  {id:'nationality', text:'What\'s your nationality?', type:'select', options:['Malaysian','Others'], weight:0},
];

/* Alert tracking */
let alertConvId = null;

/* ===========================
   DOM HELPERS
=========================== */
const $ = sel => document.querySelector(sel);
function el(tag, props={}){ const e=document.createElement(tag); Object.assign(e, props); return e; }

/* ===========================
   NAVIGATION
=========================== */
function switchPage(page){
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
  document.getElementById(page).classList.add('active');
  document.querySelector(`.nav-item[data-page="${page}"]`).classList.add('active');
  const titles = {agents:'Agent Status Dashboard', leads:'Lead Management', chat:'AI Chat Interface', sla:'SLA Monitoring'};
  const subs   = {agents:'Real-time agent monitoring and queue management', leads:'Lead scoring and progression tracking', chat:'AI-powered lead qualification system', sla:'Response time monitoring and escalation'};
  $('#pageTitle').textContent = titles[page];
  $('#pageSubtitle').textContent = subs[page];
  $('#alpsCard').style.display = (page==='chat') ? 'block' : 'none';
}
document.querySelectorAll('.nav-item').forEach(i=>i.addEventListener('click',()=>switchPage(i.dataset.page)));

/* ===========================
   AGENTS UI + QUEUE
=========================== */
function drawAgentCards(){
  const grid = $('#agentsGrid'); grid.innerHTML='';
  agentOrder.forEach((id, idx)=>{
    const a = agentProfiles[id];
    const card = el('div',{className:`agent-card ${a.status} ${id===topSalesId?'top-sales':''}`});
    card.setAttribute('data-agent', id); /* set data attribute safely */
    const statusClass = a.status==='available'?'status-available':(a.status==='busy'?'status-busy':'status-away');
    card.innerHTML = `
      <div class="agent-header">
        <div class="agent-name">${id===topSalesId?'üëë ':''}${a.name} <span style="color:${id===topSalesId?'#d48806':'#98a2ad'};font-weight:600;font-size:12px">${id===topSalesId?'Top Sales':'Agent'}</span></div>
        <div class="agent-status ${statusClass}">${a.status==='available'?'Available':a.status==='busy'?'Busy':'Break'}</div>
      </div>
      <div>Queue Position: ${idx+1}</div>
      <div class="capacity-bar"><div class="capacity-fill ${a.capacity<=3?'capacity-low':(a.capacity<=7?'capacity-medium':'capacity-high')}" style="width:${a.capacity*10}%"></div></div>
      <div class="capacity-text">Capacity: ${a.capacity}/10 chats</div>
      <div class="agent-stats" style="display:flex;gap:18px;margin-top:12px">
        <div><div class="stat-number">90%</div><div class="stat-label" style="color:var(--muted);font-size:12px">SLA Rate</div></div>
        <div><div class="stat-number">8.0</div><div class="stat-label" style="color:var(--muted);font-size:12px">Avg Score</div></div>
        <div><div class="stat-number">${Math.floor(Math.random()*24)}</div><div class="stat-label" style="color:var(--muted);font-size:12px">Leads Today</div></div>
      </div>
    `;
    card.addEventListener('click',()=>{ switchPage('sla'); showAgentConversations(id); });
    grid.appendChild(card);
  });
}
function drawQueue(){
  const q = $('#queueList'); q.innerHTML='';
  agentOrder.forEach((id,i)=>{
    const row = el('div',{className:'queue-item', draggable:true});
    row.setAttribute('data-agent', id);
    row.innerHTML = `<div style="display:flex;align-items:center;gap:14px"><span class="drag">‚â°</span><div><strong>${id===topSalesId?'üëë ':''}${agentProfiles[id].name}</strong> - ${id===topSalesId?'Top Sales':'Agent'}</div></div>
    <div>Position: ${i+1}</div>`;
    q.appendChild(row);
  });
  makeQueueDraggable();
}
function makeQueueDraggable(){
  const list = $('#queueList');
  let dragItem = null;
  list.querySelectorAll('.queue-item').forEach(it=>{
    it.addEventListener('dragstart', e=>{dragItem=it; it.style.opacity=.5;});
    it.addEventListener('dragend', e=>{it.style.opacity=1; dragItem=null});
  });
  list.addEventListener('dragover', e=>e.preventDefault());
  list.addEventListener('drop', e=>{
    e.preventDefault();
    const target = e.target.closest('.queue-item');
    if(!dragItem || !target || dragItem===target) return;
    const rect = target.getBoundingClientRect();
    const before = e.clientY < rect.top + rect.height/2;
    list.insertBefore(dragItem, before?target:target.nextSibling);
    agentOrder = Array.from(list.children).map(n=>n.getAttribute('data-agent'));
    topSalesId = agentOrder[0];              // auto Top Sales
    drawAgentCards(); drawQueue();
  });
}

/* ===========================
   LEADS PANELS
=========================== */
function addLeadToPanel(lead){
  const list = $('#ongoingLeads');
  const item = el('div',{className:'lead-item'});
  item.setAttribute('data-lead', lead.id);
  const cls = lead.score>=70?'hot':(lead.score>=40?'warm':'cold');
  const scoreCls = lead.score>=70?'score-hot':(lead.score>=40?'score-warm':'score-cold');
  item.classList.add(cls);
  item.innerHTML = `
    <div class="lead-score ${scoreCls}">${lead.score}</div>
    <div>
      <div class="lead-name">${lead.score>=70?'üî• ':lead.score>=40?'‚≠ê ':'‚ùÑÔ∏è '}Lead ${lead.leadNumber}</div>
      <div class="lead-details">Area: ${lead.area} ‚Ä¢ Budget: RM${lead.budget}<br>Move-in: ${lead.movein} ‚Ä¢ Agent: ${lead.agent|| (lead.status==='in_queue'?'In Queue':'AI Bot')}</div>
      <div class="lead-timestamp">Started: ${lead.timestamp.toLocaleTimeString()} ‚Ä¢ Status: ${lead.status==='assigned'?'Assigned':(lead.status==='in_queue'?'Queued':'AI Handling')}</div>
    </div>`;
  item.addEventListener('click',()=>openLeadChart(lead));
  list.prepend(item);
}

/* ===========================
   CHART (lead details)
=========================== */
let leadChart = null;
function openLeadChart(lead){
  const mdl = $('#chartModal'); mdl.style.display='flex';
  $('#chartTitle').textContent = `Lead ${lead.leadNumber} - Score Progression`;
  const msgs = ['Start','Area','Property','Budget','Pax','Car','Move-in','Tenancy','Gender','Final'];
  let s=0, arr=[0];
  questions.forEach(q=>{
    if(lead.responses[q.id]!=null){
      let inc = q.weight*0.8;
      if(q.id==='budget'){ const b=+lead.responses[q.id]; inc = b>=800?q.weight: b>=600?q.weight*0.7: b>=400?q.weight*0.4: q.weight*0.1; }
      if(q.id==='movein'){ const d=new Date(lead.responses[q.id]); const days=Math.ceil((d-new Date())/86400000); inc = days<=7?q.weight: days<=30?q.weight*.8: days<=60?q.weight*.6:q.weight*.3; }
      if(q.id==='area'||q.id==='property') inc=q.weight;
      s+=inc; arr.push(Math.round(s));
    }
  });
  const ctx = document.getElementById('leadChart');
  if(leadChart) leadChart.destroy();
  leadChart = new Chart(ctx, {type:'line', data:{
    labels:msgs, datasets:[{label:'ALPS', data:arr, borderColor:'#3498db', backgroundColor:'rgba(52,152,219,.12)', borderWidth:3, pointRadius:5, tension:.35, fill:true}]
  }, options:{plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true,max:100}} }});
  $('#chartDetails').innerHTML = `
    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;margin-top:10px">
      <div style="background:#f8f9fa;border-radius:10px;padding:10px"><strong>Final Score</strong><div style="font-size:22px;color:${lead.score>=70?'#e74c3c':(lead.score>=40?'#f39c12':'#95a5a6')};font-weight:800">${lead.score}/100</div><div>${lead.score>=70?'Hot Lead üî•':lead.score>=40?'Warm Lead ‚≠ê':'Cold Lead ‚ùÑÔ∏è'}</div></div>
      <div style="background:#f8f9fa;border-radius:10px;padding:10px"><strong>Details</strong><div style="color:var(--muted);font-size:14px">${lead.area} ‚Ä¢ Budget: RM${lead.budget} ‚Ä¢ Move-in: ${lead.movein}</div></div>
    </div>`;
}
$('#chartClose').onclick=()=>{$('#chartModal').style.display='none'; if(leadChart){leadChart.destroy();leadChart=null;}};

/* ===========================
   CHAT FLOW
=========================== */
function chatAdd(text, who='bot', raw=false){
  const m = el('div',{className:`msg ${who==='system'?'sys':(who==='user'?'user':'bot')}`});
  m.innerHTML = raw?text:escapeHtml(text);
  $('#chatMessages').appendChild(m);
  $('#chatMessages').scrollTop = $('#chatMessages').scrollHeight;
}
function escapeHtml(s){const d=document.createElement('div'); d.textContent=s; return d.innerHTML;}
function ask(step){
  if(step>=questions.length){ finalizeLead(); return; }
  const q = questions[step];
  chatStep = step;
  let html = `<div>${q.text}</div>`;
  if(q.type==='select'){
    html += `<div class="options">`+ q.options.map(o=>`<div class="opt-btn" data-q="${q.id}" data-v="${o}">${o}</div>`).join('') + `</div>`;
  } else if(q.type==='property_select'){
    const props = PROPERTIES.slice(0,12);
    html += `<div class="options">`+ props.map(p=>`<div class="opt-btn" data-q="${q.id}" data-v="${p}">${p}</div>`).join('') + `</div>`;
  } else if(q.type==='input'){
    html += `<input class="opt-input" id="inp_${q.id}" placeholder="${q.placeholder||''}" style="margin-top:8px;width:100%;padding:12px;border:2px solid #e0e0e0;border-radius:14px">`;
  } else if(q.type==='date'){
    html += `<input type="date" class="opt-input" id="inp_${q.id}" style="margin-top:8px;width:100%;padding:12px;border:2px solid #e0e0e0;border-radius:14px">`;
  } else if(q.type==='multiple'){
    html += `<div class="check-group" id="grp_${q.id}">
      ${q.options.map((o,i)=>`<label class="check-item"><input type="checkbox" value="${o}" /> <span>${o}</span></label>`).join('')}
      <button class="continue" data-q="${q.id}">Continue</button>
    </div>`;
  }
  chatAdd(html,'bot',true);
}
function handleChatClick(e){
  const btn = e.target.closest('.opt-btn');
  if(btn){
    const qid = btn.dataset.q, val = btn.dataset.v;
    chatResponses[qid] = val;
    chatAdd(val,'user');
    scoreIncrement(qid,val);
    ask(chatStep+1);
  }
}
function handleChatInput(e){
  if(e.target.classList.contains('opt-input') && e.key==='Enter'){
    const id = e.target.id.replace('inp_',''), val = e.target.value.trim();
    if(!val) return;
    chatResponses[id]=val; chatAdd(val,'user'); scoreIncrement(id,val); ask(chatStep+1);
  }
}
function handleDateChange(e){
  if(e.target.classList.contains('opt-input') && e.target.type==='date'){
    const id = e.target.id.replace('inp_',''); const val = e.target.value;
    if(!val) return; chatResponses[id]=val; chatAdd(val,'user'); scoreIncrement(id,val); ask(chatStep+1);
  }
}
function handleContinue(e){
  if(e.target.classList.contains('continue')){
    const qid = e.target.dataset.q;
    const values = Array.from(document.querySelectorAll(`#grp_${qid} input:checked`)).map(i=>i.value);
    if(values.length===0){ alert('Please select at least one option'); return; }
    chatResponses[qid]=values; chatAdd(values.join(', '),'user'); scoreIncrement(qid,values); ask(chatStep+1);
  }
}
$('#chat').addEventListener('click',handleChatClick);
$('#chat').addEventListener('keypress',handleChatInput);
$('#chat').addEventListener('click',handleContinue);
$('#chat').addEventListener('change',handleDateChange);

function scoreIncrement(qid,val){
  const q = questions.find(x=>x.id===qid); let inc=0;
  switch(qid){
    case 'area': case 'property': inc=q.weight; break;
    case 'budget':
      const b=parseInt(val,10); inc = b>=800?q.weight: b>=600?q.weight*.7: b>=400?q.weight*.4: q.weight*.1; break;
    case 'movein':
      const d=new Date(val); const days=Math.ceil((d-new Date())/86400000);
      inc = days<=7?q.weight: days<=30?q.weight*.8: days<=60?q.weight*.6: q.weight*.3; break;
    default: inc=q.weight*.8;
  }
  chatScore = Math.min(100, Math.round(chatScore+inc));
  updateAlpsCard();
}
function updateAlpsCard(){
  const fill = $('#alpsFill'), txt=$('#alpsText'), cat=$('#alpsCat');
  fill.style.width = `${chatScore}%`;
  fill.className='alps-fill ' + (chatScore>=70?'fill-hot':chatScore>=40?'fill-warm':'fill-cold');
  txt.textContent = `${chatScore} / 100`;
  cat.textContent = chatScore>=70?'Hot Lead üî•':chatScore>=40?'Warm Lead ‚≠ê':'Cold Lead ‚ùÑÔ∏è';
}

/* finalize: create a lead, route, start SLA */
function finalizeLead(){
  chatAdd(`<div style="background:#eef8ff;border-left:4px solid var(--primary);padding:12px;border-radius:10px"><strong>Score calculated:</strong> ${chatScore}/100</div>`, 'system', true);

  const newLead = {
    id:`lead${nextLeadId}`,
    leadNumber:`#${nextLeadId}`,
    score:chatScore,
    area:chatResponses.area || 'KL/Selangor',
    budget:chatResponses.budget || 'Not specified',
    movein:chatResponses.movein || 'Not specified',
    property:chatResponses.property || 'Not specified',
    responses:{...chatResponses},
    timestamp:new Date(),
    status:'pending_assignment',
    agent:null
  };

  if(chatScore>=60){
    chatAdd(`<div style="background:#e8f5e8;border-left:4px solid var(--ok);padding:12px;border-radius:10px"><strong>High Priority Lead!</strong><br/>Routing to top agent‚Ä¶</div>`, 'system', true);
    setTimeout(()=>routeLeadToAgent(newLead), 1200);
  }else{
    chatAdd(`<div style="background:#fff8e1;border-left:4px solid var(--warn);padding:12px;border-radius:10px">Lead captured. AI will continue to assist you.</div>`, 'system', true);
    newLead.status='AI Handling';
    addLeadToPanel(newLead); ongoingLeads.push(newLead); completedLeads.push(newLead);
  }
  nextLeadId++;
}

/* Agent selection uses queue + availability + capacity */
function findBestAgent(){
  for(const id of agentOrder){
    const a = agentProfiles[id];
    const cardAvail = a.status==='available';
    if(a.capacity<10 && cardAvail) return a;
  }
  return null;
}
function routeLeadToAgent(lead){
  const ag = findBestAgent();
  if(!ag){
    lead.status='in_queue'; addLeadToPanel(lead); ongoingLeads.push(lead); completedLeads.push(lead);
    chatAdd(`<div style="background:#fff3e0;border-left:4px solid var(--warn);padding:12px;border-radius:10px">All agents busy. Added to priority queue.</div>`, 'system', true);
    return;
  }
  lead.agent = ag.name; lead.status='assigned';
  addLeadToPanel(lead); ongoingLeads.push(lead); completedLeads.push(lead);

  const convId = `conv_${lead.id}`;
  const conv = {
    id:convId, leadId:lead.id, leadNumber:lead.leadNumber, agentId:ag.id, agentName:ag.name,
    area:lead.area, score:lead.score, status:'waiting_agent_response',
    slaTimer:{type:'initial', timeRemaining:300, alertTriggered:false, overdue:0, breached:false},
    messages:[{type:'system', text:`Lead ${lead.leadNumber} has been assigned to you. Area: ${lead.area}, Budget: ${lead.budget}, Move-in: ${lead.movein}`, time:timeNow()}]
  };
  activeConversations[convId]=conv;
  agentConversations[ag.id].push(conv);
  ag.capacity = Math.min(10, ag.capacity+1);

  drawAgentCards(); drawQueue(); drawConversationsList();

  chatAdd(`<div style="background:#e3f2fd;border-left:4px solid var(--primary);padding:12px;border-radius:10px"><strong>Routed!</strong> Assigned to: ${ag.name} (Lead ${lead.leadNumber}). Our agent will contact you soon.</div>`, 'system', true);
}

/* ===========================
   SLA LIST + CHAT
=========================== */
function getConvClass(c){
  if(c.slaTimer.type==='initial' && c.slaTimer.timeRemaining<=60 && !c.slaTimer.overdue) return 'conv warn';
  if(c.slaTimer.overdue>0) return 'conv breach';
  return 'conv';
}
function fmtTimer(t){const m=Math.floor(Math.abs(t)/60), s=Math.abs(t)%60; return `${t<0?'-':'+'}${m}:${s.toString().padStart(2,'0')}`}
function timerText(c){
  if(c.slaTimer.overdue>0) return {text:fmtTimer(c.slaTimer.overdue), cls:'pos', desc:c.slaTimer.type==='initial'?'Initial response overdue':'Response overdue'};
  if(c.slaTimer.timeRemaining>0) return {text:fmtTimer(-c.slaTimer.timeRemaining), cls:'neg', desc:c.slaTimer.type==='initial'?'Initial response due':'Next response due'};
  return {text:'0:00',cls:'neg',desc:'Timer'};
}
function drawConversationsList(){
  const list = $('#convList'); list.innerHTML='';
  const all = Object.values(activeConversations);
  if(all.length===0){ list.innerHTML=`<div style="text-align:center;color:var(--muted);margin-top:30px">No active conversations yet</div>`; return; }
  all.sort((a,b)=> (a.agentName>b.agentName?1:-1));
  all.forEach(c=>{
    const row = el('div',{className:getConvClass(c)});
    const t = timerText(c);
    row.innerHTML = `
      <div class="sla-row">
        <div><div><strong>Lead ${c.leadNumber}</strong> ‚Ä¢ ${c.agentName}</div><div style="color:var(--muted);font-size:13px">${c.area} ‚Ä¢ ALPS: ${c.score}</div></div>
        <div style="text-align:right"><div class="sla-pill ${t.cls}" data-timer>${t.text}</div><div style="font-size:12px;color:var(--muted)">${t.desc}</div></div>
      </div>`;
    row.addEventListener('click',()=>openSLAChat(c.id));
    list.appendChild(row);
  });
}
function openSLAChat(id){
  selectedConversationId = id;
  const c = activeConversations[id]; if(!c) return;
  $('#slaChatTitle').textContent = `Lead ${c.leadNumber} - ${c.agentName}`;
  $('#slaChatSub').textContent   = `${c.area} ‚Ä¢ ALPS: ${c.score} ‚Ä¢ ${c.status==='waiting_agent_response'?'Waiting for agent response':'Ongoing'}`;
  const t = timerText(c); const h = $('#slaHeaderTimer'); h.textContent=t.text; h.className = `sla-pill ${t.cls}`;

  const box = $('#slaMessages'); box.innerHTML='';
  c.messages.forEach(m=>box.appendChild(renderMsg(m)));
  box.scrollTop = box.scrollHeight;
}
function renderMsg(m){
  const div = el('div',{className:`msg ${m.type==='system'?'sys':(m.type==='customer'?'user':'bot')}`});
  div.innerHTML = `<div>${escapeHtml(m.text)}</div><div style="font-size:12px;color:var(--muted);margin-top:4px">${m.time}</div>`;
  return div;
}

/* send in SLA chat */
$('#slaSend').addEventListener('click',sendSlaMessage);
$('#slaInput').addEventListener('keypress',e=>{if(e.key==='Enter')sendSlaMessage();});
function sendSlaMessage(){
  const id = selectedConversationId; if(!id) return;
  const c = activeConversations[id]; const input=$('#slaInput'); const msg=input.value.trim(); if(!msg) return;
  input.value='';
  const m={type:'agent',text:msg,time:timeNow()};
  c.messages.push(m); $('#slaMessages').appendChild(renderMsg(m)); $('#slaMessages').scrollTop = $('#slaMessages').scrollHeight;

  if(c.status==='waiting_agent_response'){ c.status='ongoing'; c.slaTimer={type:'ongoing',timeRemaining:600,alertTriggered:false,overdue:0,breached:false}; }
  else { c.slaTimer.timeRemaining=600; c.slaTimer.alertTriggered=false; c.slaTimer.overdue=0; }
  drawConversationsList();

  setTimeout(()=>{
    const reply={type:'customer',text:"Thanks! I'm interested to view.", time:timeNow()};
    c.messages.push(reply); $('#slaMessages').appendChild(renderMsg(reply)); $('#slaMessages').scrollTop = $('#slaMessages').scrollHeight;
    c.slaTimer.timeRemaining=600;
  },2500);
}
$('#slaEscalate').addEventListener('click',()=>{
  const id=selectedConversationId; if(!id) return; const c=activeConversations[id];
  const m={type:'system',text:'Conversation escalated to supervisor and will be reassigned.', time:timeNow()};
  c.messages.push(m); $('#slaMessages').appendChild(renderMsg(m)); $('#slaMessages').scrollTop = $('#slaMessages').scrollHeight;
});

/* ===========================
   SLA TIMERS TICK
=========================== */
function tickSlaTimers(){
  Object.values(activeConversations).forEach(c=>{
    const t = c.slaTimer;
    if(!t) return;
    if(t.timeRemaining>0){
      t.timeRemaining--;
      if(t.timeRemaining<=0){
        if(t.type==='initial'){ triggerSlaAlert(c.id); }
        else{ t.alertTriggered = true; t.overdue = 1; triggerSlaAlert(c.id); }
      }
    }else if(t.overdue>0 || t.alertTriggered){
      t.overdue++;
    }
  });

  drawConversationsList();
  if(selectedConversationId){
    const c=activeConversations[selectedConversationId];
    if(c){
      const h=$('#slaHeaderTimer'); const tx=timerText(c); h.textContent=tx.text; h.className=`sla-pill ${tx.cls}`;
    }
  }

  if(alertConvId){
    const c=activeConversations[alertConvId]; if(c){
      $('#alertTime').textContent = fmtTimer(c.slaTimer.overdue || 0);
    }
  }
}

/* SLA alert */
function triggerSlaAlert(convId){
  alertConvId = convId;
  const c = activeConversations[convId];
  if(!c) return;
  $('#alertConv').textContent = `Lead ${c.leadNumber}`;
  $('#alertAgent').textContent = c.agentName;
  $('#alertTime').textContent  = '+0:01';
  $('#slaAlert').style.display='flex';
}
$('#alertGoto').addEventListener('click',()=>{
  if(!alertConvId) return;
  switchPage('sla');
  openSLAChat(alertConvId);
  $('#slaAlert').style.display='none';
  alertConvId=null;
});
$('#alertReassign').addEventListener('click',()=>{
  if(!alertConvId) return;
  reassignNextAgent(activeConversations[alertConvId]);
  $('#slaAlert').style.display='none';
  alertConvId=null;
});
$('#slaAlert').addEventListener('click',e=>{ if(e.target.id==='slaAlert') { $('#slaAlert').style.display='none'; alertConvId=null; } });

/* reassign helper */
function reassignNextAgent(conv){
  const currentIdx = agentOrder.indexOf(conv.agentId);
  const round = [...agentOrder.slice(currentIdx+1), ...agentOrder.slice(0,currentIdx)];
  let next=null;
  for(const id of round){
    const ag = agentProfiles[id];
    if(ag.status==='available' && ag.capacity<10){ next=ag; break; }
  }
  if(!next){
    conv.status='unassigned';
    conv.slaTimer.overdue++;
    return;
  }
  agentConversations[conv.agentId] = agentConversations[conv.agentId].filter(x=>x.id!==conv.id);
  agentProfiles[conv.agentId].capacity = Math.max(0, agentProfiles[conv.agentId].capacity-1);

  conv.agentId = next.id; conv.agentName=next.name; conv.status='waiting_agent_response';
  conv.slaTimer={type:'initial',timeRemaining:300,alertTriggered:false,overdue:0,breached:false};
  agentConversations[next.id].push(conv);
  next.capacity = Math.min(10, next.capacity+1);

  conv.messages.push({type:'system',text:`Conversation reassigned to ${next.name} due to initial response timeout.`, time:timeNow()});
  drawAgentCards(); drawQueue(); drawConversationsList();
  if(selectedConversationId===conv.id) openSLAChat(conv.id);
}

/* ===========================
   AGENT FILTER IN SLA
=========================== */
function showAgentConversations(agentId){
  const list = $('#convList'); list.innerHTML='';
  const back = el('button',{textContent:'‚Üê Back to All Conversations', style:'margin-bottom:10px;border:none;border-radius:10px;background:#e7f0fb;color:#1d4ed8;padding:10px 14px;cursor:pointer;font-weight:700'});
  back.addEventListener('click',()=>drawConversationsList());
  list.appendChild(back);

  const header = el('h3',{textContent:`${agentProfiles[agentId].name}'s Conversations`});
  list.appendChild(header);
  const sub = el('div',{textContent:`Active: ${(agentConversations[agentId]||[]).length} conversations`, style:'color:var(--muted);margin:6px 0 10px'});
  list.appendChild(sub);

  (agentConversations[agentId]||[]).forEach(c=>{
    const row = el('div',{className:getConvClass(c)});
    const t = timerText(c);
    row.innerHTML = `<div class="sla-row">
      <div><div><strong>Lead ${c.leadNumber}</strong> ‚Ä¢ ${c.agentName}</div><div style="color:var(--muted);font-size:13px">${c.area} ‚Ä¢ ALPS: ${c.score}</div></div>
      <div style="text-align:right"><div class="sla-pill ${t.cls}">${t.text}</div><div style="font-size:12px;color:var(--muted)">${t.desc}</div></div>
    </div>`;
    row.addEventListener('click',()=>openSLAChat(c.id));
    list.appendChild(row);
  });
}

/* ===========================
   INITIALIZATION
=========================== */
function initAgents(){ drawAgentCards(); drawQueue(); }
function initChat(){ chatStep=0; chatResponses={}; chatScore=0; updateAlpsCard(); $('#chatMessages').innerHTML=''; ask(0); }
function initSla(){ drawConversationsList(); }
function updateClock(){ $('#lastUpdate').textContent = new Date().toLocaleTimeString(); }
function timeNow(){ return new Date().toLocaleTimeString(); }

/* Real-time loop */
setInterval(()=>{ updateClock(); tickSlaTimers(); },1000);

/* Boot */
initAgents(); initChat(); initSla();
</script>
</body>
</html>




