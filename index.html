<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>BeLive ALPS Management Dashboard</title>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
<style>
  :root{
    --bg:#f5f6fa;
    --card:#ffffff;
    --muted:#7f8c8d;
    --muted-2:#b4bcc2;
    --brand:#3498db;
    --ok:#2ecc71;
    --warn:#f39c12;
    --danger:#e74c3c;
    --ink:#2c3e50;
  }
  *{box-sizing:border-box;margin:0;padding:0}
  body{font-family:"Inter",system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;background:var(--bg);height:100vh;overflow:hidden;color:var(--ink)}
  .dashboard{display:flex;height:100vh}

  /* SIDEBAR */
  .sidebar{width:280px;background:#2c3e50;color:#fff;padding:20px;overflow:auto}
  .nav-item{padding:14px 12px;margin:6px 0;border-radius:10px;display:flex;gap:10px;align-items:center;cursor:pointer;transition:.18s}
  .nav-item:hover{background:#3b4b61}
  .nav-item.active{background:#34495e}
  .nav-icon{font-size:18px}
  .side-card{margin-top:18px;border-radius:12px;background:rgba(255,255,255,.10);padding:14px;font-size:14px}
  .live-pill{display:inline-flex;align-items:center;gap:6px;background:#e74c3c;color:#fff;border-radius:999px;padding:5px 10px;font-weight:800;font-size:12px}
  .pulse{width:8px;height:8px;border-radius:50%;background:#fff;animation:pulse 1.8s infinite}
  @keyframes pulse{0%{opacity:1}50%{opacity:.55}100%{opacity:1}}

  /* MAIN */
  .main{flex:1;display:flex;flex-direction:column;overflow:hidden}
  .header{background:#fff;padding:18px 20px;box-shadow:0 2px 10px rgba(0,0,0,.08);display:flex;align-items:center;justify-content:space-between}
  .content{flex:1;overflow:auto;padding:20px}

  .page{display:none}
  .page.active{display:block}

  /* CARDS / AGENTS */
  .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:20px}
  .grid-3{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:20px}
  .grid-auto{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:20px}

  .card{background:var(--card);border-radius:16px;box-shadow:0 4px 14px rgba(0,0,0,.08);padding:20px}
  .agent-card{position:relative;border-left:5px solid var(--ok)}
  .agent-card.busy{border-left-color:var(--danger)}
  .agent-card.break{border-left-color:#95a5a6}
  .agent-card.top{background:linear-gradient(135deg,#fff9e6,#fff)}
  .badge{font-size:12px;font-weight:800;border-radius:999px;padding:6px 12px}
  .b-ok{background:var(--ok);color:#fff}
  .b-warn{background:var(--warn);color:#fff}
  .b-danger{background:var(--danger);color:#fff}
  .progress{background:#ecf0f1;border-radius:8px;height:10px;overflow:hidden}
  .progress > span{display:block;height:100%;background:var(--ok)}
  .progress.busy > span{background:var(--danger)}
  .meta{color:var(--muted);font-size:14px}

  /* QUEUE */
  .queue-item{display:flex;justify-content:space-between;align-items:center;padding:14px;margin:10px 0;background:#f8f9fa;border-left:4px solid var(--brand);border-radius:10px;cursor:move}
  .drag{cursor:grab;color:#7f8c8d;font-size:18px}

  /* LEADS LIST */
  .lead{display:flex;gap:12px;align-items:center;background:#f8f9fa;border-radius:12px;padding:14px;margin:10px 0;border-left:4px solid #95a5a6;cursor:pointer}
  .lead.hot{border-left-color:var(--danger);background:linear-gradient(135deg,#ffebee,#f8f9fa)}
  .lead.warm{border-left-color:var(--warn);background:linear-gradient(135deg,#fff8e1,#f8f9fa)}
  .pill-score{width:54px;height:54px;border-radius:999px;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:900}
  .pill-hot{background:linear-gradient(135deg,#e74c3c,#c0392b)}
  .pill-warm{background:linear-gradient(135deg,#f39c12,#e67e22)}
  .pill-cold{background:linear-gradient(135deg,#95a5a6,#7f8c8d)}

  /* CHAT (AI form) */
  .chat-shell{background:#fff;border-radius:16px;box-shadow:0 4px 14px rgba(0,0,0,.08);height:calc(100vh - 160px);display:flex;flex-direction:column;overflow:hidden}
  .chat-header{background:#25D366;color:#fff;padding:16px 18px;display:flex;justify-content:space-between;align-items:center}
  .chat-body{flex:1;display:flex;overflow:hidden;background:#e5ddd5}
  .chat-flow{flex:1;overflow:auto;padding:16px}
  .message{max-width:70%;padding:12px 16px;margin:10px 0;border-radius:18px}
  .message-bot{background:#fff;align-self:flex-start;border-bottom-left-radius:4px;box-shadow:0 1px 2px rgba(0,0,0,.08)}
  .message-user{background:#DCF8C6;align-self:flex-end;border-bottom-right-radius:4px;margin-left:auto;box-shadow:0 1px 2px rgba(0,0,0,.08)}
  .message-system{background:#fff3cd;border:2px solid #ffeaa7;text-align:center;max-width:90%;margin:10px auto}
  /* Only animate normal messages; never system ones (prevents flashing) */
  .message:not(.message-system){animation:msg .18s ease-out}
  @keyframes msg{from{opacity:.2;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}

  /* Sticky score panel inside chat; no extra white column on the page */
  .score-panel{width:240px;background:rgba(255,255,255,.96);border-radius:12px;margin:12px;box-shadow:0 4px 12px rgba(0,0,0,.12);height:max-content;position:sticky;top:80px}
  .score-panel h4{padding:12px 12px 4px}
  .score-bar{height:18px;margin:8px 12px;border-radius:10px;background:#e0e0e0;overflow:hidden}
  .score-fill{height:100%}
  .score-hot{background:linear-gradient(90deg,#ff8a80,#e53935)}
  .score-warm{background:linear-gradient(90deg,#ffcc80,#fb8c00)}
  .score-cold{background:linear-gradient(90deg,#cfd8dc,#90a4ae)}

  /* Options UI (buttons) */
  .options{display:flex;flex-direction:column;gap:8px;margin-top:10px}
  .btn-opt{padding:12px 14px;border-radius:20px;border:2px solid #e0e0e0;background:#f0f0f0;cursor:pointer;text-align:left}
  .btn-opt:hover{background:#25D366;border-color:#25D366;color:#fff}
  .grid-choices{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:10px;margin-top:10px}
  .choice{padding:12px;border:2px solid #e9ecef;border-radius:12px;text-align:center;background:#f8f9fa;cursor:pointer}
  .choice:hover{background:#25D366;color:#fff;border-color:#25D366}

  /* Multi-select (uniform look) */
  .checkbox-group{background:#fff;border-radius:14px;padding:12px;border:2px solid #eee;display:flex;flex-wrap:wrap;gap:10px}
  .checkbox-chip{display:flex;align-items:center;gap:8px;border:2px solid #e0e0e0;background:#f7f7f7;border-radius:999px;padding:8px 12px;cursor:pointer}
  .checkbox-chip input{accent-color:#25D366}
  .checkbox-chip.selected{border-color:#25D366;background:#e8f5e9}
  .btn-continue{border:none;background:#25D366;color:#fff;padding:10px 16px;border-radius:999px;cursor:pointer}

  /* SLA */
  .sla-layout{display:grid;grid-template-columns:360px 1fr;gap:20px}
  .conv{padding:14px;margin:10px 0;background:#f8f9fa;border-radius:10px;border-left:4px solid var(--brand);cursor:pointer}
  .conv.warning{background:#fff8e1;border-left-color:var(--warn)}
  .conv.breach{background:#ffebee;border-left-color:var(--danger)}
  .timer-pill{font-weight:800;border-radius:999px;padding:6px 10px;color:#fff}
  .t-neg{background:var(--warn)}
  .t-pos{background:var(--danger)}
  .sla-chat{background:#fff;border-radius:16px;box-shadow:0 4px 14px rgba(0,0,0,.08);display:flex;flex-direction:column;min-height:520px}
  .sla-top{background:#34495e;color:#fff;padding:16px;border-radius:16px 16px 0 0;display:flex;justify-content:space-between;align-items:center}
  .sla-feed{flex:1;overflow:auto;background:#f8f9fa;padding:16px}
  .sla-input{display:flex;gap:10px;padding:16px;border-top:1px solid #ecf0f1;background:#fff}
  .sla-input input{flex:1;padding:12px;border-radius:22px;border:2px solid #ecf0f1}
  .sla-input button{padding:12px 18px;border-radius:22px;border:none;color:#fff;background:#25D366;cursor:pointer}
  .sla-input .danger{background:#e74c3c}

  /* Modal */
  .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:1000}
  .modal > .box{background:#fff;width:min(860px,92vw);margin:5% auto;border-radius:14px;padding:24px}

  @media (max-width:1100px){
    .grid-3{grid-template-columns:1fr}
    .sla-layout{grid-template-columns:1fr}
    .chat-body{flex-direction:column}
    .score-panel{position:relative;top:0;margin:16px}
  }
</style>
</head>
<body>
<div class="dashboard">

  <!-- SIDEBAR -->
  <aside class="sidebar">
    <h2 style="margin-bottom:16px">🏠 BeLive ALPS</h2>
    <div class="nav-item active" data-page="agents"><span class="nav-icon">👥</span><span>Agent Status</span></div>
    <div class="nav-item" data-page="leads"><span class="nav-icon">📊</span><span>Lead Management</span></div>
    <div class="nav-item" data-page="chat"><span class="nav-icon">💬</span><span>Chat Window</span></div>
    <div class="nav-item" data-page="sla"><span class="nav-icon">⏱️</span><span>SLA Monitoring</span></div>

    <div class="side-card">
      <div class="live-pill"><span class="pulse"></span> LIVE</div>
      <div style="margin-top:10px">
        System Status: Active<br>
        Last Update: <span id="lastUpdate">--:--:--</span>
      </div>
    </div>
  </aside>

  <!-- MAIN -->
  <main class="main">
    <div class="header">
      <div>
        <h1 id="title">Agent Status Dashboard</h1>
        <div id="subtitle" style="color:var(--muted)">Real-time agent monitoring and queue management</div>
      </div>
      <div class="live-pill"><span class="pulse"></span> LIVE DASHBOARD</div>
    </div>

    <div class="content">

      <!-- AGENTS -->
      <section id="agents" class="page active">
        <div id="agentCards" class="grid-3"></div>

        <div class="card" style="margin-top:20px">
          <h3>📑 Agent Queue Management</h3>
          <div class="meta" style="margin-top:6px">Drag to reorder priority • Position 1 becomes <strong>Top Sales</strong></div>
          <div id="queueList" style="margin-top:10px"></div>
        </div>
      </section>

      <!-- LEADS -->
      <section id="leads" class="page">
        <div class="grid-2">
          <div class="card">
            <div style="display:flex;align-items:center;justify-content:space-between">
              <h3>🔥 Ongoing Leads</h3><div class="live-pill"><span class="pulse"></span> LIVE</div>
            </div>
            <div id="ongoingLeads" style="margin-top:8px"></div>
          </div>

          <div class="card">
            <div style="display:flex;align-items:center;justify-content:space-between">
              <h3>🧾 Past Leads</h3><div class="meta">Last 24 hours</div>
            </div>
            <div id="pastLeads" style="margin-top:8px"></div>
          </div>
        </div>
      </section>

      <!-- CHAT (AI) -->
      <section id="chat" class="page">
        <div class="chat-shell">
          <div class="chat-header">
            <div>
              <h3>🤖 BeLive AI Assistant</h3>
              <div>AI-powered lead qualification system</div>
            </div>
          </div>

          <div class="chat-body">
            <!-- flow (messages) -->
            <div id="chatFlow" class="chat-flow"></div>

            <!-- sticky score panel (no right white strip) -->
            <div class="score-panel" id="aiScorePanel">
              <h4>ALPS Score</h4>
              <div class="score-bar"><div id="aiScoreFill" class="score-fill score-cold" style="width:0%"></div></div>
              <div id="aiScoreText" style="padding:0 12px 10px;font-weight:700">0 / 100</div>
              <div id="aiScoreTag" style="padding:0 12px 12px;color:var(--muted)">Getting started</div>
            </div>
          </div>
        </div>
      </section>

      <!-- SLA -->
      <section id="sla" class="page">
        <div class="sla-layout">
          <div class="card">
            <h3 id="convListTitle">💬 Active Conversations</h3>
            <div class="meta" id="convSubTitle" style="margin-top:6px">Click a conversation to manage</div>
            <div id="convList" style="margin-top:10px"></div>
          </div>

          <div class="sla-chat">
            <div class="sla-top">
              <div>
                <div id="slaHdrTitle" style="font-weight:800">Select a conversation</div>
                <div id="slaHdrMeta" style="color:#cdd6df">Click a conversation to view details</div>
              </div>
              <div id="slaHdrTimer" class="badge" style="background:rgba(255,255,255,.2)">--:--</div>
            </div>
            <div id="slaFeed" class="sla-feed">
              <div style="text-align:center;color:var(--muted);margin-top:40px">
                <h3>📟 SLA Chat Monitor</h3>
                <p>Select a conversation on the left</p>
              </div>
            </div>
            <div class="sla-input">
              <input id="slaInput" placeholder="Type your message..." onkeypress="if(event.key==='Enter'){sendSlaMsg();}">
              <button onclick="sendSlaMsg()">Send</button>
              <button class="danger" onclick="escalate()">Escalate</button>
            </div>
          </div>
        </div>
      </section>

    </div>
  </main>
</div>

<!-- Lead chart modal -->
<div id="chartModal" class="modal"><div class="box">
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
    <h3 id="chartTitle">Lead Score Progression</h3>
    <button onclick="closeModal()" class="badge" style="background:#eceff1;color:#455a64;border:none;cursor:pointer">Close</button>
  </div>
  <canvas id="leadChart" height="160"></canvas>
  <div id="chartInfo" style="margin-top:12px;color:var(--muted)"></div>
</div></div>

<script>
/* ===========================================================
   GLOBAL STATE
=========================================================== */
const AGENTS = [
  {id:'agent1', name:'Lisa Wong',   status:'available',  sla:90, avg:8.9,  leadsToday:24, top:true},
  {id:'agent2', name:'Mike Johnson',status:'busy',       sla:88, avg:8.7,  leadsToday:21, top:false},
  {id:'agent3', name:'Sarah Chen',  status:'available',  sla:86, avg:8.5,  leadsToday:18, top:false},
  {id:'agent4', name:'David Lim',   status:'break',      sla:84, avg:8.3,  leadsToday:15, top:false},
  {id:'agent5', name:'Jennifer Tan',status:'available',  sla:82, avg:8.1,  leadsToday:12, top:false}
];
// conversations kept per agent & global map
const agentConvs = {agent1:[],agent2:[],agent3:[],agent4:[],agent5:[]};
const convMap = {}; // id -> conv
let rrIndex = 0;     // round robin pointer (follows queue order)
let currentPage = 'agents';
let currentAgentFilter = null; // which agent list is open in SLA
let selectedConvId = null;
let leadChart = null;

/* ===========================================================
   UTIL
=========================================================== */
const $ = sel => document.querySelector(sel);
const $$ = sel => [...document.querySelectorAll(sel)];

function fmt2(n){ return Number(n).toFixed(2); }
function nowTime(){ return new Date().toLocaleTimeString(); }
function pad(n){ return n.toString().padStart(2,'0'); }
function mmss(sec){ const m=Math.floor(sec/60), s=pad(sec%60); return `${m}:${s}`; }

// compute capacity from convs (no random!)
function computeCapacity(agentId){
  const active = agentConvs[agentId].filter(c => !c.aiHandling).length;
  return {used:active, total:10};
}

/* ===========================================================
   NAV + PAGES
=========================================================== */
$$('.nav-item').forEach(item=>{
  item.addEventListener('click',()=>{
    $$('.nav-item').forEach(n=>n.classList.remove('active'));
    item.classList.add('active');
    const page = item.dataset.page;
    currentPage = page;
    $$('.page').forEach(p=>p.classList.remove('active'));
    $('#'+page).classList.add('active');
    const t = {agents:'Agent Status Dashboard',leads:'Lead Management',chat:'AI Chat Interface',sla:'SLA Monitoring'};
    const s = {agents:'Real-time agent monitoring and queue management',leads:'Lead scoring and progression tracking',chat:'AI-powered lead qualification system',sla:'Response time monitoring and escalation'};
    $('#title').textContent=t[page]; $('#subtitle').textContent=s[page];
    if(page==='chat') bootChat();
    if(page==='agents') renderAgents();
    if(page==='leads') refreshLeads();
    if(page==='sla'){ currentAgentFilter=null; renderConvList(); }
  });
});

/* ===========================================================
   AGENT CARDS + QUEUE
=========================================================== */
function renderAgents(){
  const box = $('#agentCards'); box.innerHTML='';
  AGENTS.forEach(a=>{
    const cap = computeCapacity(a.id);
    const busy = cap.used/cap.total >= .8 || a.status==='busy';
    const card = document.createElement('div');
    card.className = `card agent-card ${a.top?'top':''} ${busy?'busy':''} ${a.status==='break'?'break':''}`;
    card.innerHTML = `
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h3>${a.top?'👑 ':''}${a.name}</h3>
        <span class="badge ${a.status==='available'?'b-ok':a.status==='busy'?'b-danger':'b-warn'}">${a.status==='break'?'Break':a.status[0].toUpperCase()+a.status.slice(1)}</span>
      </div>
      <div class="meta" style="margin:6px 0">${a.top?'Top Sales Agent':'Agent'} • Queue Position: ${queueOrder().indexOf(a.id)+1}</div>
      <div class="progress ${busy?'busy':''}" style="margin:8px 0"><span style="width:${(cap.used/cap.total)*100}%"></span></div>
      <div class="meta">Capacity: ${cap.used}/${cap.total} chats</div>
      <div style="display:flex;justify-content:space-between;margin-top:10px">
        <div><div style="font-weight:800">${a.sla}%</div><div class="meta">SLA Rate</div></div>
        <div><div style="font-weight:800">${fmt2(a.avg)}</div><div class="meta">Avg Score</div></div>
        <div><div style="font-weight:800">${a.leadsToday}</div><div class="meta">Leads Today</div></div>
      </div>
    `;
    card.style.cursor='pointer';
    card.onclick = ()=>{
      $('.nav-item[data-page="sla"]').click();
      setTimeout(()=>openAgentInSla(a.id),50);
    };
    box.appendChild(card);
  });

  // queue list
  const q = $('#queueList'); q.innerHTML='';
  queueOrder().forEach((id,i)=>{
    const a=AGENTS.find(x=>x.id===id);
    const row=document.createElement('div');
    row.className='queue-item'; row.draggable=true; row.dataset.agent=id;
    row.innerHTML=`
      <div style="display:flex;align-items:center;gap:12px">
        <div class="drag">≡</div>
        <div>${i===0?'👑 ':''}<strong>${a.name}</strong> - ${i===0?'Top Sales':'Agent'}</div>
      </div>
      <div class="meta">Position: ${i+1}</div>
    `;
    q.appendChild(row);
  });
  wireQueueDrag();
}

function queueOrder(){
  if(!queueOrder._list){
    const list = [...AGENTS].sort((x,y)=> (y.top?1:0) - (x.top?1:0));
    queueOrder._list = list.map(a=>a.id);
  }
  return queueOrder._list;
}

function setQueueOrder(newOrder){
  queueOrder._list = newOrder;
  AGENTS.forEach(a=>a.top = (a.id===newOrder[0]));
  renderAgents();
}

function wireQueueDrag(){
  const list = $('#queueList');
  let dragEl=null;
  list.addEventListener('dragstart',e=>{
    if(e.target.classList.contains('queue-item')){
      dragEl=e.target; e.dataTransfer.effectAllowed="move"; e.target.style.opacity=".5";
    }
  });
  list.addEventListener('dragend',e=>{ if(dragEl) dragEl.style.opacity=""; });
  list.addEventListener('dragover',e=>e.preventDefault());
  list.addEventListener('drop',e=>{
    e.preventDefault();
    const tgt = e.target.closest('.queue-item');
    if(dragEl && tgt && dragEl!==tgt){
      const rect=tgt.getBoundingClientRect();
      const before = e.clientY < rect.top+rect.height/2;
      list.insertBefore(dragEl, before?tgt:tgt.nextSibling);
      const order = [...list.querySelectorAll('.queue-item')].map(x=>x.dataset.agent);
      setQueueOrder(order);
      rrIndex = 0; // reset round-robin pointer
    }
  });
}

/* ===========================================================
   LEAD MGMT LISTS
=========================================================== */
function leadSeverity(score){ return score>=70?'hot':score>=40?'warm':'cold'; }
function refreshLeads(){
  const ongoing = $('#ongoingLeads'); ongoing.innerHTML='';
  Object.values(convMap).forEach(c=>{
    const el=document.createElement('div');
    const sev=leadSeverity(c.score);
    el.className=`lead ${sev}`;
    el.onclick=()=>openChartForConv(c.id);
    const pillClass = sev==='hot'?'pill-hot':sev==='warm'?'pill-warm':'pill-cold';
    el.innerHTML = `
      <div class="pill-score ${pillClass}">${c.score}</div>
      <div>
        <div style="font-weight:800">🔥 Lead ${c.leadNo}</div>
        <div class="meta">Area: ${c.area} • Budget: RM${c.budget} • Agent: ${c.agentName||'AI Bot'}</div>
        <div class="meta">Started: ${new Date(c.createdAt).toLocaleTimeString()} • Status: ${c.aiHandling?'AI Handling':'Assigned'}</div>
      </div>`;
    ongoing.appendChild(el);
  });

  $('#pastLeads').innerHTML='';
}

/* ===========================================================
   CHART MODAL (lead progression)
=========================================================== */
function openChartForConv(convId){
  const c = convMap[convId];
  if(!c) return;
  $('#chartTitle').textContent = `Lead ${c.leadNo} - Score Progression`;
  $('#chartModal').style.display='block';
  const ctx = $('#leadChart').getContext('2d');
  if(leadChart) leadChart.destroy();
  leadChart = new Chart(ctx,{
    type:'line',
    data:{labels:c.scoreHistory.map((_,i)=>i),datasets:[{label:'ALPS',data:c.scoreHistory,fill:true,borderColor:'#3498db',backgroundColor:'rgba(52,152,219,.12)',tension:.4}]},
    options:{plugins:{legend:{display:false}},scales:{y:{min:0,max:100}}}
  });
  $('#chartInfo').textContent = `Current: ${c.score}  •  Min: ${Math.min(...c.scoreHistory)}  •  Max: ${Math.max(...c.scoreHistory)}  •  Growth: +${c.score - c.scoreHistory[0]}`;
}
function closeModal(){ $('#chartModal').style.display='none'; if(leadChart){leadChart.destroy(); leadChart=null;} }

/* ===========================================================
   ROUND ROBIN ROUTING
=========================================================== */
function nextAgentForAssignment(){
  const order = queueOrder();
  const total = order.length;
  for(let i=0;i<total;i++){
    const idx = (rrIndex + i) % total;
    const id = order[idx];
    const a = AGENTS.find(x=>x.id===id);
    if(a.status!=='available') continue;
    const cap = computeCapacity(id);
    if(cap.used < cap.total){
      rrIndex = (idx+1) % total; // advance pointer
      return a;
    }
  }
  return null;
}

/* ===========================================================
   AI CHAT (lead intake)
=========================================================== */
const AREAS = ["KL/Selangor","Perak","JB/Penang","Negeri Sembilan","Genting Highlands"];
const PROPERTIES = ["121 Residence","7 Tree Seven","Acacia Residence","Ara Damansara","Ampang","Arte Cheras","Astoria","Austin Regency","Bandar Sri Permaisuri","Bora Residence","Bukit Jalil","Cheras","Duta Park","Emporis Kota Damansara","Epic Residence","HighPark Suites","Icon City","Kelana Jaya","Kota Damansara","M Vertica","Majestic Maxim","Meta City","Mont Kiara","One Cochrane","Parc3","Petaling Jaya","Pinnacle","Razak City Residences","Rica Residence","Sentul","Setapak","Subang Jaya","Sunway Avila","Sunway Serene","Trion KL","Vista Sentul","Vivo Residence"];

const QUESTIONS = [
  {id:'area', text:"Choose an area:", type:'select', options:AREAS, weight:15},
  {id:'property', text:"Great choice! Select a property:", type:'property', weight:10},
  {id:'budget', text:"What's your budget (RM)?", type:'input', placeholder:'e.g. 800', weight:25},
  {id:'pax', text:"How many people will be staying?", type:'select', options:['1 person','2 people','More than 2'], weight:10},
  {id:'car', text:"Do you have a car?", type:'select', options:['Yes','No'], weight:5},
  {id:'parking', text:"Do you need a car park lot?", type:'select', options:['Yes','No'], weight:5},
  {id:'movein', text:"When are you planning to move in?", type:'date', weight:20},
  {id:'tenancy', text:"What's your preferred tenancy period?", type:'select', options:['6 months','12 months'], weight:5},
  {id:'gender', text:"What's your gender?", type:'select', options:['Male','Female'], weight:0},
  {id:'unit_spec', text:"What type of unit do you prefer? (You can select multiple)", type:'multi', options:['Female unit','Male unit','Mixed Gender unit'], weight:5},
  {id:'workplace', text:"Where is your workplace? (to recommend closest property)", type:'input', placeholder:'e.g., KLCC, Cyberjaya', weight:10},
  {id:'nationality', text:"What's your nationality?", type:'select', options:['Malaysian','Others'], weight:0},
];

let aiStep=0, aiAns={}, aiScore=0;

function bootChat(){
  aiStep=0; aiAns={}; aiScore=0;
  $('#chatFlow').innerHTML='';
  updateAiScore();
  ask(0);
}
function ask(i){
  if(i>=QUESTIONS.length){ finalizeLeadFromAI(); return; }
  aiStep=i;
  const q=QUESTIONS[i];
  addBot(q.text + (q.type==='input' ? `<div class="meta">Press Enter to submit</div>` : ''));
  if(q.type==='select'){
    const box=document.createElement('div'); box.className='options';
    q.options.forEach(o=>{
      const b=document.createElement('div'); b.className='btn-opt'; b.textContent=o;
      b.onclick=()=>choose(q.id,o,q.weight);
      box.appendChild(b);
    });
    $('#chatFlow').appendChild(box); scrollBottom();
  }else if(q.type==='property'){
    const box=document.createElement('div'); box.className='grid-choices';
    PROPERTIES.slice(0,12).forEach(p=>{
      const c=document.createElement('div'); c.className='choice'; c.textContent=p;
      c.onclick=()=>choose(q.id,p,q.weight);
      box.appendChild(c);
    });
    $('#chatFlow').appendChild(box); scrollBottom();
  }else if(q.type==='input'){
    const ip=document.createElement('input');
    ip.className='btn-opt'; ip.style.textAlign='left'; ip.placeholder=q.placeholder||'';
    ip.onkeypress=(e)=>{ if(e.key==='Enter' && ip.value.trim()) choose(q.id,ip.value.trim(),q.weight); };
    $('#chatFlow').appendChild(ip); ip.focus(); scrollBottom();
  }else if(q.type==='date'){
    const ip=document.createElement('input'); ip.type='date'; ip.className='btn-opt'; ip.onchange=()=>choose(q.id,ip.value,q.weight);
    $('#chatFlow').appendChild(ip); scrollBottom();
  }else if(q.type==='multi'){
    const box=document.createElement('div'); box.className='checkbox-group'; box.id='group_'+q.id;
    q.options.forEach((o,idx)=>{
      const w=document.createElement('label'); w.className='checkbox-chip'; w.dataset.key=`${q.id}_${idx}`;
      w.innerHTML=`<input type="checkbox" value="${o}"><span>${o}</span>`;
      w.onclick=(e)=>{ if(e.target.tagName!=='INPUT'){const cb=w.querySelector('input'); cb.checked=!cb.checked;} w.classList.toggle('selected', w.querySelector('input').checked); };
      box.appendChild(w);
    });
    const go=document.createElement('button'); go.className='btn-continue'; go.textContent='Continue';
    go.onclick=()=>{
      const vals=[...box.querySelectorAll('input:checked')].map(i=>i.value);
      if(!vals.length) return alert('Please select at least one option');
      choose(q.id, vals, q.weight);
    };
    const wrap=document.createElement('div'); wrap.style.marginTop='10px'; wrap.appendChild(go);
    $('#chatFlow').appendChild(box); $('#chatFlow').appendChild(wrap); scrollBottom();
  }
}

function choose(id,value,weight){
  addUser(Array.isArray(value)? value.join(', ') : value);
  aiAns[id]=value;

  // follow-up for "Others" nationality → free text
  if(id==='nationality' && value==='Others'){
    addBot('Please specify your nationality:');
    const ip=document.createElement('input'); ip.className='btn-opt';
    ip.onkeypress=(e)=>{ if(e.key==='Enter' && ip.value.trim()){ aiAns['nationality_other']=ip.value.trim(); scoreFromAnswer('nationality_other', ip.value.trim(), 6); ask(aiStep+1);} };
    $('#chatFlow').appendChild(ip); ip.focus(); scrollBottom();
    return;
  }

  scoreFromAnswer(id,value,weight);
  ask(aiStep+1);
}

function scoreFromAnswer(id,val,weight){
  let inc=0;
  if(id==='area'||id==='property'){inc=weight;}
  else if(id==='budget'){ const b=parseInt(val); if(!isNaN(b)) inc=b>=800?weight:b>=600?weight*.7:b>=400?weight*.4:weight*.1; }
  else if(id==='movein'){ const d=new Date(val), t=new Date(), diff=Math.ceil((d-t)/86400000); if(!isNaN(diff)) inc=diff<=7?weight:diff<=30?weight*.8:diff<=60?weight*.6:weight*.3; }
  else if(id==='nationality_other'){ inc=val.toLowerCase().includes('student')?weight*.6:weight*.4; }
  else inc=weight*.8;
  aiScore = Math.max(0, Math.min(100, aiScore + inc));
  updateAiScore();
}

function addBot(html){ const d=document.createElement('div'); d.className='message message-bot'; d.innerHTML=html; $('#chatFlow').appendChild(d); scrollBottom(); }
function addUser(html){ const d=document.createElement('div'); d.className='message message-user'; d.innerHTML=html; $('#chatFlow').appendChild(d); scrollBottom(); }
function scrollBottom(){ const f=$('#chatFlow'); f.scrollTop = f.scrollHeight; }

function updateAiScore(){
  const bar=$('#aiScoreFill'); const txt=$('#aiScoreText'); const tag=$('#aiScoreTag');
  const pct=Math.round(aiScore);
  bar.style.width=pct+'%';
  bar.className='score-fill '+(pct>=70?'score-hot':pct>=40?'score-warm':'score-cold');
  txt.textContent=`${pct} / 100`;
  tag.textContent = pct>=70?'Hot Lead 🔥':pct>=40?'Warm Lead ⭐':'Cold Lead ❄️';
}

function finalizeLeadFromAI(){
  const best = nextAgentForAssignment();
  const leadNo = '#'+(200000 + Object.keys(convMap).length + 6);
  const newConv = {
    id:'conv_'+Date.now(),
    leadNo,
    createdAt:Date.now(),
    area: aiAns.area || 'KL/Selangor',
    budget: aiAns.budget || 'N/A',
    score: Math.round(aiScore),
    scoreHistory:[0, Math.round(aiScore)],
    messages: [{type:'system',text:`Lead ${leadNo} created from AI chat.`,time:nowTime()}],
    status:'waiting',
    timer:{type:'initial',left:300,over:0},
    aiHandling:false
  };

  if(best){
    newConv.agentId = best.id; newConv.agentName = best.name;
    newConv.messages.push({type:'system',text:`Lead ${leadNo} has been assigned to you. Area: ${newConv.area}, Budget: ${newConv.budget}, Move-in: ${aiAns.movein||'—'}`,time:nowTime()});
    agentConvs[best.id].push(newConv);
  }else{
    newConv.aiHandling=true; newConv.status='ai_handling'; newConv.agentId=null; newConv.agentName=null;
    newConv.messages.push({type:'system',text:`All agents busy. AI assistant is handling this lead for now.`,time:nowTime()});
  }
  convMap[newConv.id]=newConv;

  if(best){
    addBot(`
      <div style="background:#e3f2fd;border-left:4px solid #2196f3;border-radius:12px;padding:12px">
        <h3 style="margin-bottom:6px">Lead routed!</h3>
        <div><strong>Assigned to:</strong> ${best.name}</div>
        <div><strong>Lead ID:</strong> ${leadNo}</div>
        <div>Our agent will contact you shortly.</div>
      </div>
    `);
  }else{
    addBot(`
      <div style="background:#fff3e0;border-left:4px solid #fb8c00;border-radius:12px;padding:12px">
        <h3 style="margin-bottom:6px">Added to priority queue</h3>
        <div>We're currently busy. AI will assist you while we free an agent.</div>
      </div>
    `);
  }

  renderAgents(); refreshLeads();
  if(currentPage==='sla') renderConvList();
}

/* ===========================================================
   SLA LIST + CHAT
=========================================================== */
function renderOneConvList(div, c){
  let cls='', timerText='', pill='t-neg', desc='Next response due';
  if(c.timer.over>0){ cls='breach'; timerText='+'+mmss(c.timer.over); pill='t-pos'; desc='SLA breached'; }
  else { timerText='-'+mmss(c.timer.left); cls = c.timer.left<=60?'warning':''; if(c.timer.type==='initial') desc='Initial response due'; }
  if(c.aiHandling){ cls=''; pill='t-neg'; desc='AI handling'; }

  div.className='conv '+cls;
  div.innerHTML=`
    <div style="display:flex;justify-content:space-between;align-items:flex-start">
      <div>
        <div style="font-weight:800">Lead ${c.leadNo} • ${c.agentName || 'AI Bot'}</div>
        <div class="meta">${c.area} • ALPS: ${c.score}${c.aiHandling?' • AI handling':''}</div>
      </div>
      <div class="meta">${c.status==='ongoing'?'Active':''}</div>
    </div>
    <div style="display:flex;align-items:center;gap:10px;margin-top:6px">
      <span class="timer-pill ${pill}">${timerText}</span>
      <span class="meta">${desc}</span>
    </div>`;
}

function renderConvList(){
  const list = $('#convList'); list.innerHTML='';
  $('#convListTitle').textContent = currentAgentFilter ? `💬 ${AGENTS.find(a=>a.id===currentAgentFilter).name}'s Conversations` : '💬 Active Conversations';
  $('#convSubTitle').textContent = currentAgentFilter ? `Active: ${agentConvs[currentAgentFilter].length} conversations` : 'Click a conversation to manage';

  const sourceConvs = currentAgentFilter ? agentConvs[currentAgentFilter] : Object.values(convMap);
  if(!sourceConvs.length){
    list.innerHTML = `<div class="meta" style="padding:16px">No active conversations</div>`;
    return;
  }

  sourceConvs.forEach((c,i)=>{
    const el=document.createElement('div'); el.onclick=()=>openConv(c.id);
    renderOneConvList(el,c);
    list.appendChild(el);
    if(i===0 && !selectedConvId) openConv(c.id);
  });
}

function openAgentInSla(agentId){
  currentAgentFilter = agentId;
  selectedConvId = null;
  renderConvList();
}

function openConv(id){
  selectedConvId=id;
  const c = convMap[id];
  if(!c) return;

  $('#slaHdrTitle').textContent = `Lead ${c.leadNo} - ${c.agentName || 'AI Bot'}`;
  $('#slaHdrMeta').textContent = `${c.area} • ALPS: ${c.score} • ${c.aiHandling?'AI handling': (c.status==='ongoing'?'Ongoing conversation':'Waiting for agent response')}`;

  const t = c.timer;
  $('#slaHdrTimer').textContent = (t.over>0?'+':'-') + mmss(t.over>0?t.over:t.left);

  const feed = $('#slaFeed'); feed.innerHTML='';
  c.messages.forEach(m=>{
    const div=document.createElement('div');
    let cls='message-bot';
    if(m.type==='customer') cls='message-user';
    if(m.type==='system') cls='message-system';
    div.className='message '+cls;
    div.innerHTML = `<div>${m.text}</div><div class="meta" style="margin-top:4px">${m.time}</div>`;
    feed.appendChild(div);
  });
  feed.scrollTop = feed.scrollHeight;
}

function sendSlaMsg(){
  const ip=$('#slaInput'); const text=ip.value.trim(); if(!text || !selectedConvId) return;
  ip.value='';
  const c=convMap[selectedConvId];
  c.messages.push({type:c.aiHandling?'bot':'agent',text, time:nowTime()});
  if(c.status==='waiting') c.status='ongoing';
  c.timer.type='ongoing'; c.timer.left=600; c.timer.over=0;
  updateConvScore(c, +2);
  openConv(c.id);

  setTimeout(()=>{
    const replies=["Sounds good!","Thanks! That helps.","👍","Can view today?","Ok noted."];
    const r = replies[Math.floor(Math.random()*replies.length)];
    c.messages.push({type:'customer', text:r, time:nowTime()});
    const drift = Math.random()<.35 ? -6 : +1;
    updateConvScore(c, drift);
    openConv(c.id);
  }, 1500);
}

function escalate(){
  if(!selectedConvId) return;
  const c=convMap[selectedConvId];
  c.messages.push({type:'system',text:'Conversation escalated. Supervisor will take over.',time:nowTime()});
  updateConvScore(c, +0); openConv(c.id);
}

function updateConvScore(c, delta){
  c.score = Math.max(0, Math.min(100, c.score + delta));
  c.scoreHistory.push(c.score);
  if(!c.aiHandling && c.score<=25){
    c.aiHandling = true;
    c.messages.push({type:'system',text:'Lead became low quality. AI assistant has joined and the agent capacity is freed.',time:nowTime()});
    if(c.agentId){
      agentConvs[c.agentId] = agentConvs[c.agentId].filter(x=>x.id!==c.id);
      c.agentId = null; c.agentName=null; c.status='ai_handling';
    }
    c.timer={type:'ai',left:0,over:0};
    renderAgents();
  }
  if(currentPage==='sla'){
    renderConvList();
    if(selectedConvId===c.id) openConv(c.id);
  }
  refreshLeads();
}

/* ===========================================================
   TIMERS TICK (1s)
=========================================================== */
setInterval(()=>{
  $('#lastUpdate').textContent = nowTime();
  Object.values(convMap).forEach(c=>{
    const t=c.timer;
    if(t.type==='ai') return;
    if(t.over>0){ t.over++; }
    else if(t.left>0){ t.left--; if(t.left===0){ t.over=1; if(t.type==='initial'){
      const next = nextAgentForAssignment();
      if(next){
        if(c.agentId){
          agentConvs[c.agentId]=agentConvs[c.agentId].filter(x=>x.id!==c.id);
        }
        c.agentId=next.id; c.agentName=next.name;
        agentConvs[next.id].push(c);
        c.messages.push({type:'system',text:`Conversation reassigned to ${next.name} due to initial response timeout.`,time:nowTime()});
        c.status='waiting';
        c.timer={type:'initial',left:300,over=0};
        renderAgents();
        if(currentPage==='sla'){
          renderConvList();
          if(selectedConvId===c.id) openConv(c.id);
        }
      } else {
        c.aiHandling=true; c.agentId=null; c.agentName=null; c.status='ai_handling'; c.timer={type:'ai',left:0,over:0};
        c.messages.push({type:'system',text:`No agent available. AI assistant continues this conversation.`,time:nowTime()});
        renderAgents(); if(currentPage==='sla') renderConvList();
      }
    }}}
  });

  if(currentPage==='sla'){ renderConvList(); }
}, 1000);

/* ===========================================================
   SLA: open from Agent cards
=========================================================== */
function openAgent(agentId){ $('.nav-item[data-page="sla"]').click(); setTimeout(()=>openAgentInSla(agentId),60); }

/* ===========================================================
   INITIAL RENDER + SEEDS
=========================================================== */
renderAgents(); refreshLeads();

</script>
</body>
</html>







