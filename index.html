<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>BeLive ALPS Management Dashboard</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
<style>
  *{margin:0;padding:0;box-sizing:border-box}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;background:#f5f6fa;height:100vh;overflow:hidden}
  .dashboard{display:flex;height:100vh}
  .sidebar{width:280px;background:#2c3e50;color:#fff;padding:20px;overflow-y:auto}
  .nav-item{padding:15px;margin:5px 0;border-radius:8px;cursor:pointer;display:flex;gap:10px;align-items:center;transition:.2s}
  .nav-item:hover,.nav-item.active{background:#34495e;transform:translateX(4px)}
  .nav-icon{font-size:20px}
  .main-content{flex:1;display:flex;flex-direction:column;overflow:hidden}
  .header{background:#fff;padding:20px;box-shadow:0 2px 10px rgba(0,0,0,.08);display:flex;justify-content:space-between;align-items:center}
  .content-area{flex:1;padding:20px;overflow-y:auto}
  .page{display:none}.page.active{display:block}

  .live-indicator{display:inline-flex;gap:6px;align-items:center;background:#e74c3c;color:#fff;padding:5px 10px;border-radius:14px;font-size:12px;font-weight:700}
  .pulse-dot{width:8px;height:8px;border-radius:50%;background:#fff;animation:pulse 2s infinite}
  @keyframes pulse{0%{opacity:1}50%{opacity:.5}100%{opacity:1}}

  .agents-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:20px;margin-bottom:30px}
  .agent-card{background:#fff;border-radius:15px;padding:20px;box-shadow:0 4px 14px rgba(0,0,0,.08);cursor:pointer;border-left:5px solid #3498db;transition:.2s}
  .agent-card:hover{transform:translateY(-4px)}
  .agent-card.top-sales{border-left-color:#f39c12;background:linear-gradient(135deg,#fff9e6,#fff)}
  .agent-card.available{border-left-color:#2ecc71}
  .agent-card.busy{border-left-color:#e74c3c}
  .agent-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
  .agent-name{font-weight:700}
  .agent-status{padding:5px 12px;border-radius:20px;font-size:12px;font-weight:700}
  .status-available{background:#2ecc71;color:#fff}
  .status-busy{background:#e74c3c;color:#fff}
  .capacity-bar{background:#ecf0f1;height:12px;border-radius:6px;overflow:hidden;margin:10px 0}
  .capacity-fill{height:100%;border-radius:6px;transition:width .4s}
  .capacity-low{background:#2ecc71}.capacity-medium{background:#f39c12}.capacity-high{background:#e74c3c}
  .agent-stats{display:flex;justify-content:space-between;margin-top:12px}
  .stat-item{text-align:center}.stat-number{font-weight:800;color:#2c3e50}

  .queue-management{background:#fff;border-radius:15px;padding:20px;box-shadow:0 4px 14px rgba(0,0,0,.08)}
  .queue-item{display:flex;justify-content:space-between;align-items:center;padding:14px;margin:10px 0;background:#f8f9fa;border-left:4px solid #3498db;border-radius:10px;cursor:move}
  .drag-handle{cursor:grab;color:#7f8c8d;font-size:18px}

  .leads-container{display:grid;grid-template-columns:1fr 1fr;gap:30px;height:100%}
  .leads-section{background:#fff;border-radius:15px;padding:20px;box-shadow:0 4px 14px rgba(0,0,0,.08);display:flex;flex-direction:column;overflow:hidden}
  .section-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;padding-bottom:12px;border-bottom:2px solid #ecf0f1}
  .leads-list{flex:1;overflow-y:auto}
  .lead-item{display:flex;gap:12px;align-items:center;background:#f8f9fa;border-radius:12px;padding:14px;margin:10px 0;border-left:4px solid #95a5a6;cursor:pointer;transition:.2s}
  .lead-item:hover{transform:translateX(4px)}
  .lead-item.hot{border-left-color:#e74c3c;background:linear-gradient(135deg,#ffebee,#f8f9fa)}
  .lead-item.warm{border-left-color:#f39c12;background:linear-gradient(135deg,#fff8e1,#f8f9fa)}
  .lead-score{width:56px;height:56px;border-radius:50%;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:800}
  .score-hot{background:linear-gradient(135deg,#e74c3c,#c0392b)}
  .score-warm{background:linear-gradient(135deg,#f39c12,#e67e22)}
  .score-cold{background:linear-gradient(135deg,#95a5a6,#7f8c8d)}
  .lead-name{font-weight:700}
  .lead-details{font-size:14px;color:#7f8c8d}
  .lead-timestamp{font-size:12px;color:#b4bcc2}

  .chat-container{background:#fff;border-radius:15px;box-shadow:0 4px 14px rgba(0,0,0,.08);height:100%;display:flex;flex-direction:column;position:relative}
  .chat-header{background:#25D366;color:#fff;padding:18px;border-radius:15px 15px 0 0;display:flex;justify-content:space-between}
  .chat-messages{flex:1;overflow-y:auto;padding:18px;background:#e5ddd5;position:relative}
  .message{max-width:70%;padding:12px 16px;margin:10px 0;border-radius:18px;display:flex;flex-direction:column}
  .message-bot{background:#fff;align-self:flex-start;border-bottom-left-radius:4px;box-shadow:0 1px 2px rgba(0,0,0,.08)}
  .message-user{background:#DCF8C6;align-self:flex-end;border-bottom-right-radius:4px;margin-left:auto;box-shadow:0 1px 2px rgba(0,0,0,.08)}
  .message-system{background:#fff3cd!important;border:2px solid #ffeaa7!important;text-align:center!important;max-width:90%!important;margin:10px auto!important}
  .message-ai-takeover{background:#e3f2fd!important;border:2px solid #2196f3!important;text-align:center!important;max-width:90%!important;margin:10px auto!important}

  .score-display{position:fixed;top:130px;right:20px;background:rgba(255,255,255,.98);padding:14px;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,.12);min-width:200px;z-index:1000}
  .score-bar{height:20px;background:#e0e0e0;border-radius:10px;overflow:hidden;margin:8px 0}
  .score-fill{height:100%;border-radius:10px;transition:width .4s}

  .sla-container{display:grid;grid-template-columns:1fr 2fr;gap:20px;height:100%}
  .conversations-list{background:#fff;border-radius:15px;padding:20px;box-shadow:0 4px 14px rgba(0,0,0,.08);overflow-y:auto}
  .conversation-item{padding:14px;margin:10px 0;background:#f8f9fa;border-radius:10px;border-left:4px solid #3498db;cursor:pointer;transition:.2s;position:relative}
  .conversation-item:hover{background:#e3f2fd;transform:translateX(4px)}
  .conversation-item.sla-warning{border-left-color:#f39c12;background:#fff8e1}
  .conversation-item.sla-breach{border-left-color:#e74c3c;background:#ffebee}
  .sla-timer{display:flex;gap:10px;align-items:center;margin-top:8px}
  .timer-badge{padding:5px 10px;border-radius:14px;font-weight:800;font-size:12px}
  .timer-negative{background:#f39c12;color:#fff}
  .timer-positive{background:#e74c3c;color:#fff}
  .timer-ai{background:#3498db;color:#fff}
  .sla-chat-area{background:#fff;border-radius:15px;box-shadow:0 4px 14px rgba(0,0,0,.08);display:flex;flex-direction:column}
  .sla-chat-header{background:#34495e;color:#fff;padding:18px;border-radius:15px 15px 0 0;display:flex;justify-content:space-between;align-items:center}
  .sla-messages{flex:1;overflow-y:auto;padding:18px;background:#f8f9fa}
  .sla-input{display:flex;gap:10px;padding:18px;border-top:1px solid #ecf0f1}
  .sla-input input{flex:1;padding:12px;border:2px solid #ecf0f1;border-radius:22px;outline:none}
  .sla-input button{padding:12px 18px;border:none;border-radius:22px;color:#fff;background:#25D366;cursor:pointer}

  .deal-button{background:#28a745;color:white;border:none;padding:10px 20px;border-radius:20px;cursor:pointer;font-weight:700;margin-left:10px}
  .deal-button:hover{background:#218838}

  .options-container{display:flex;flex-direction:column;gap:8px;margin-top:10px}
  .option-button{padding:10px 14px;background:#f0f0f0;border:2px solid #e0e0e0;border-radius:20px;cursor:pointer;text-align:center;transition:.2s}
  .option-button:hover{background:#25D366;color:#fff;border-color:#25D366}
  .property-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:10px;margin-top:10px}
  .property-item{padding:12px;background:#f8f9fa;border:2px solid #e9ecef;border-radius:12px;text-align:center;cursor:pointer;transition:.2s}
  .property-item:hover{background:#25D366;color:#fff;border-color:#25D366}
  .input-field{width:100%;padding:12px;border:2px solid #e0e0e0;border-radius:20px;margin-top:10px;outline:none}
  .input-field:focus{border-color:#25D366}
  .typing-indicator{display:none;background:#fff;padding:14px;border-radius:18px;max-width:70%;border-bottom-left-radius:4px}
  .typing-dots{display:flex;gap:4px}.typing-dot{width:8px;height:8px;background:#999;border-radius:50%;animation:typing 1.4s infinite}
  .typing-dot:nth-child(2){animation-delay:.2s}.typing-dot:nth-child(3){animation-delay:.4s}
  @keyframes typing{0%,60%,100%{transform:translateY(0)}30%{transform:translateY(-8px)}}

  .checkbox-group{margin-top:10px}
  .checkbox-item{display:flex;align-items:center;gap:8px;padding:8px;margin:4px 0;border-radius:8px;cursor:pointer;transition:.2s}
  .checkbox-item:hover,.checkbox-item.selected{background:#e8f5e8}
  .checkbox-item input{margin:0}
  .continue-btn{margin-top:10px;padding:10px 20px;background:#25D366;color:#fff;border:none;border-radius:20px;cursor:pointer}
  .continue-btn:hover{background:#1ea952}

  .modal{display:none;position:fixed;z-index:1000;inset:0;background:rgba(0,0,0,.5)}
  .modal-content{background:#fff;margin:5% auto;padding:24px;border-radius:14px;width:80%;max-width:820px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
  .close{float:right;font-size:26px;cursor:pointer;color:#666}
  .close:hover{color:#333}
  .btn{padding:10px 18px;border:none;border-radius:8px;cursor:pointer;font-weight:700;transition:.2s}
  .btn:hover{transform:translateY(-1px)}
  .btn-primary{background:#3498db;color:#fff}.btn-primary:hover{background:#2980b9}
  .btn-danger{background:#e74c3c;color:#fff}.btn-danger:hover{background:#c0392b}

  .sla-alert{position:fixed;z-index:1100;top:50%;left:50%;transform:translate(-50%,-50%);background:#fff;padding:26px;border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.3);display:none;border-left:5px solid #e74c3c;max-width:500px}
  .alert-actions{display:flex;gap:12px;margin-top:16px;justify-content:center}

  .live-score-badge{position:absolute;top:5px;right:5px;background:#3498db;color:#fff;padding:2px 8px;border-radius:10px;font-size:11px;font-weight:700}

  .message-score{position:absolute;top:5px;right:5px;background:rgba(52,152,219,.1);border:1px solid #3498db;color:#3498db;padding:2px 6px;border-radius:8px;font-size:10px;font-weight:700}

  .debug-info{position:fixed;bottom:10px;right:10px;background:rgba(0,0,0,0.8);color:white;padding:10px;border-radius:8px;font-family:monospace;font-size:12px;max-width:300px;z-index:1000}

  .status-indicator{font-size:12px;font-weight:600}

  @media(max-width:900px){
    .leads-container{grid-template-columns:1fr}
    .sla-container{grid-template-columns:1fr}
    .chat-container{padding-right:0}
    .score-display{position:relative;top:0;right:0;margin:10px}
  }
</style>
</head>
<body>
<div class="dashboard">
  <div class="sidebar">
    <h2 style="margin-bottom:24px">🏠 BeLive ALPS</h2>
    <div class="nav-item active" data-page="agents"><span class="nav-icon">👥</span><span>Agent Status</span></div>
    <div class="nav-item" data-page="leads"><span class="nav-icon">📊</span><span>Lead Management</span></div>
    <div class="nav-item" data-page="chat"><span class="nav-icon">💬</span><span>Chat Window</span></div>
    <div class="nav-item" data-page="sla"><span class="nav-icon">⏱️</span><span>SLA Monitoring</span></div>

    <div style="margin-top:36px;padding:16px;background:rgba(255,255,255,.1);border-radius:10px">
      <div class="live-indicator"><div class="pulse-dot"></div>LIVE</div>
      <div style="margin-top:10px;font-size:14px">
        System Status: Active<br/>Last Update: <span id="lastUpdate">--:--:--</span>
      </div>
    </div>
  </div>

  <div class="main-content">
    <div class="header">
      <div>
        <h1 id="pageTitle">Agent Status Dashboard</h1>
        <p id="pageSubtitle">Real-time agent monitoring and queue management</p>
      </div>
      <div class="live-indicator"><div class="pulse-dot"></div>LIVE DASHBOARD</div>
    </div>

    <div class="content-area">
      <!-- Agents -->
      <div id="agents" class="page active">
        <div class="agents-grid" id="agentsGrid">
          <!-- populated by JS -->
        </div>

        <div class="queue-management">
          <h3 style="margin-bottom:12px">📋 Agent Queue Management</h3>
          <p style="margin-bottom:10px;color:#7f8c8d">Drag to reorder priority • Position 1 automatically becomes Top Sales</p>
          <div id="queueList"></div>
        </div>
      </div>

      <!-- Leads -->
      <div id="leads" class="page">
        <div class="leads-container">
          <div class="leads-section">
            <div class="section-header">
              <h3>🔥 Ongoing Leads</h3>
              <div class="live-indicator"><div class="pulse-dot"></div>LIVE</div>
            </div>
            <div class="leads-list" id="ongoingLeads"></div>
          </div>

          <div class="leads-section">
            <div class="section-header">
              <h3>📋 Past Leads</h3>
              <div style="font-size:14px;color:#7f8c8d">Last 24 hours</div>
            </div>
            <div class="leads-list" id="pastLeads"></div>
          </div>
        </div>
      </div>

      <!-- Chat -->
      <div id="chat" class="page">
        <div class="chat-container">
          <div class="chat-header">
            <div>
              <h3>🤖 BeLive AI Assistant</h3>
              <div>Lead Qualification Chat • No Timer (AI Handling)</div>
            </div>
          </div>

          <div class="chat-messages" id="chatMessages">
            <div class="typing-indicator" id="typingIndicator">
              <div class="typing-dots">
                <div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- SLA -->
      <div id="sla" class="page">
        <div class="sla-container">
          <div class="conversations-list" id="conversationsList">
            <!-- populated by JS -->
          </div>

          <div class="sla-chat-area">
            <div class="sla-chat-header">
              <div>
                <h3 id="slaCurrentChat">Select a conversation</h3>
                <div id="slaCurrentDetails">Click on a conversation to view details</div>
              </div>
              <div id="slaCurrentTimer" style="background:rgba(255,255,255,.2);padding:10px;border-radius:10px">--:--</div>
            </div>

            <div class="sla-messages" id="slaMessages">
              <div style="text-align:center;color:#7f8c8d;margin-top:40px">
                <h3>💬 SLA Chat Monitor</h3>
                <p>Select a conversation from the left to view and manage the chat</p>
              </div>
            </div>

            <div class="sla-input" id="slaInputArea" style="display:none">
              <input id="slaMessageInput" type="text" placeholder="Type your message..." onkeypress="handleSLAMessage(event)"/>
              <button onclick="sendSLAMessage()">Send</button>
              <button onclick="escalateConversation()" style="background:#e74c3c">Escalate</button>
              <button onclick="markDeal()" class="deal-button">Mark as Deal ✓</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Fixed Score Display -->
<div class="score-display" id="scoreFloater" style="display:none">
  <h4>ALPS Score</h4>
  <div class="score-bar"><div class="score-fill score-cold" id="chatScoreBar" style="width:0%"></div></div>
  <div id="chatScoreText">0 / 100</div>
  <div id="chatScoreCategory">Getting Started</div>
</div>

<!-- Debug Info -->
<div class="debug-info" id="debugInfo" style="display:none">
  <div>Last API Call: <span id="lastApiCall">None</span></div>
  <div>Features Sent: <span id="featuresSent">None</span></div>
  <div>Score Received: <span id="scoreReceived">None</span></div>
  <div>Using Server: <span id="usingServer">No</span></div>
</div>

<!-- Lead Chart Modal -->
<div id="chartModal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeModal()">&times;</span>
    <h2 id="chartTitle">Lead Score Progression</h2>
    <canvas id="leadChart" width="400" height="200"></canvas>
    <div id="chartDetails" style="margin-top:12px"></div>
  </div>
</div>

<!-- SLA Alert -->
<div id="slaAlert" class="sla-alert">
  <h3>🚨 SLA BREACH ALERT</h3>
  <p>Agent has not responded within the SLA timeframe</p>
  <div style="margin:12px 0;padding:12px;background:#fff3cd;border-radius:8px">
    <strong>Conversation:</strong> <span id="alertConversation">Lead #</span><br/>
    <strong>Agent:</strong> <span id="alertAgent">-</span><br/>
    <strong>Time Exceeded:</strong> <span id="alertTime">+0:01</span>
  </div>
  <div class="alert-actions">
    <button class="btn btn-primary" onclick="goToConversation()">Go to Conversation</button>
    <button class="btn btn-danger" onclick="reassignConversation()">Reassign</button>
  </div>
</div>

<script>
'use strict';

/* ======= CONFIG ======= */
const MODEL_SOURCE = 'server';
const SCORE_ENDPOINT = 'https://web-production-11d29.up.railway.app/api/score';
const LOW_SCORE_THRESHOLD = 41;
const WARM_SCORE_THRESHOLD = 41;
const HOT_SCORE_THRESHOLD = 51;
const INITIAL_RESPONSE_TIMEOUT = 60;
const ONGOING_RESPONSE_TIMEOUT = 60;
const MAX_AGENT_CAPACITY = 3;
const DEBUG_MODE = false;

if (DEBUG_MODE) {
  document.getElementById('debugInfo').style.display = 'block';
}

/* ======= GLOBAL STATE ======= */
let currentPage = 'agents';
let currentListView = {type:'all', id:null};
let selectedConversation = null;
let lastAlertConvId = null;

let leadChart = null;
let realTimeInterval;
let nextAgentIndex = 0;

const agentOrder = ['agent1','agent2','agent3','agent4','agent5'];
const AGENTS = {
  agent1:{name:'Sarah Chen', role:'Agent', status:'available'},
  agent2:{name:'Mike Johnson', role:'Agent', status:'available'},
  agent3:{name:'Lisa Wong', role:'Agent', status:'available'},
  agent4:{name:'David Lim', role:'Agent', status:'available'},
  agent5:{name:'Jennifer Tan', role:'Agent', status:'available'}
};
const agentConversations = {agent1:[],agent2:[],agent3:[],agent4:[],agent5:[]};
const activeConversations = {};

let nextLeadId = 2024010;
let completedLeads = [];
let allLeadsDatabase = [];

let chatCurrentStep = 0;
let chatUserResponses = {};
let chatAlpsScore = 0;

const AREAS = ["KL/Selangor","Perak","JB/Penang","Negeri Sembilan","Genting Highlands"];
const PROPERTIES = ["121 Residence","7 Tree Seven","Acacia Residence","Ara Damansara","Ampang","Arte Cheras","Astoria","Austin Regency","Bandar Sri Permaisuri","Bora Residence","Bukit Jalil","Cheras","D'Cosmos","Duta Park","Emporis Kota Damansara","Epic Residence","HighPark Suites","Icon City","Kelana Jaya","Keramat","Kota Damansara","M Vertica","Majestic Maxim","Medini Signature","Meta City","MH Platinum 2","Mont Kiara","One Cochrane","Parc3","Petaling Jaya","Pinnacle","Platinum Splendor","Razak City Residences","Rica Residence","Sentul","Setapak","Subang Jaya","Sunway Avila","Sunway Serene","Trion KL","Vista Sentul","Vivo Residence"];

const questions = [
  // Location → modeling needs 'area' & 'property'
  { id:'area', type:'select', weight:15,
    text:"Welcome to BeLive! Which area are you searching in?",
    options: AREAS
  },
  { id:'property', type:'property_select', weight:10,
    text:"Great choice! Pick a property in that area"
  },

  // Budget (numeric) → keep UI 'input' and we’ll parse to number
  { id:'budget', type:'input', weight:25,
    text:"What's your monthly budget (RM)?", placeholder:"e.g., 800"
  },

  // Occupancy → modeling expects 1 / 2 / 3+
  { id:'pax', type:'select', weight:10,
    text:"How many people will stay?", options:["1","2","3+"]
  },

  // Timing → modeling expects ISO date in 'move_in_date'
  { id:'move_in_date', type:'date', weight:16,
    text:"When do you plan to move in?"
  },
  // Tenancy → modeling expects number of months
  { id:'tenancy_months', type:'select', weight:5,
    text:"Preferred tenancy length?", options:["3","6","12","18","24"]
  },

  // Travel / parking
  { id:'has_car', type:'select', weight:3,
    text:"Do you have a car?", options:["Yes","No"]
  },
  { id:'need_parking', type:'select', weight:3,
    text:"Do you need a parking lot?", options:["Yes","No"]
  },

  // User profile
  { id:'user_type', type:'select', weight:6,
    text:"What best describes you?", options:["Working professional","Student","Intern / Trainee","Other"]
  },
  { id:'nationality', type:'select', weight:6,
    text:"What’s your nationality?", options:["Malaysian","Other"]
  },

  // Commute anchor (helps targeting)
  { id:'workplace', type:'input', weight:5,
    text:"Where do you work/study? (to recommend closer options)", placeholder:"e.g., KLCC, Cyberjaya"
  },

  // Lead ops signals
  { id:'lead_source', type:'select', weight:4,
    text:"How did you hear about us?",
    options:["Facebook","Instagram","Portal (iProperty/PropertyGuru)","Google","Referral","Walk-in","WhatsApp","Other"]
  },
  { id:'contact', type:'input', weight:10,
    text:"What’s the best contact (phone or email)?", placeholder:"e.g., +60… or name@email.com"
  }
];

// Turn raw chat answers -> model features
function buildFeaturePayload(raw) {
  const now = new Date();
  const toInt = (v, d=0) => {
    const n = parseInt(String(v ?? '').replace(/[^\d]/g,''), 10);
    return Number.isFinite(n) ? n : d;
  };

  let days_to_move_in = null;
  if (raw.move_in_date) {
    const dt = new Date(raw.move_in_date);
    days_to_move_in = Math.max(0, Math.ceil((dt - now) / (1000*60*60*24)));
  }

  const tenancy_months = toInt(raw.tenancy_months, 0);
  let pax = 1; if (raw.pax === "2") pax = 2; else if (raw.pax === "3+") pax = 3;
  const budget_num = toInt(raw.budget, 0);

  const user_type_map = {"Working professional":"working","Student":"student","Intern / Trainee":"intern","Other":"other"};
  const room_type_map = {"Private room":"private","Master w/ bathroom":"master","Shared room":"shared","Studio / whole unit":"studio"};
  const bedroom_type_map = {"Single bed":"single","Queen/King":"queen_king","Bunk beds":"bunk","No preference":"na"};

  const workplace = (raw.workplace || "").toLowerCase();
  const workplace_hot = ["klcc","kl sentral","cyberjaya","bangsar","mont kiara"].some(k => workplace.includes(k));

  const contact_raw = (raw.contact || "").trim();
  const has_contact = contact_raw.length >= 5;

  const lead_src_map = {
    "Facebook":"facebook","Instagram":"instagram","Portal (iProperty/PropertyGuru)":"portal",
    "Google":"google","Referral":"referral","Walk-in":"walkin","WhatsApp":"whatsapp","Other":"other"
  };

  const is_malaysian = raw.nationality === "Malaysian";
  const has_car = raw.has_car === "Yes";
  const need_parking = raw.need_parking === "Yes";

  const hr = now.getHours();
  const dow = now.getDay();
  const is_business_hours = hr >= 9 && hr <= 17;
  const is_weekend = (dow === 0 || dow === 6);

  return {
    area: raw.area || null,
    property: raw.property || null,
    budget_num, pax, days_to_move_in, tenancy_months,
    user_type: user_type_map[raw.user_type] || null,
    // room_type/bedroom_type are available if you add those questions later
    room_type: room_type_map[raw.room_type] || null,
    bedroom_type: bedroom_type_map[raw.bedroom_type] || null,
    lead_source: lead_src_map[raw.lead_source] || null,
    has_car, need_parking, is_malaysian, has_contact,
    workplace: raw.workplace || null, workplace_hot,
    is_business_hours, is_weekend,
    raw_contact: contact_raw
  };
}

/* ======= SCORING FUNCTIONS ======= */

function clientSideHeuristicScore(features) {
  let score = 0;
  
  console.log('Using client-side scoring for features:', features);
  
  if (features.area) {
    score += 15;
    if (['KL/Selangor', 'Mont Kiara'].includes(features.area)) {
      score += 5;
    }
  }
  
  if (features.property) {
    score += 10;
  }
  
  if (features.budget) {
    const budgetNum = parseInt(features.budget) || 0;
    if (budgetNum >= 1200) {
      score += 25;
    } else if (budgetNum >= 900) {
      score += 20;
    } else if (budgetNum >= 600) {
      score += 15;
    } else if (budgetNum >= 400) {
      score += 10;
    } else if (budgetNum > 0) {
      score += 5;
    }
  }
  
  if (features.pax) {
    if (features.pax === '1 person') {
      score += 10;
    } else if (features.pax === '2 people') {
      score += 8;
    } else {
      score += 6;
    }
  }
  
  if (features.car === 'Yes') {
    score += 5;
  }
  
  if (features.movein) {
    try {
      const moveDate = new Date(features.movein);
      const today = new Date();
      const diffDays = Math.ceil((moveDate - today) / (1000 * 60 * 60 * 24));
      
      if (diffDays <= 7) {
        score += 20;
      } else if (diffDays <= 30) {
        score += 16;
      } else if (diffDays <= 90) {
        score += 12;
      } else {
        score += 8;
      }
    } catch (e) {
      score += 8;
    }
  }
  
  if (features.tenancy) {
    if (features.tenancy === '12 months') {
      score += 5;
    } else {
      score += 3;
    }
  }
  
  if (features.unit_spec) {
    score += 5;
  }
  
  if (features.workplace && features.workplace.trim().length > 0) {
    score += 10;
    const workplace = features.workplace.toLowerCase();
    if (['klcc', 'kl sentral', 'cyberjaya', 'bangsar', 'mont kiara'].some(area => workplace.includes(area))) {
      score += 3;
    }
  }
  
  if (features.nationality) {
    if (features.nationality === 'Malaysian') {
      score += 8;
    } else {
      score += 6;
      if (features.nationality_detail) {
        score += 2;
      }
    }
  }
  
  const currentHour = new Date().getHours();
  if (currentHour >= 9 && currentHour <= 17) {
    score += 3;
  }
  
  const currentDay = new Date().getDay();
  if (currentDay >= 1 && currentDay <= 5) {
    score += 2;
  }
  
  const answeredQuestions = Object.keys(features).filter(key => features[key] && features[key] !== '').length;
  const completenessBonus = Math.floor(answeredQuestions / 2);
  score += completenessBonus;
  
  const finalScore = Math.max(0, Math.min(100, Math.round(score)));
  console.log('Client-side score calculation:', { features, rawScore: score, finalScore });
  
  return finalScore;
}

async function recomputeScoreFromFeatures(features) {
  if (MODEL_SOURCE === 'server') {
    try {
      if (DEBUG_MODE) {
        document.getElementById('lastApiCall').textContent = new Date().toLocaleTimeString();
        document.getElementById('featuresSent').textContent = JSON.stringify(features).substring(0, 50) + '...';
        document.getElementById('usingServer').textContent = 'Yes';
      }
      
      console.log('Calling server with features:', features);
      
      const response = await fetch(SCORE_ENDPOINT, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(features)
      });
      
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      
      const data = await response.json();
      console.log('Server response:', data);
      
      const score = data.score || data.alps_score || 50;
      
      if (DEBUG_MODE) {
        document.getElementById('scoreReceived').textContent = score;
      }
      
      return Math.max(0, Math.min(100, Math.round(score)));
      
    } catch (error) {
      console.error('Server scoring failed:', error);
      
      if (DEBUG_MODE) {
        document.getElementById('usingServer').textContent = 'No (Fallback)';
      }
      
      return clientSideHeuristicScore(features);
    }
  }
  
  return clientSideHeuristicScore(features);
}

function heuristicScore(features) {
  return clientSideHeuristicScore(features);
}

/* ======= INIT ======= */
document.addEventListener('DOMContentLoaded', () => {
  document.querySelectorAll('.nav-item').forEach(item=>{
    item.addEventListener('click',()=>switchPage(item.dataset.page));
  });

  renderAgentsGrid();
  renderQueueFromAgents();

  document.getElementById('agentsGrid').addEventListener('click', (e)=>{
    const card = e.target.closest('.agent-card');
    if(!card) return;
    goToAgentConversations(card.dataset.agent);
  });

  initializeDragAndDrop();
  startRealTimeLoop();
  seedInitialLeads();
});

/* ======= NAV ======= */
function switchPage(pageName){
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
  document.getElementById(pageName).classList.add('active');
  document.querySelector(`.nav-item[data-page="${pageName}"]`).classList.add('active');
  currentPage = pageName;
  const t={agents:'Agent Status Dashboard',leads:'Lead Management',chat:'AI Chat Interface',sla:'SLA Monitoring'};
  const s={agents:'Real-time agent monitoring and queue management',leads:'Lead scoring and progression tracking',chat:'AI-powered lead qualification system',sla:'Response time monitoring and escalation'};
  document.getElementById('pageTitle').textContent=t[pageName];
  document.getElementById('pageSubtitle').textContent=s[pageName];
  
  if(pageName==='chat'){ 
    setTimeout(initializeChat,200); 
    document.getElementById('scoreFloater').style.display = 'block';
  } else {
    document.getElementById('scoreFloater').style.display = 'none';
  }
  if(pageName==='sla'){ showAllConversations(); }
  if(pageName==='leads'){ refreshLeadsView(); }
}

/* ======= REAL-TIME LOOP ======= */
function startRealTimeLoop(){
  clearInterval(realTimeInterval);
  realTimeInterval = setInterval(()=>{
    document.getElementById('lastUpdate').textContent=new Date().toLocaleTimeString();
    updateAgentStatuses();
    syncAgentCapacitiesToConversations();
    tickSLATimers();
    if(currentPage === 'leads') refreshLeadsView();
  },1000);
}

/* ======= AGENTS ======= */
function updateAgentStatuses(){
  agentOrder.forEach(agentId=>{
    const count = agentConversations[agentId].length;
    AGENTS[agentId].status = count >= MAX_AGENT_CAPACITY ? 'busy' : 'available';
  });
}

function syncAgentCapacitiesToConversations(){
  agentOrder.forEach(agentId=>{
    const card = document.querySelector(`.agent-card[data-agent="${agentId}"]`);
    if(!card) return;
    const count = agentConversations[agentId].length;
    const bar = card.querySelector('.capacity-fill');
    const txt = card.querySelector('.capacity-text');
    const pct = Math.min(100, (count/MAX_AGENT_CAPACITY)*100);
    bar.style.width = pct+'%';
    bar.className = 'capacity-fill ' + (pct<=30?'capacity-low':pct<=70?'capacity-medium':'capacity-high');
    txt.textContent = `Capacity: ${count}/${MAX_AGENT_CAPACITY} chats`;
  });
}

function renderAgentsGrid(){
  const grid = document.getElementById('agentsGrid');
  grid.innerHTML = '';
  agentOrder.forEach((id, index)=>{
    const a = AGENTS[id];
    const cap = agentConversations[id].length;
    const statusClass = a.status==='available'?'status-available':'status-busy';
    const borderClass = a.status==='available'?'available':'busy';
    const isTopSales = index === 0;
    const avgScore = (8.70 - index * 0.20).toFixed(2);
    grid.innerHTML += `
      <div class="agent-card ${borderClass} ${isTopSales?'top-sales':''}" data-agent="${id}">
        <div class="agent-header">
          <div class="agent-name">${isTopSales?'👑 ':''}${a.name}</div>
          <div class="agent-status ${statusClass}">${a.status==='available'?'Available':'Busy'}</div>
        </div>
        <div>${isTopSales?'Top Sales Agent':'Agent'} • Queue Position: ${index+1}</div>
        <div class="capacity-bar"><div class="capacity-fill capacity-low" style="width:${(cap/MAX_AGENT_CAPACITY)*100}%"></div></div>
        <div class="capacity-text">Capacity: ${cap}/${MAX_AGENT_CAPACITY} chats</div>
        <div class="agent-stats">
          <div class="stat-item"><div class="stat-number">${90-index*2}%</div><div class="stat-label">SLA Rate</div></div>
          <div class="stat-item"><div class="stat-number">${avgScore}</div><div class="stat-label">Avg Score</div></div>
          <div class="stat-item"><div class="stat-number">${24-index*3}</div><div class="stat-label">Leads Today</div></div>
        </div>
      </div>`;
  });
}

function renderQueueFromAgents(){
  const q = document.getElementById('queueList');
  q.innerHTML = '';
  agentOrder.forEach((id, i)=>{
    const isTopSales = i === 0;
    q.innerHTML += `
      <div class="queue-item" draggable="true" data-agent="${id}" data-position="${i+1}">
        <div style="display:flex;align-items:center;gap:12px">
          <div class="drag-handle">≡</div>
          <div>${isTopSales?'👑 ':''}<strong>${AGENTS[id].name}</strong> - ${isTopSales?'Top Sales':'Agent'}</div>
        </div>
        <div class="position-text">Position: ${i+1}</div>
      </div>`;
  });
}

/* ======= ROUND ROBIN & AVAILABILITY-BASED AGENT SELECTION ======= */
function getNextAvailableAgent(){
  for(let i = 0; i < agentOrder.length; i++){
    const agentId = agentOrder[nextAgentIndex];
    nextAgentIndex = (nextAgentIndex + 1) % agentOrder.length;
    
    if(AGENTS[agentId].status === 'available' && agentConversations[agentId].length < MAX_AGENT_CAPACITY){
      return {id: agentId, name: AGENTS[agentId].name};
    }
  }
  return null;
}

function getMostAvailableAgent(){
  let bestAgent = null;
  let lowestLoad = MAX_AGENT_CAPACITY;
  
  agentOrder.forEach(agentId => {
    const currentLoad = agentConversations[agentId].length;
    if(currentLoad < lowestLoad && AGENTS[agentId].status === 'available'){
      lowestLoad = currentLoad;
      bestAgent = {id: agentId, name: AGENTS[agentId].name};
    }
  });
  
  return bestAgent;
}

/* ======= LEADS MANAGEMENT ======= */
function seedInitialLeads(){
  // Start with all agents having 0 conversations
  // No hardcoded demo data
}

function refreshLeadsView(){
  const ongoingContainer = document.getElementById('ongoingLeads');
  const pastContainer = document.getElementById('pastLeads');
  
  ongoingContainer.innerHTML = '';
  pastContainer.innerHTML = '';
  
  allLeadsDatabase.forEach(lead => {
    const isOngoing = ['assigned', 'ai_handling', 'in_queue', 'ai_takeover'].includes(lead.status);
    const container = isOngoing ? ongoingContainer : pastContainer;
    
    const leadElement = createLeadElement(lead);
    container.appendChild(leadElement);
  });
}

function createLeadElement(lead){
  const cls = lead.score > HOT_SCORE_THRESHOLD ? 'hot' : lead.score > WARM_SCORE_THRESHOLD ? 'warm' : 'cold';
  const scoreCls = lead.score > HOT_SCORE_THRESHOLD ? 'score-hot' : lead.score > WARM_SCORE_THRESHOLD ? 'score-warm' : 'score-cold';
  const statusText = getLeadStatusText(lead.status);
  
  const el = document.createElement('div');
  el.className = `lead-item ${cls}`;
  el.setAttribute('data-lead', lead.id);
  el.onclick = () => showLeadChart(lead.id);
  
  el.innerHTML = `
    <div class="lead-score ${scoreCls}">${lead.score}</div>
    <div class="lead-info">
      <div class="lead-name">${lead.score > HOT_SCORE_THRESHOLD ? '🔥' : ''} Lead ${lead.leadNumber}</div>
      <div class="lead-details">Area: ${lead.area} • Budget: RM${lead.budget}<br/>Move-in: ${lead.movein} • Agent: ${lead.agent}</div>
      <div class="lead-timestamp">Started: ${lead.timestamp.toLocaleTimeString()} • Status: ${statusText}</div>
    </div>`;
  
  return el;
}

function getLeadStatusText(status){
  switch(status){
    case 'assigned': return 'Assigned';
    case 'ai_handling': return 'AI Handling';
    case 'ai_takeover': return 'AI Takeover';
    case 'in_queue': return 'Queued';
    case 'completed': return 'Deal Closed';
    case 'cancelled': return 'Cancelled';
    default: return 'Pending';
  }
}

/* ======= SLA / CONVERSATIONS ======= */
// Add AI conversation simulation
function simulateAIConversation(conv){
  if(conv.status !== 'ai_takeover') return;
  
  const aiMessages = [
    "I understand you have some concerns. Let me help you find better options that might work for you.",
    "Based on what you've shared, I think I can suggest some properties that better match your needs and budget.",
    "Would you be interested in exploring similar properties in nearby areas? Sometimes we find great deals just a short distance away.",
    "I notice you mentioned budget is a concern. We have some promotional rates available - would you like me to check what's available?",
    "Let me ask you this - what's the most important factor for you: location, price, or amenities?",
    "I have access to some exclusive listings that might not be publicly available yet. Interested in hearing about them?"
  ];
  
  const randomMessage = aiMessages[Math.floor(Math.random() * aiMessages.length)];
  
  const aiChatMessage = {
    type: 'agent',
    text: randomMessage,
    time: new Date().toLocaleTimeString(),
    isAI: true
  };
  
  conv.messages.push(aiChatMessage);
  
  // Show in UI if conversation is currently open
  if(selectedConversation === conv.id) {
    const box = document.getElementById('slaMessages');
    const div = document.createElement('div');
    div.className = 'message message-bot';
    div.innerHTML = `<div>${randomMessage}</div><div style="font-size:12px;color:#7f8c8d;margin-top:5px">${aiChatMessage.time} (AI)</div>`;
    box.appendChild(div);
    box.scrollTop = box.scrollHeight;
  }
  
  // Simulate customer response after 2-4 seconds
  setTimeout(() => simulateCustomerResponse(conv), Math.random() * 2000 + 2000);
}

function simulateCustomerResponse(conv){
  if(conv.status !== 'ai_takeover') return;
  
  const responses = [
    { text: "That sounds interesting, tell me more", scoreChange: +5 },
    { text: "Yes, I'd like to hear about those options", scoreChange: +8 },
    { text: "I'm not sure, the price is still my main concern", scoreChange: -2 },
    { text: "Actually, I'm getting more interested. What do you have?", scoreChange: +12 },
    { text: "Hmm, maybe. What areas are you talking about?", scoreChange: +3 },
    { text: "I'm still not convinced", scoreChange: -5 },
    { text: "OK, I'm willing to listen", scoreChange: +6 },
    { text: "That's exactly what I was hoping to hear!", scoreChange: +15 },
  ];
  
  const randomResponse = responses[Math.floor(Math.random() * responses.length)];
  const newScore = Math.max(5, Math.min(100, conv.score + randomResponse.scoreChange));
  
  const customerMessage = {
    type: 'customer',
    text: randomResponse.text,
    time: new Date().toLocaleTimeString(),
    score: newScore
  };
  
  conv.messages.push(customerMessage);
  conv.score = newScore;
  
  // Update lead database
  const leadIndex = allLeadsDatabase.findIndex(l => l.leadNumber === conv.leadNumber);
  if(leadIndex !== -1){
    allLeadsDatabase[leadIndex].score = newScore;
  }
  
  // Show in UI if conversation is currently open
  if(selectedConversation === conv.id) {
    const box = document.getElementById('slaMessages');
    const div = document.createElement('div');
    div.className = 'message message-user';
    div.style.position = 'relative';
    div.innerHTML = `<div>${randomResponse.text}</div><div style="font-size:12px;color:#7f8c8d;margin-top:5px">${customerMessage.time}</div>`;
    
    // Add score badge
    const scoreBadge = document.createElement('div');
    scoreBadge.className = 'message-score';
    scoreBadge.textContent = newScore;
    div.appendChild(scoreBadge);
    
    box.appendChild(div);
    box.scrollTop = box.scrollHeight;
  }
  
  updateConversationListItem(conv.id);
  
  // Check if score improved enough for agent handback alert
  if(newScore > WARM_SCORE_THRESHOLD && conv.scoreMonitoringActive) {
    showScoreImprovementAlert(conv);
  } else {
    // Continue AI conversation after 3-6 seconds
    setTimeout(() => simulateAIConversation(conv), Math.random() * 3000 + 3000);
  }
}

// Enhanced SLA timer to exclude AI-handled conversations
function tickSLATimers(){
  Object.values(activeConversations).forEach(conv=>{
    // Skip SLA timers for AI-handled conversations
    if(conv.status === 'ai_takeover') {
      updateConversationListItem(conv.id);
      if(selectedConversation === conv.id) loadActiveConversation(conv);
      return;
    }
    
    const t = conv.slaTimer;
    if(!t) return;

    if(t.timeRemaining > 0){
      t.timeRemaining--;
      if(t.timeRemaining <= 0){
        if(t.type === 'initial'){
          reassignToMostAvailableAgent(conv);
        } else {
          t.alertTriggered = true;
          t.overdue = 1;
          showSlaAlert(conv.id);
        }
      }
    } else if(t.overdue > 0 || t.alertTriggered){
      t.overdue++;
    }
    
    updateConversationListItem(conv.id);
    if(selectedConversation === conv.id) loadActiveConversation(conv);
  });
}

// Add score monitoring for AI-handled conversations
function startScoreMonitoring(conv){
  conv.scoreMonitoringActive = true;
}

function showScoreImprovementAlert(conv){
  conv.scoreMonitoringActive = false; // Stop monitoring until next AI takeover
  
  // Create improvement alert
  const alertDiv = document.createElement('div');
  alertDiv.style.cssText = `
    position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
    background: #fff; padding: 26px; border-radius: 14px; 
    box-shadow: 0 10px 30px rgba(0,0,0,.3); z-index: 1200;
    border-left: 5px solid #2ecc71; max-width: 500px;
  `;
  
  alertDiv.innerHTML = `
    <h3>📈 SCORE IMPROVED!</h3>
    <p>Lead ${conv.leadNumber} score increased to ${conv.score} (Warm/Hot Lead)</p>
    <div style="margin:12px 0;padding:12px;background:#e8f5e8;border-radius:8px">
      <strong>Previous Agent:</strong> ${conv.previousAgentName}<br/>
      <strong>Current Score:</strong> ${conv.score}<br/>
      <strong>Status:</strong> Ready for agent handback
    </div>
    <div style="display:flex;gap:12px;margin-top:16px;justify-content:center">
      <button onclick="handbackToAgent('${conv.id}')" style="padding:10px 18px;border:none;border-radius:8px;background:#2ecc71;color:#fff;cursor:pointer;font-weight:700">Take Back Lead</button>
      <button onclick="dismissScoreAlert()" style="padding:10px 18px;border:none;border-radius:8px;background:#95a5a6;color:#fff;cursor:pointer;font-weight:700">Keep with AI</button>
    </div>
  `;
  
  document.body.appendChild(alertDiv);
  alertDiv.id = 'scoreImprovementAlert';
  
  showNotification(`Lead ${conv.leadNumber} score improved to ${conv.score}! Ready for agent.`, 'success');
}

function handbackToAgent(convId){
  const conv = activeConversations[convId];
  if(!conv) return;
  
  // Find most available agent (prefer original agent if available)
  let targetAgent = null;
  if(conv.previousAgentId && agentConversations[conv.previousAgentId].length < MAX_AGENT_CAPACITY){
    targetAgent = {id: conv.previousAgentId, name: conv.previousAgentName};
  } else {
    targetAgent = getMostAvailableAgent();
  }
  
  if(!targetAgent){
    alert('No agents available. Lead will remain with AI.');
    dismissScoreAlert();
    return;
  }
  
  // Hand back to agent
  conv.agentId = targetAgent.id;
  conv.agentName = targetAgent.name;
  conv.status = 'waiting_agent_response';
  conv.slaTimer = {type: 'initial', timeRemaining: INITIAL_RESPONSE_TIMEOUT, alertTriggered: false, overdue: 0};
  agentConversations[targetAgent.id].push(conv);
  
  const handbackMessage = {
    type: 'system',
    text: `Lead handed back to ${targetAgent.name} due to improved score (${conv.score}). AI assistance complete.`,
    time: new Date().toLocaleTimeString()
  };
  conv.messages.push(handbackMessage);
  
  // Update lead database
  const leadIndex = allLeadsDatabase.findIndex(l => l.leadNumber === conv.leadNumber);
  if(leadIndex !== -1){
    allLeadsDatabase[leadIndex].status = 'assigned';
    allLeadsDatabase[leadIndex].agent = targetAgent.name;
    allLeadsDatabase[leadIndex].score = conv.score;
  }
  
  dismissScoreAlert();
  refreshCurrentListView();
  showNotification(`Lead ${conv.leadNumber} handed back to ${targetAgent.name}`, 'success');
}

function dismissScoreAlert(){
  const alert = document.getElementById('scoreImprovementAlert');
  if(alert) alert.remove();
}

function updateConversationListItem(convId){
  const conv = activeConversations[convId];
  if(!conv) return;
  const row = document.querySelector(`[data-conv="${convId}"]`);
  if(!row) return;

  const tInfo = getConversationTimer(conv);
  const sInfo = getConversationStatus(conv);
  row.querySelector('.status-indicator').textContent = sInfo.status;
  row.querySelector('.status-indicator').style.color = sInfo.color;
  const timer = row.querySelector('.timer-badge');
  timer.textContent = tInfo.text;
  timer.className = 'timer-badge ' + tInfo.class;
  row.className = getConversationClass(conv) + ' conversation-item';
  
  const scoreBadge = row.querySelector('.live-score-badge');
  if(scoreBadge) {
    scoreBadge.textContent = conv.score;
    scoreBadge.style.background = conv.score > HOT_SCORE_THRESHOLD ? '#e74c3c' : conv.score > WARM_SCORE_THRESHOLD ? '#f39c12' : '#95a5a6';
  }
}

function showAllConversations(){
  currentListView = {type:'all', id:null};
  const list = document.getElementById('conversationsList');
  list.innerHTML = `
    <h3 style="margin-bottom:12px">💬 Active Conversations</h3>
    <div style="margin-bottom:10px;font-size:14px;color:#7f8c8d">Click on any conversation to manage</div>
    <div id="convList"></div>`;
  const container = list.querySelector('#convList');

  Object.values(activeConversations).forEach(c => container.appendChild(buildConversationRow(c)));
}

function showAgentConversationsList(agentId){
  currentListView = {type:'agent', id:agentId};
  const list = document.getElementById('conversationsList');
  const name = AGENTS[agentId].name;
  const convs = agentConversations[agentId];

  list.innerHTML = `
    <h3 style="margin-bottom:12px">💬 ${name}'s Conversations</h3>
    <div style="margin-bottom:10px;font-size:14px;color:#7f8c8d">Active: ${convs.length} conversations</div>
    <button onclick="showAllConversations()" class="btn btn-primary" style="margin-bottom:10px">← Back to All Conversations</button>
    <div id="convList"></div>`;
  const container = list.querySelector('#convList');

  if(!convs.length){
    container.innerHTML = `<div style="text-align:center;color:#7f8c8d;margin-top:40px"><p>No active conversations</p></div>`;
    selectedConversation = null;
    document.getElementById('slaMessages').innerHTML = `<div style="text-align:center;color:#7f8c8d;margin-top:40px"><p>Select a conversation</p></div>`;
    document.getElementById('slaInputArea').style.display='none';
    return;
  }

  convs.forEach(c => container.appendChild(buildConversationRow(c)));
  const openFirst = !selectedConversation || !convs.some(c => c.id === selectedConversation);
  if(openFirst) openSLAChat(convs[0].id);
}

function buildConversationRow(conv){
  const el = document.createElement('div');
  el.className = getConversationClass(conv) + ' conversation-item';
  el.dataset.conv = conv.id;
  el.onclick = () => openSLAChat(conv.id);
  const s = getConversationStatus(conv);
  const t = getConversationTimer(conv);
  const scoreColor = conv.score > HOT_SCORE_THRESHOLD ? '#e74c3c' : conv.score > WARM_SCORE_THRESHOLD ? '#f39c12' : '#95a5a6';
  
  el.innerHTML = `
    <div style="display:flex;justify-content:space-between;align-items:start">
      <div><div><strong>Lead ${conv.leadNumber}</strong> • ${conv.agentName}</div><div style="font-size:14px;color:#7f8c8d">${conv.area} • ALPS: ${conv.score}</div></div>
      <div style="text-align:right"><div class="status-indicator" style="font-size:12px">${s.status}</div></div>
    </div>
    <div class="sla-timer"><div class="timer-badge ${t.class}">${t.text}</div><div style="font-size:12px">${t.description}</div></div>
    <div class="live-score-badge" style="background:${scoreColor}">${conv.score}</div>`;
  return el;
}

function openSLAChat(id){
  selectedConversation = id;
  if(activeConversations[id]){
    loadActiveConversation(activeConversations[id]);
    return;
  }
}

function loadActiveConversation(conv){
  document.getElementById('slaCurrentChat').textContent = `Lead ${conv.leadNumber} - ${conv.agentName}`;
  document.getElementById('slaCurrentDetails').textContent = `${conv.area} • ALPS: ${conv.score} • ${getStatusText(conv.status)}`;

  const info = getConversationTimer(conv);
  const tEl = document.getElementById('slaCurrentTimer');
  tEl.textContent = info.text;
  tEl.style.background = info.class === 'timer-positive' ? 'rgba(231,76,60,.2)' : 'rgba(46,204,113,.2)';

  const box = document.getElementById('slaMessages');
  box.innerHTML = '';
  conv.messages.forEach((m, index)=>{
    const div = document.createElement('div');
    const cls = m.type === 'customer' ? 'message-user' : (m.type === 'system' ? 'message-system' : 'message-bot');
    div.className = 'message ' + cls;
    div.style.position = 'relative';
    div.innerHTML = `<div>${m.text}</div><div style="font-size:12px;color:#7f8c8d;margin-top:5px">${m.time}</div>`;
    
    if(m.type === 'customer' && m.score){
      const scoreBadge = document.createElement('div');
      scoreBadge.className = 'message-score';
      scoreBadge.textContent = m.score;
      div.appendChild(scoreBadge);
    }
    
    box.appendChild(div);
  });
  box.scrollTop = box.scrollHeight;
  document.getElementById('slaInputArea').style.display = 'flex';
}

function handleSLAMessage(e){ 
  if(e.key === 'Enter') sendSLAMessage(); 
}

function sendSLAMessage(){
  const input = document.getElementById('slaMessageInput');
  const text = input.value.trim(); 
  if(!text) return; 
  input.value = '';
  
  const box = document.getElementById('slaMessages');
  const d = document.createElement('div');
  d.className = 'message message-bot';
  d.innerHTML = `<div>${text}</div><div style="font-size:12px;color:#7f8c8d;margin-top:5px">${new Date().toLocaleTimeString()}</div>`;
  box.appendChild(d); 
  box.scrollTop = box.scrollHeight;

  const conv = activeConversations[selectedConversation];
  if(conv){
    conv.messages.push({type:'agent', text, time:new Date().toLocaleTimeString()});
    if(conv.status === 'waiting_agent_response'){
      conv.status = 'ongoing';
      conv.slaTimer = {type:'ongoing', timeRemaining:ONGOING_RESPONSE_TIMEOUT, alertTriggered:false, overdue:0};
    } else {
      conv.slaTimer.timeRemaining = ONGOING_RESPONSE_TIMEOUT; 
      conv.slaTimer.alertTriggered = false; 
      conv.slaTimer.overdue = 0;
    }
    
    setTimeout(() => {
      const replies = ["Thanks! That helps.", "Great, what are next steps?", "I'm interested to view.", "Sounds good!", "Actually, I'm not interested anymore", "The price is too high", "I changed my mind"];
      const r = replies[Math.floor(Math.random() * replies.length)];
      const u = document.createElement('div');
      u.className = 'message message-user';
      u.style.position = 'relative';
      u.innerHTML = `<div>${r}</div><div style="font-size:12px;color:#7f8c8d;margin-top:5px">${new Date().toLocaleTimeString()}</div>`;
      
      const newScore = calculateScoreFromResponse(r, conv.score);
      const scoreBadge = document.createElement('div');
      scoreBadge.className = 'message-score';
      scoreBadge.textContent = newScore;
      u.appendChild(scoreBadge);
      
      box.appendChild(u); 
      box.scrollTop = box.scrollHeight;
      
      const customerMessage = {type:'customer', text:r, time:new Date().toLocaleTimeString(), score: newScore};
      conv.messages.push(customerMessage);
      
      const oldScore = conv.score;
      conv.score = newScore;
      conv.slaTimer.timeRemaining = ONGOING_RESPONSE_TIMEOUT;
      
      // Update lead database
      const leadIndex = allLeadsDatabase.findIndex(l => l.leadNumber === conv.leadNumber);
      if(leadIndex !== -1){
        allLeadsDatabase[leadIndex].score = newScore;
      }
      
      // Check for AI takeover if score drops too low
      if(newScore <= LOW_SCORE_THRESHOLD && conv.status !== 'ai_takeover'){
        setTimeout(() => aiTakeoverConversation(conv), 2000);
      }
      // Check for score improvement if AI was handling and score goes up
      else if(conv.status === 'ai_takeover' && newScore > WARM_SCORE_THRESHOLD && !conv.scoreMonitoringActive){
        conv.scoreMonitoringActive = true; // Reactivate monitoring
        setTimeout(() => showScoreImprovementAlert(conv), 1000);
      }
      
      updateConversationListItem(conv.id);
      
    }, 1500);
  }
}

function calculateScoreFromResponse(response, currentScore){
  const negativeResponses = ["not interested", "too high", "changed my mind", "no thank you", "expensive"];
  const positiveResponses = ["interested", "good", "sounds good", "great", "perfect"];
  
  let scoreChange = 0;
  const lowerResponse = response.toLowerCase();
  
  for(const neg of negativeResponses){
    if(lowerResponse.includes(neg)){
      scoreChange = -Math.floor(Math.random() * 20) - 10;
      break;
    }
  }
  
  if(scoreChange === 0){
    for(const pos of positiveResponses){
      if(lowerResponse.includes(pos)){
        scoreChange = Math.floor(Math.random() * 10) + 2;
        break;
      }
    }
  }
  
  if(scoreChange === 0){
    scoreChange = Math.floor(Math.random() * 6) - 3;
  }
  
  return Math.max(5, Math.min(100, currentScore + scoreChange));
}

function aiTakeoverConversation(conv){
  conv.status = 'ai_takeover';
  conv.previousAgentId = conv.agentId;
  conv.previousAgentName = conv.agentName;
  conv.aiTakeoverScore = conv.score;
  
  // Free agent capacity but keep conversation visible to agent
  const agentConvs = agentConversations[conv.agentId];
  const index = agentConvs.findIndex(c => c.id === conv.id);
  if(index !== -1) {
    agentConvs.splice(index, 1);
  }
  
  // Remove SLA timer for AI-handled conversations
  conv.slaTimer = null;
  
  // Keep conversation in activeConversations so agent can still see it
  conv.agentName = 'AI Assistant (was ' + conv.previousAgentName + ')';
  
  const aiMessage = {
    type: 'system',
    text: `AI Assistant has taken over this conversation due to low engagement score (${conv.score}). Agent capacity freed but conversation remains visible.`,
    time: new Date().toLocaleTimeString()
  };
  conv.messages.push(aiMessage);
  
  const leadIndex = allLeadsDatabase.findIndex(l => l.leadNumber === conv.leadNumber);
  if(leadIndex !== -1){
    allLeadsDatabase[leadIndex].status = 'ai_takeover';
    allLeadsDatabase[leadIndex].agent = 'AI Assistant';
    allLeadsDatabase[leadIndex].score = conv.score;
  }
  
  if(selectedConversation === conv.id) {
    const box = document.getElementById('slaMessages');
    const div = document.createElement('div');
    div.className = 'message message-ai-takeover';
    div.innerHTML = `<div>${aiMessage.text}</div><div style="font-size:12px;color:#7f8c8d;margin-top:5px">${aiMessage.time}</div>`;
    box.appendChild(div);
    box.scrollTop = box.scrollHeight;
    
    loadActiveConversation(conv);
  }
  
  showNotification(`AI takeover: Lead ${conv.leadNumber} (Score: ${conv.score}) - Capacity freed`, 'warning');
  refreshCurrentListView();
  
  // Start AI conversation simulation
  setTimeout(() => simulateAIConversation(conv), 3000);
  
  // Start monitoring for score improvement
  startScoreMonitoring(conv);
}

function reassignToMostAvailableAgent(conv){
  const next = getMostAvailableAgent();
  
  const arr = agentConversations[conv.agentId];
  const ix = arr.findIndex(c => c.id === conv.id);
  if(ix > -1) arr.splice(ix, 1);

  if(next){
    conv.agentId = next.id;
    conv.agentName = next.name;
    conv.assignedTime = new Date();
    conv.status = 'waiting_agent_response';
    conv.slaTimer = {type:'initial', timeRemaining:INITIAL_RESPONSE_TIMEOUT, alertTriggered:false, overdue:0};
    agentConversations[next.id].push(conv);
    conv.messages.push({type:'system', text:`Conversation reassigned to ${next.name} due to initial response timeout.`, time:new Date().toLocaleTimeString()});

    if(selectedConversation === conv.id) loadActiveConversation(conv);
    refreshCurrentListView();
    showNotification(`Lead ${conv.leadNumber} reassigned to ${next.name}`, 'warning');
  } else {
    conv.status = 'unassigned';
    conv.slaTimer.overdue++;
    showNotification(`No agent available for Lead ${conv.leadNumber}`, 'error');
  }
}

function escalateConversation(){
  if(!selectedConversation) return;
  const box = document.getElementById('slaMessages');
  const div = document.createElement('div');
  div.className = 'message message-system';
  div.innerHTML = `<div><strong>Conversation Escalated</strong></div><div>Supervisor will take over.</div><div style="font-size:12px;color:#7f8c8d;margin-top:5px">${new Date().toLocaleTimeString()}</div>`;
  box.appendChild(div); 
  box.scrollTop = box.scrollHeight;
  alert('Escalated. Supervisor will take over soon.');
}

function markDeal(){
  if(!selectedConversation) return;
  const conv = activeConversations[selectedConversation];
  if(!conv) return;

  const agentConvs = agentConversations[conv.agentId];
  const index = agentConvs.findIndex(c => c.id === conv.id);
  if(index !== -1) {
    agentConvs.splice(index, 1);
  }

  const leadIndex = allLeadsDatabase.findIndex(l => l.leadNumber === conv.leadNumber);
  if(leadIndex !== -1){
    allLeadsDatabase[leadIndex].status = 'completed';
    allLeadsDatabase[leadIndex].completedTime = new Date();
    completedLeads.push(allLeadsDatabase[leadIndex]);
  }

  const dealMessage = {
    type: 'system',
    text: `Deal closed successfully! Lead ${conv.leadNumber} marked as completed. Agent capacity freed.`,
    time: new Date().toLocaleTimeString()
  };
  conv.messages.push(dealMessage);

  delete activeConversations[conv.id];

  const box = document.getElementById('slaMessages');
  const div = document.createElement('div');
  div.className = 'message message-system';
  div.style.background = '#d4edda';
  div.style.borderColor = '#28a745';
  div.innerHTML = `<div><strong>🎉 Deal Closed!</strong></div><div>${dealMessage.text}</div><div style="font-size:12px;color:#7f8c8d;margin-top:5px">${dealMessage.time}</div>`;
  box.appendChild(div);
  box.scrollTop = box.scrollHeight;

  showNotification(`Deal closed: Lead ${conv.leadNumber}`, 'success');
  
  selectedConversation = null;
  document.getElementById('slaInputArea').style.display = 'none';
  refreshCurrentListView();
  
  setTimeout(() => {
    document.getElementById('slaMessages').innerHTML = `<div style="text-align:center;color:#7f8c8d;margin-top:40px"><h3>💬 SLA Chat Monitor</h3><p>Select a conversation from the left to view and manage the chat</p></div>`;
  }, 2000);
}

function refreshCurrentListView(){
  updateAgentStatuses();
  syncAgentCapacitiesToConversations();
  if(currentListView.type === 'all') showAllConversations();
  if(currentListView.type === 'agent') showAgentConversationsList(currentListView.id);
}

function getConversationStatus(conv){
  if(conv.status === 'ai_takeover') return {status:'AI Handling', color:'#3498db'};
  if(!conv.slaTimer) return {status:'Active', color:'#2ecc71'};
  if(conv.status === 'waiting_agent_response') return {status:'Waiting', color:'#f39c12'};
  if(conv.slaTimer.overdue > 0) return {status:'Breach', color:'#e74c3c'};
  if(conv.slaTimer.alertTriggered) return {status:'Alert', color:'#f39c12'};
  return {status:'Active', color:'#2ecc71'};
}

function getConversationTimer(conv){
  // AI-handled conversations don't have timers
  if(conv.status === 'ai_takeover') {
    return {text:'AI Active', class:'timer-ai', description:'AI handling conversation'};
  }
  
  if(!conv.slaTimer) return {text:'--:--', class:'timer-negative', description:'No timer'};
  const t = conv.slaTimer;
  if(t.overdue > 0){
    const m = Math.floor(t.overdue/60);
    const s = (t.overdue % 60).toString().padStart(2,'0');
    return {text:`+${m}:${s}`, class:'timer-positive', description:t.type==='initial'?'Initial response overdue':'Response overdue'};
  }
  if(t.timeRemaining > 0){
    const m = Math.floor(t.timeRemaining/60);
    const s = (t.timeRemaining % 60).toString().padStart(2,'0');
    return {text:`-${m}:${s}`, class:'timer-negative', description:t.type==='initial'?'Initial response due':'Next response due'};
  }
  return {text:'0:00', class:'timer-negative', description:'Timer expired'};
}

function getConversationClass(conv){
  if(conv.status === 'ai_takeover') return 'conversation-ai-handled';
  if(!conv.slaTimer) return 'conversation-item';
  if(conv.slaTimer.type === 'initial' && conv.slaTimer.timeRemaining <= 10) return 'sla-warning';
  if(conv.slaTimer.overdue > 0) return 'sla-breach';
  return '';
}

function getStatusText(s){
  return s === 'waiting_agent_response' ? 'Waiting for agent response' :
         s === 'ongoing' ? 'Ongoing conversation' :
         s === 'assigned' ? 'Assigned to agent' :
         s === 'ai_takeover' ? 'AI handling' :
         s === 'in_queue' ? 'In queue' :
         s === 'unassigned' ? 'Unassigned' : 'Active';
}

/* ======= ALERT ======= */
let alertInterval = null;
function showSlaAlert(convId){
  lastAlertConvId = convId;
  const c = activeConversations[convId];
  document.getElementById('alertConversation').textContent = `Lead ${c.leadNumber}`;
  document.getElementById('alertAgent').textContent = c.agentName;
  let secs = 1;
  const timeEl = document.getElementById('alertTime');
  clearInterval(alertInterval);
  alertInterval = setInterval(() => { 
    secs++; 
    const m = Math.floor(secs/60);
    const s = (secs % 60).toString().padStart(2,'0'); 
    timeEl.textContent = `+${m}:${s}`;
  }, 1000);
  document.getElementById('slaAlert').style.display = 'block';
}

function goToConversation(){
  document.getElementById('slaAlert').style.display = 'none';
  if(lastAlertConvId){
    switchPage('sla');
    setTimeout(() => openSLAChat(lastAlertConvId), 200);
  }
}

function reassignConversation(){
  document.getElementById('slaAlert').style.display = 'none';
  if(lastAlertConvId && activeConversations[lastAlertConvId]){
    reassignToMostAvailableAgent(activeConversations[lastAlertConvId]);
  }
}

/* ======= CHART MODAL ======= */
function showLeadChart(leadId){
  const lead = allLeadsDatabase.find(l => l.id === leadId) || completedLeads.find(l => l.id === leadId);
  if(!lead) return;
  
  const data = buildLeadChartData(lead);
  document.getElementById('chartTitle').textContent = `${data.name} - Score Progression`;
  document.getElementById('chartModal').style.display = 'block';
  setTimeout(() => { 
    createLeadChart(data); 
    updateChartDetails(data); 
  }, 50);
}

function buildLeadChartData(lead){
  console.log('Building chart data for lead:', lead);
  
  if(lead.responses && Object.keys(lead.responses).length > 0){
    // Use actual progression from responses
    const scores = [0]; 
    let currentScore = 0;
    const questionIds = ['area','property','budget','pax','has_car','need_parking','move_in_date','tenancy_months','user_type','workplace','nationality','lead_source','contact'];
    
    questionIds.forEach(qId => {
      const response = lead.responses[qId];
      if(!response) {
        scores.push(currentScore); // No change if no response
        return;
      }
      
      // Calculate incremental score based on response
      let increment = 0;
      
      switch(qId) {
        case 'area':
          increment = 8;
          if(['KL/Selangor', 'Mont Kiara'].includes(response)) increment += 3;
          break;
        case 'property':
          increment = 5;
          break;
        case 'budget':
          const budget = parseInt(response) || 0;
          if(budget >= 1200) increment = 15;
          else if(budget >= 900) increment = 12;
          else if(budget >= 600) increment = 10;
          else if(budget >= 400) increment = 8;
          else if(budget > 0) increment = 5;
          break;
        case 'pax':
          increment = response === '1 person' ? 6 : response === '2 people' ? 5 : 4;
          break;
        case 'car':
          increment = response === 'Yes' ? 3 : 1;
          break;
        case 'parking':
          increment = response === 'Yes' ? 2 : 1;
          break;
        case 'movein':
          try {
            const moveDate = new Date(response);
            const today = new Date();
            const diffDays = Math.ceil((moveDate - today) / (1000 * 60 * 60 * 24));
            if(diffDays <= 7) increment = 12;
            else if(diffDays <= 30) increment = 10;
            else if(diffDays <= 90) increment = 8;
            else increment = 5;
          } catch {
            increment = 5;
          }
          break;
        case 'tenancy':
          increment = response === '12 months' ? 4 : 3;
          break;
        case 'gender':
          increment = 2;
          break;
        case 'unit_spec':
          increment = Array.isArray(response) ? response.length * 2 : 3;
          break;
        case 'workplace':
          if(response && response.trim()) {
            increment = 6;
            const workplace = response.toLowerCase();
            if(['klcc', 'kl sentral', 'cyberjaya', 'bangsar', 'mont kiara'].some(area => workplace.includes(area))) {
              increment += 2;
            }
          } else {
            increment = 1;
          }
          break;
        case 'nationality':
          if(response === 'Malaysian') increment = 8;
          else if(response === 'Others') increment = 6;
          else increment = 4;
          break;
        default:
          increment = 3;
      }
      
      currentScore = Math.min(100, currentScore + increment);
      scores.push(Math.round(currentScore));
    });
    
    // Ensure final score matches the actual lead score
    if(scores.length > 0) {
      scores[scores.length - 1] = lead.score;
    }
    
    return {
      name: `Lead ${lead.leadNumber}`,
      scores, 
      messages: ['Start','Area','Property','Budget','Pax','Car','Parking','Move-in','Tenancy','Gender','Unit','Workplace','Nationality','Final'], 
      details: `${lead.area} • Budget: RM${lead.budget} • Move-in: ${lead.movein} • Status: ${getLeadStatusText(lead.status)}`
    };
  }
  
  // Fallback for leads without detailed responses - create realistic progression to actual score
  const targetScore = lead.score;
  const steps = 6;
  const increment = targetScore / steps;
  const progression = [0];
  
  for(let i = 1; i < steps; i++){
    progression.push(Math.round(increment * i));
  }
  progression.push(targetScore); // Ensure final score is exact
  
  return {
    name: `Lead ${lead.leadNumber}`,
    scores: progression,
    messages: ['Start','Area','Property','Budget','Contact','Final'],
    details: `${lead.area} • Budget: RM${lead.budget} • Move-in: ${lead.movein} • Status: ${getLeadStatusText(lead.status)}`
  };
}

function createLeadChart(d){
  const ctx = document.getElementById('leadChart').getContext('2d');
  if(leadChart) leadChart.destroy();
  leadChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: d.messages,
      datasets: [{
        label: 'ALPS Score',
        data: d.scores,
        borderColor: '#3498db',
        backgroundColor: 'rgba(52,152,219,.1)',
        borderWidth: 3,
        fill: true,
        tension: 0.4,
        pointBackgroundColor: '#3498db',
        pointBorderColor: '#fff',
        pointBorderWidth: 2,
        pointRadius: 5
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { display: false }
      },
      scales: {
        y: { beginAtZero: true, max: 100 }
      }
    }
  });
}

function updateChartDetails(d){
  const final = d.scores[d.scores.length - 1];
  let cat = 'Cold Lead', color = '#95a5a6';
  if(final > HOT_SCORE_THRESHOLD){ cat = 'Hot Lead'; color = '#e74c3c'; } 
  else if(final > WARM_SCORE_THRESHOLD){ cat = 'Warm Lead'; color = '#f39c12'; }
  
  document.getElementById('chartDetails').innerHTML = `
    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:14px">
      <div style="background:#f8f9fa;padding:12px;border-radius:10px">
        <h4>Final Score</h4>
        <div style="font-size:22px;font-weight:800;color:${color}">${final}/100</div>
        <div style="color:${color};font-weight:700">${cat}</div>
      </div>
      <div style="background:#f8f9fa;padding:12px;border-radius:10px">
        <h4>Score Range</h4>
        <div>Min: ${Math.min(...d.scores)}</div>
        <div>Max: ${Math.max(...d.scores)}</div>
        <div>Growth: +${final - d.scores[0]}</div>
      </div>
      <div style="background:#f8f9fa;padding:12px;border-radius:10px">
        <h4>Details</h4>
        <div style="font-size:14px">${d.details}</div>
      </div>
    </div>`;
}

function closeModal(){ 
  document.getElementById('chartModal').style.display = 'none'; 
  if(leadChart){ leadChart.destroy(); leadChart = null; } 
}

/* ======= CHAT / ALPS ======= */
function initializeChat(){
  chatCurrentStep = 0; 
  chatUserResponses = {}; 
  chatAlpsScore = 0;
  const box = document.getElementById('chatMessages');
  box.innerHTML = `<div class="typing-indicator" id="typingIndicator"><div class="typing-dots"><div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div></div></div>`;
  updateChatScoreDisplay();
  
  console.log('Chat initialized - starting with first question');
  setTimeout(() => askQuestion(0), 400);
}

function askQuestion(i){
  if(i >= questions.length){ return finalizeLead(); }
  const q = questions[i]; 
  chatCurrentStep = i; 
  
  console.log('Asking question', i, ':', q.text);
  
  showTyping();
  setTimeout(() => {
    hideTyping();
    let html = `<div>${q.text}</div>`;
    if(q.type === 'select'){
      html += `<div class="options-container">` +
        q.options.map(o => `<div class="option-button" onclick="selectOption('${q.id}','${o.replace(/'/g,"\\'")}')">${o}</div>`).join('') +
        `</div>`;
    } else if(q.type === 'property_select'){
      const props = getPropertiesForArea(chatUserResponses.area || 'KL/Selangor').slice(0, 12);
      html += `<div class="property-grid">` + 
        props.map(p => `<div class="property-item" onclick="selectOption('${q.id}','${p.replace(/'/g,"\\'")}')">${p}</div>`).join('') + 
        `</div>`;
    } else if(q.type === 'input'){
      html += `<input class="input-field" type="text" placeholder="${q.placeholder}" onkeypress="handleInputKeypress(event,'${q.id}')">`;
    } else if(q.type === 'date'){
      html += `<input class="input-field" type="date" onchange="handleDateChange(event,'${q.id}')">`;
    } else if(q.type === 'multiple'){
      html += createMultipleChoiceOptions(q.id, q.options);
    }
    addMessage(html, 'bot');
  }, 600);
}

function createMultipleChoiceOptions(id, opts){
  let c = `<div class="checkbox-group" id="checkboxGroup_${id}">`;
  opts.forEach((o, idx) => {
    const oid = `${id}_${idx}`;
    c += `<div class="checkbox-item" data-option-id="${oid}" onclick="toggleMultipleChoice('${oid}','${id}')">
            <input type="checkbox" id="${oid}" value="${o}">
            <label for="${oid}">${o}</label>
          </div>`;
  });
  c += `<button class="continue-btn" onclick="submitMultipleChoice('${id}')">Continue</button></div>`;
  return c;
}

function toggleMultipleChoice(oid, id){ 
  const cb = document.getElementById(oid); 
  const item = document.querySelector(`[data-option-id="${oid}"]`); 
  cb.checked = !cb.checked; 
  item.classList.toggle('selected', cb.checked); 
}

function selectOption(id, val){
  if(id === 'nationality' && val === 'Others'){
    chatUserResponses[id] = val;
    addMessage(val, 'user');
    addMessage(`<div>Please specify your nationality:</div><input class="input-field" type="text" placeholder="e.g., Filipino, Iranian" onkeypress="handleInputKeypress(event,'nationality_other')">`, 'bot');
    return;
  }
  
  chatUserResponses[id] = val; 
  addMessage(val, 'user');
  
  console.log('Selected option:', id, '=', val);
  console.log('Current responses:', chatUserResponses);
  
  recalcScoreAndAdvance(id, val);
}

function handleInputKeypress(e, id){ 
  if(e.key === 'Enter'){ 
    const v = e.target.value.trim(); 
    if(!v) return; 
    
    if(id === 'nationality_other'){ 
      chatUserResponses['nationality_detail'] = v; 
      addMessage(v, 'user'); 
      console.log('Nationality detail provided:', v);
      recalcScoreAndAdvance('nationality_detail', v); 
    } else { 
      chatUserResponses[id] = v;
      console.log('Input provided:', id, '=', v);
      selectOption(id, v); 
    } 
  } 
}

function handleDateChange(e, id){ 
  const v = e.target.value; 
  if(v) {
    chatUserResponses[id] = v;
    console.log('Date selected:', id, '=', v);
    selectOption(id, v);
  }
}

function submitMultipleChoice(id){
  const vals = [...document.querySelectorAll(`#checkboxGroup_${id} input[type="checkbox"]:checked`)].map(cb => cb.value);
  if(!vals.length) return alert('Please select at least one option');
  
  chatUserResponses[id] = vals; 
  addMessage(vals.join(', '), 'user');
  console.log('Multiple choice selected:', id, '=', vals);
  
  recalcScoreAndAdvance(id, vals);
}

function recalcScoreAndAdvance(lastId, val){
  const raw = {...chatUserResponses};
  const features = buildFeaturePayload(raw);

  // server scoring when available, else heuristic fallback
  recomputeScoreFromFeatures(features).then(score => {
    chatAlpsScore = Math.max(0, Math.min(100, score));
    updateChatScoreDisplay();
    setTimeout(() => askQuestion(chatCurrentStep + 1), 600);
  }).catch(err => {
    console.error('Score calculation failed; using client heuristic', err);
    chatAlpsScore = clientSideHeuristicScore(features);
    updateChatScoreDisplay();
    setTimeout(() => askQuestion(chatCurrentStep + 1), 600);
  });
}

function updateChatScoreDisplay(){
  const bar = document.getElementById('chatScoreBar');
  const text = document.getElementById('chatScoreText');
  const cat = document.getElementById('chatScoreCategory');
  const pct = Math.min(chatAlpsScore, 100);
  bar.style.width = pct + '%';
  bar.className = 'score-fill ' + (chatAlpsScore > HOT_SCORE_THRESHOLD ? 'score-hot' : chatAlpsScore > WARM_SCORE_THRESHOLD ? 'score-warm' : 'score-cold');
  text.textContent = `${Math.round(chatAlpsScore)} / 100`;
  cat.textContent = chatAlpsScore > HOT_SCORE_THRESHOLD ? 'Hot Lead' : chatAlpsScore > WARM_SCORE_THRESHOLD ? 'Warm Lead' : 'Cold Lead';
  
  console.log('Score display updated:', Math.round(chatAlpsScore));
}

function getPropertiesForArea(area){ 
  return PROPERTIES; 
}

function finalizeLead(){
  showTyping();
  setTimeout(() => {
    hideTyping();
    const newLead = {
      id: `lead${nextLeadId}`,
      leadNumber: `#${nextLeadId}`,
      score: Math.round(chatAlpsScore),
      area: chatUserResponses.area || 'KL/Selangor',
      budget: chatUserResponses.budget || 'Not specified',
      movein: chatUserResponses.move_in_date || 'Not specified',
      property: chatUserResponses.property || 'Not specified',
      responses: {...chatUserResponses},
      timestamp: new Date(),
      status: 'pending_assignment'
    };

    if(chatAlpsScore > WARM_SCORE_THRESHOLD){
      addMessage(`<div style="background:#e8f5e8;padding:12px;border-radius:12px;border-left:4px solid #2ecc71"><h3>High Priority Lead Detected!</h3><p><strong>Your ALPS Score: ${Math.round(chatAlpsScore)}/100</strong></p><p>This lead will be routed to our top sales agent for immediate attention.</p><p>Routing to agent now...</p></div>`, 'bot');
      setTimeout(() => routeLeadToAgent(newLead), 900);
    } else {
      addMessage(`<div style="background:#fff8e1;padding:12px;border-radius:12px;border-left:4px solid #f39c12"><h3>Lead Information Collected</h3><p><strong>ALPS Score: ${Math.round(chatAlpsScore)}/100</strong></p><p>Our AI will continue to assist you and help improve your score before connecting with an agent.</p></div>`, 'bot');
      newLead.agent = 'AI Bot';
      newLead.status = 'ai_handling';
      allLeadsDatabase.push(newLead);
      
      setTimeout(() => continueAIConversation(newLead), 1500);
    }
    nextLeadId++;
  }, 400);
}

function continueAIConversation(lead){
  const followUpQuestions = [
    "I'd like to help you find the perfect match! Can you tell me more about your preferred location within the area?",
    "What specific amenities are most important to you? (e.g., gym, pool, near public transport)",
    "Are you flexible with your move-in date? Sometimes we have great deals for immediate move-ins!",
    "Would you be interested in viewing similar properties in nearby areas that might offer better value?"
  ];
  
  const randomQuestion = followUpQuestions[Math.floor(Math.random() * followUpQuestions.length)];
  
  addMessage(`<div>${randomQuestion}</div><div class="options-container">
    <div class="option-button" onclick="handleAIResponse('positive', '${lead.id}')">Yes, I'm interested</div>
    <div class="option-button" onclick="handleAIResponse('neutral', '${lead.id}')">Tell me more</div>
    <div class="option-button" onclick="handleAIResponse('negative', '${lead.id}')">Not really</div>
  </div>`, 'bot');
}

function handleAIResponse(responseType, leadId){
  let scoreChange = 0;
  let responseText = '';
  
  switch(responseType){
    case 'positive':
      scoreChange = Math.floor(Math.random() * 15) + 10;
      responseText = 'Yes, I\'m interested';
      break;
    case 'neutral':
      scoreChange = Math.floor(Math.random() * 10) + 3;
      responseText = 'Tell me more';
      break;
    case 'negative':
      scoreChange = -(Math.floor(Math.random() * 8) + 2);
      responseText = 'Not really';
      break;
  }
  
  addMessage(responseText, 'user');
  
  chatAlpsScore = Math.max(0, Math.min(100, chatAlpsScore + scoreChange));
  updateChatScoreDisplay();
  
  const leadIndex = allLeadsDatabase.findIndex(l => l.id === leadId);
  if(leadIndex !== -1){
    allLeadsDatabase[leadIndex].score = Math.round(chatAlpsScore);
  }
  
  setTimeout(() => {
    if(chatAlpsScore > WARM_SCORE_THRESHOLD){
      addMessage(`<div style="background:#e8f5e8;padding:12px;border-radius:12px;border-left:4px solid #2ecc71"><h3>Great! Your score has improved!</h3><p><strong>Updated ALPS Score: ${Math.round(chatAlpsScore)}/100</strong></p><p>I'll now connect you with one of our top agents for personalized assistance.</p><p>Routing to agent...</p></div>`, 'bot');
      
      setTimeout(() => {
        if(leadIndex !== -1){
          routeLeadToAgent(allLeadsDatabase[leadIndex]);
        }
      }, 1000);
    } else {
      const responses = [
        "I understand. Let me see what other options I can offer you that might be a better fit.",
        "No worries! Based on what you've told me, I think I have some alternatives that might work better.",
        "That's fine. Let me suggest some properties that better match your preferences."
      ];
      const response = responses[Math.floor(Math.random() * responses.length)];
      
      addMessage(response, 'bot');
      
      setTimeout(() => {
        addMessage(`<div style="background:#e3f2fd;padding:12px;border-radius:12px;border-left:4px solid #2196f3"><p>Would you like to continue exploring options with me, or would you prefer to speak directly with one of our agents?</p></div><div class="options-container">
          <div class="option-button" onclick="continueWithAI('${leadId}')">Continue with AI</div>
          <div class="option-button" onclick="requestAgentNow('${leadId}')">Speak with Agent</div>
        </div>`, 'bot');
      }, 1500);
    }
  }, 1000);
}

function continueWithAI(leadId){
  addMessage('Continue with AI', 'user');
  const lead = allLeadsDatabase.find(l => l.id === leadId);
  if(lead) {
    setTimeout(() => continueAIConversation(lead), 1000);
  }
}

function requestAgentNow(leadId){
  addMessage('Speak with Agent', 'user');
  const lead = allLeadsDatabase.find(l => l.id === leadId);
  if(lead) {
    addMessage(`<div style="background:#fff8e1;padding:12px;border-radius:12px;border-left:4px solid #f39c12"><p>I'll connect you with an agent now, even though your current score is ${Math.round(chatAlpsScore)}. Our agent will help you find the perfect match!</p></div>`, 'bot');
    setTimeout(() => routeLeadToAgent(lead), 1000);
  }
}

function routeLeadToAgent(lead){
  const best = getNextAvailableAgent();
  if(best){
    const bestName = best.name;
    lead.agent = bestName; 
    lead.agentId = best.id; 
    lead.status = 'assigned';

    const convId = `conv_${lead.id}`;
    const conv = {
      id: convId, 
      leadId: lead.id, 
      leadNumber: lead.leadNumber,
      agentId: best.id, 
      agentName: bestName,
      score: lead.score, 
      area: lead.area, 
      budget: lead.budget,
      status: 'waiting_agent_response', 
      assignedTime: new Date(),
      messages: [{
        type: 'system',
        text: `Lead ${lead.leadNumber} has been assigned to you. Area: ${lead.area}, Budget: ${lead.budget}, Move-in: ${lead.movein}`,
        time: new Date().toLocaleTimeString()
      }],
      slaTimer: {type: 'initial', timeRemaining: INITIAL_RESPONSE_TIMEOUT, alertTriggered: false, overdue: 0}
    };

    const leadIndex = allLeadsDatabase.findIndex(l => l.id === lead.id);
    if(leadIndex !== -1){
      allLeadsDatabase[leadIndex] = lead;
    } else {
      allLeadsDatabase.push(lead);
    }
    
    addToSLAMonitoring(conv);

    setTimeout(() => addMessage(`<div style="background:#e3f2fd;padding:12px;border-radius:12px;border-left:4px solid #2196f3"><h3>Lead Successfully Routed!</h3><p><strong>Assigned to:</strong> ${bestName}</p><p><strong>Lead ID:</strong> ${lead.leadNumber}</p><p>Our agent will contact you shortly!</p></div>`, 'bot'), 500);
  } else {
    lead.status = 'in_queue'; 
    lead.agent = 'In Queue';
    const leadIndex = allLeadsDatabase.findIndex(l => l.id === lead.id);
    if(leadIndex !== -1){
      allLeadsDatabase[leadIndex] = lead;
    } else {
      allLeadsDatabase.push(lead);
    }
    addMessage(`<div style="background:#fff3e0;padding:12px;border-radius:12px;border-left:4px solid #ff9800"><h3>Added to Priority Queue</h3><p>All agents are currently busy. You've been added to our priority queue.</p><p>Estimated wait time: 3-5 minutes</p></div>`, 'bot');
  }
}

function addToSLAMonitoring(conversation){
  activeConversations[conversation.id] = conversation;
  agentConversations[conversation.agentId].push(conversation);
  refreshCurrentListView();
}

/* ======= UTIL ======= */
function addMessage(html, who){ 
  const box = document.getElementById('chatMessages'); 
  const d = document.createElement('div'); 
  d.className = 'message message-' + who; 
  d.innerHTML = html; 
  box.appendChild(d); 
  box.scrollTop = box.scrollHeight; 
}

function showTyping(){ 
  const el = document.getElementById('typingIndicator'); 
  if(el){
    el.style.display = 'block'; 
    document.getElementById('chatMessages').scrollTop = document.getElementById('chatMessages').scrollHeight;
  } 
}

function hideTyping(){ 
  const el = document.getElementById('typingIndicator'); 
  if(el) el.style.display = 'none'; 
}

function showNotification(msg, type = 'info'){
  const n = document.createElement('div');
  n.style.cssText = "position:fixed;top:20px;right:20px;padding:14px 18px;border-radius:8px;color:#fff;font-weight:700;z-index:1200;max-width:320px;box-shadow:0 8px 18px rgba(0,0,0,.2)";
  n.style.background = type === 'success' ? '#2ecc71' : type === 'warning' ? '#f39c12' : type === 'error' ? '#e74c3c' : '#3498db';
  n.textContent = msg; 
  document.body.appendChild(n); 
  setTimeout(() => n.remove(), 3000);
}

/* ======= QUEUE DRAG ======= */
function initializeDragAndDrop(){
  const list = document.getElementById('queueList');
  let dragged = null;
  
  list.addEventListener('dragstart', e => { 
    if(e.target.classList.contains('queue-item')){ 
      dragged = e.target; 
      e.target.style.opacity = '.5'; 
    }
  });
  
  list.addEventListener('dragend', e => { 
    if(e.target.classList.contains('queue-item')) e.target.style.opacity = ''; 
  });
  
  list.addEventListener('dragover', e => e.preventDefault());
  
  list.addEventListener('drop', e => {
    e.preventDefault();
    const t = e.target.closest('.queue-item');
    if(dragged && t && t !== dragged){
      const rect = t.getBoundingClientRect(); 
      const mid = rect.top + rect.height / 2;
      if(e.clientY < mid) list.insertBefore(dragged, t); 
      else list.insertBefore(dragged, t.nextSibling);
      updateQueuePositions();
    }
    dragged = null;
  });
}

function updateQueuePositions(){
  const items = [...document.querySelectorAll('#queueList .queue-item')];
  agentOrder.length = 0;
  items.forEach((it, i) => { 
    it.querySelector('.position-text').textContent = `Position: ${i + 1}`; 
    it.dataset.position = i + 1; 
    agentOrder.push(it.dataset.agent); 
  });
  
  agentOrder.forEach((agentId, i) => {
    if(i === 0) {
      AGENTS[agentId].role = 'Top Sales Agent';
    } else {
      AGENTS[agentId].role = 'Agent';
    }
  });
  
  renderAgentsGrid(); 
  renderQueueFromAgents();
  syncAgentCapacitiesToConversations();
}

/* ======= CLICK OUTSIDE ======= */
window.addEventListener('click', e => {
  const modal = document.getElementById('chartModal');
  if(e.target === modal) closeModal();
  const alertBox = document.getElementById('slaAlert');
  if(e.target === alertBox) alertBox.style.display = 'none';
});

/* ======= AGENT PAGE SHORTCUT ======= */
function goToAgentConversations(agentId){
  switchPage('sla');
  setTimeout(() => showAgentConversationsList(agentId), 150);
}
</script>
</body>
</html>







