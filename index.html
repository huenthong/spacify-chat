<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>BeLive ALPS Management Dashboard</title>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
<style>
  /* --- (kept your styling; only small copy tweaks) --- */
  *{margin:0;padding:0;box-sizing:border-box}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;background:#f5f6fa;height:100vh;overflow:hidden}
  .dashboard{display:flex;height:100vh}
  .sidebar{width:280px;background:#2c3e50;color:#fff;padding:20px;overflow-y:auto}
  .nav-item{padding:15px;margin:5px 0;border-radius:8px;cursor:pointer;display:flex;gap:10px;align-items:center;transition:.2s}
  .nav-item:hover,.nav-item.active{background:#34495e;transform:translateX(4px)}
  .nav-icon{font-size:20px}
  .main-content{flex:1;display:flex;flex-direction:column;overflow:hidden}
  .header{background:#fff;padding:20px;box-shadow:0 2px 10px rgba(0,0,0,.08);display:flex;justify-content:space-between;align-items:center}
  .content-area{flex:1;padding:20px;overflow-y:auto}
  .page{display:none}.page.active{display:block}

  .live-indicator{display:inline-flex;gap:6px;align-items:center;background:#e74c3c;color:#fff;padding:5px 10px;border-radius:14px;font-size:12px;font-weight:700}
  .pulse-dot{width:8px;height:8px;border-radius:50%;background:#fff;animation:pulse 2s infinite}
  @keyframes pulse{0%{opacity:1}50%{opacity:.5}100%{opacity:1}}

  .agents-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:20px;margin-bottom:30px}
  .agent-card{background:#fff;border-radius:15px;padding:20px;box-shadow:0 4px 14px rgba(0,0,0,.08);cursor:pointer;border-left:5px solid #3498db;transition:.2s}
  .agent-card:hover{transform:translateY(-4px)}
  .agent-card.available{border-left-color:#2ecc71}
  .agent-card.busy{border-left-color:#e74c3c}
  .agent-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
  .agent-name{font-weight:700}
  .agent-status{padding:5px 12px;border-radius:20px;font-size:12px;font-weight:700}
  .status-available{background:#2ecc71;color:#fff}
  .status-busy{background:#e74c3c;color:#fff}
  .capacity-bar{background:#ecf0f1;height:12px;border-radius:6px;overflow:hidden;margin:10px 0}
  .capacity-fill{height:100%;border-radius:6px;transition:width .4s}
  .capacity-low{background:#2ecc71}.capacity-medium{background:#f39c12}.capacity-high{background:#e74c3c}
  .agent-stats{display:flex;justify-content:space-between;margin-top:12px}
  .stat-item{text-align:center}.stat-number{font-weight:800;color:#2c3e50}

  .queue-management{background:#fff;border-radius:15px;padding:20px;box-shadow:0 4px 14px rgba(0,0,0,.08)}
  .queue-item{display:flex;justify-content:space-between;align-items:center;padding:14px;margin:10px 0;background:#f8f9fa;border-left:4px solid #3498db;border-radius:10px;cursor:move}
  .drag-handle{cursor:grab;color:#7f8c8d;font-size:18px}

  .leads-container{display:grid;grid-template-columns:1fr 1fr;gap:30px;height:100%}
  .leads-section{background:#fff;border-radius:15px;padding:20px;box-shadow:0 4px 14px rgba(0,0,0,.08);display:flex;flex-direction:column;overflow:hidden}
  .section-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;padding-bottom:12px;border-bottom:2px solid #ecf0f1}
  .leads-list{flex:1;overflow-y:auto}
  .lead-item{display:flex;gap:12px;align-items:center;background:#f8f9fa;border-radius:12px;padding:14px;margin:10px 0;border-left:4px solid #95a5a6;cursor:pointer;transition:.2s}
  .lead-item:hover{transform:translateX(4px)}
  .lead-item.hot{border-left-color:#e74c3c;background:linear-gradient(135deg,#ffebee,#f8f9fa)}
  .lead-item.warm{border-left-color:#f39c12;background:linear-gradient(135deg,#fff8e1,#f8f9fa)}
  .lead-score{width:56px;height:56px;border-radius:50%;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:800}
  .score-hot{background:linear-gradient(135deg,#e74c3c,#c0392b)}
  .score-warm{background:linear-gradient(135deg,#f39c12,#e67e22)}
  .score-cold{background:linear-gradient(135deg,#95a5a6,#7f8c8d)}

  .chat-container{background:#fff;border-radius:15px;box-shadow:0 4px 14px rgba(0,0,0,.08);height:100%;display:flex;flex-direction:column;position:relative}
  .chat-header{background:#25D366;color:#fff;padding:18px;border-radius:15px 15px 0 0;display:flex;justify-content:space-between}
  .chat-messages{flex:1;overflow-y:auto;padding:18px;background:#e5ddd5;position:relative}
  .message{max-width:70%;padding:12px 16px;margin:10px 0;border-radius:18px;display:flex;flex-direction:column}
  .message-bot{background:#fff;align-self:flex-start;border-bottom-left-radius:4px;box-shadow:0 1px 2px rgba(0,0,0,.08)}
  .message-user{background:#DCF8C6;align-self:flex-end;border-bottom-right-radius:4px;margin-left:auto;box-shadow:0 1px 2px rgba(0,0,0,.08)}
  .message-system{background:#fff3cd!important;border:2px solid #ffeaa7!important;text-align:center!important;max-width:90%!important;margin:10px auto!important}
  .message-ai-takeover{background:#e3f2fd!important;border:2px solid #2196f3!important;text-align:center!important;max-width:90%!important;margin:10px auto!important}

  .score-display{position:fixed;top:130px;right:20px;background:rgba(255,255,255,.98);padding:14px;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,.12);min-width:200px;z-index:1000}
  .score-bar{height:20px;background:#e0e0e0;border-radius:10px;overflow:hidden;margin:8px 0}
  .score-fill{height:100%;border-radius:10px;transition:width .4s}

  .sla-container{display:grid;grid-template-columns:1fr 2fr;gap:20px;height:100%}
  .conversations-list{background:#fff;border-radius:15px;padding:20px;box-shadow:0 4px 14px rgba(0,0,0,.08);overflow-y:auto}
  .conversation-item{padding:14px;margin:10px 0;background:#f8f9fa;border-radius:10px;border-left:4px solid #3498db;cursor:pointer;transition:.2s;position:relative}
  .conversation-item:hover{background:#e3f2fd;transform:translateX(4px)}
  .conversation-item.sla-warning{border-left-color:#f39c12;background:#fff8e1}
  .conversation-item.sla-breach{border-left-color:#e74c3c;background:#ffebee}
  .sla-timer{display:flex;gap:10px;align-items:center;margin-top:8px}
  .timer-badge{padding:5px 10px;border-radius:14px;font-weight:800;font-size:12px}
  .timer-negative{background:#f39c12;color:#fff}
  .timer-positive{background:#e74c3c;color:#fff}
  .sla-chat-area{background:#fff;border-radius:15px;box-shadow:0 4px 14px rgba(0,0,0,.08);display:flex;flex-direction:column}
  .sla-chat-header{background:#34495e;color:#fff;padding:18px;border-radius:15px 15px 0 0;display:flex;justify-content:space-between;align-items:center}
  .sla-messages{flex:1;overflow-y:auto;padding:18px;background:#f8f9fa}
  .sla-input{display:flex;gap:10px;padding:18px;border-top:1px solid #ecf0f1}
  .sla-input input{flex:1;padding:12px;border:2px solid #ecf0f1;border-radius:22px;outline:none}
  .sla-input button{padding:12px 18px;border:none;border-radius:22px;color:#fff;background:#25D366;cursor:pointer}

  .options-container{display:flex;flex-direction:column;gap:8px;margin-top:10px}
  .option-button{padding:10px 14px;background:#f0f0f0;border:2px solid #e0e0e0;border-radius:20px;cursor:pointer;text-align:center;transition:.2s}
  .option-button:hover{background:#25D366;color:#fff;border-color:#25D366}
  .property-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:10px;margin-top:10px}
  .property-item{padding:12px;background:#f8f9fa;border:2px solid #e9ecef;border-radius:12px;text-align:center;cursor:pointer;transition:.2s}
  .property-item:hover{background:#25D366;color:#fff;border-color:#25D366}
  .input-field{width:100%;padding:12px;border:2px solid #e0e0e0;border-radius:20px;margin-top:10px;outline:none}
  .input-field:focus{border-color:#25D366}
  .typing-indicator{display:none;background:#fff;padding:14px;border-radius:18px;max-width:70%;border-bottom-left-radius:4px}
  .typing-dots{display:flex;gap:4px}.typing-dot{width:8px;height:8px;background:#999;border-radius:50%;animation:typing 1.4s infinite}
  .typing-dot:nth-child(2){animation-delay:.2s}.typing-dot:nth-child(3){animation-delay:.4s}
  @keyframes typing{0%,60%,100%{transform:translateY(0)}30%{transform:translateY(-8px)}}

  .checkbox-group{margin-top:10px}
  .checkbox-item{display:flex;align-items:center;gap:8px;padding:8px;margin:4px 0;border-radius:8px;cursor:pointer;transition:.2s}
  .checkbox-item:hover,.checkbox-item.selected{background:#e8f5e8}
  .checkbox-item input{margin:0}
  .continue-btn{margin-top:10px;padding:10px 20px;background:#25D366;color:#fff;border:none;border-radius:20px;cursor:pointer}
  .continue-btn:hover{background:#1ea952}

  .modal{display:none;position:fixed;z-index:1000;inset:0;background:rgba(0,0,0,.5)}
  .modal-content{background:#fff;margin:5% auto;padding:24px;border-radius:14px;width:80%;max-width:820px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
  .close{float:right;font-size:26px;cursor:pointer;color:#666}
  .close:hover{color:#333}
  .btn{padding:10px 18px;border:none;border-radius:8px;cursor:pointer;font-weight:700;transition:.2s}
  .btn:hover{transform:translateY(-1px)}
  .btn-primary{background:#3498db;color:#fff}.btn-primary:hover{background:#2980b9}
  .btn-danger{background:#e74c3c;color:#fff}.btn-danger:hover{background:#c0392b}

  .sla-alert{position:fixed;z-index:1100;top:50%;left:50%;transform:translate(-50%,-50%);background:#fff;padding:26px;border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.3);display:none;border-left:5px solid #e74c3c;max-width:500px}
  .alert-actions{display:flex;gap:12px;margin-top:16px;justify-content:center}

  .live-score-badge{position:absolute;top:5px;right:5px;background:#3498db;color:#fff;padding:2px 8px;border-radius:10px;font-size:11px;font-weight:700}
  .message-score{position:absolute;top:5px;right:5px;background:rgba(52,152,219,.1);border:1px solid #3498db;color:#3498db;padding:2px 6px;border-radius:8px;font-size:10px;font-weight:700}

  .status-indicator{font-size:12px;font-weight:600}
  @media(max-width:900px){
    .leads-container{grid-template-columns:1fr}
    .sla-container{grid-template-columns:1fr}
    .chat-container{padding-right:0}
    .score-display{position:relative;top:0;right:0;margin:10px}
  }
</style>
</head>
<body>
<div class="dashboard">
  <div class="sidebar">
    <h2 style="margin-bottom:24px">üè† BeLive ALPS</h2>
    <div class="nav-item active" data-page="agents"><span class="nav-icon">üë•</span><span>Agent Status</span></div>
    <div class="nav-item" data-page="leads"><span class="nav-icon">üìä</span><span>Lead Management</span></div>
    <div class="nav-item" data-page="chat"><span class="nav-icon">üí¨</span><span>Chat Window</span></div>
    <div class="nav-item" data-page="sla"><span class="nav-icon">‚è±Ô∏è</span><span>SLA Monitoring</span></div>

    <div style="margin-top:36px;padding:16px;background:rgba(255,255,255,.1);border-radius:10px">
      <div class="live-indicator"><div class="pulse-dot"></div>LIVE</div>
      <div style="margin-top:10px;font-size:14px">
        System Status: Active<br/>Last Update: <span id="lastUpdate">--:--:--</span>
      </div>
    </div>
  </div>

  <div class="main-content">
    <div class="header">
      <div>
        <h1 id="pageTitle">Agent Status Dashboard</h1>
        <p id="pageSubtitle">Real-time agent monitoring and queue management</p>
      </div>
      <div class="live-indicator"><div class="pulse-dot"></div>LIVE DASHBOARD</div>
    </div>

    <div class="content-area">
      <!-- Agents -->
      <div id="agents" class="page active">
        <div class="agents-grid" id="agentsGrid"></div>

        <div class="queue-management">
          <h3 style="margin-bottom:12px">üìã Agent Queue Management</h3>
          <p style="margin-bottom:10px;color:#7f8c8d">Drag to reorder round-robin priority ‚Ä¢ Position 1 is Top Sales</p>
          <div id="queueList"></div>
        </div>
      </div>

      <!-- Leads -->
      <div id="leads" class="page">
        <div class="leads-container">
          <div class="leads-section">
            <div class="section-header">
              <h3>üî• Ongoing Leads</h3>
              <div class="live-indicator"><div class="pulse-dot"></div>LIVE</div>
            </div>
            <div class="leads-list" id="ongoingLeads"></div>
          </div>

          <div class="leads-section">
            <div class="section-header">
              <h3>üìã Past Leads</h3>
              <div style="font-size:14px;color:#7f8c8d">Last 24 hours</div>
            </div>
            <div class="leads-list" id="pastLeads"></div>
          </div>
        </div>
      </div>

      <!-- Chat (AI qualification) -->
      <div id="chat" class="page">
        <div class="chat-container">
          <div class="chat-header">
            <div>
              <h3>ü§ñ BeLive AI Assistant</h3>
              <div>Lead Qualification Chat ‚Ä¢ AI handles **Cold** until score improves</div>
            </div>
          </div>

          <div class="chat-messages" id="chatMessages">
            <div class="typing-indicator" id="typingIndicator">
              <div class="typing-dots">
                <div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- SLA -->
      <div id="sla" class="page">
        <div class="sla-container">
          <div class="conversations-list" id="conversationsList"></div>

          <div class="sla-chat-area">
            <div class="sla-chat-header">
              <div>
                <h3 id="slaCurrentChat">Select a conversation</h3>
                <div id="slaCurrentDetails">Click on a conversation to view details</div>
              </div>
              <div style="display:flex;gap:8px;align-items:center">
                <button class="btn btn-primary" id="dealBtn" style="display:none" onclick="markConversationAsDeal()">Deal (Closed Won)</button>
                <div id="slaCurrentTimer" style="background:rgba(255,255,255,.2);padding:10px;border-radius:10px">--:--</div>
              </div>
            </div>

            <div class="sla-messages" id="slaMessages">
              <div style="text-align:center;color:#7f8c8d;margin-top:40px">
                <h3>üí¨ SLA Chat Monitor</h3>
                <p>Select a conversation from the left to view and manage the chat</p>
              </div>
            </div>

            <div class="sla-input" id="slaInputArea" style="display:none">
              <input id="slaMessageInput" type="text" placeholder="Type your message..." onkeypress="handleSLAMessage(event)"/>
              <button onclick="sendSLAMessage()">Send</button>
              <button onclick="escalateConversation()" style="background:#e74c3c">Escalate</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Fixed Score Display -->
<div class="score-display" id="scoreFloater" style="display:none">
  <h4>ALPS Score</h4>
  <div class="score-bar"><div class="score-fill score-cold" id="chatScoreBar" style="width:0%"></div></div>
  <div id="chatScoreText">0 / 100</div>
  <div id="chatScoreCategory">Getting Started</div>
</div>

<!-- SLA Alert -->
<div id="slaAlert" class="sla-alert">
  <h3>üö® SLA BREACH ALERT</h3>
  <p>Agent has not responded within the SLA timeframe</p>
  <div style="margin:12px 0;padding:12px;background:#fff3cd;border-radius:8px">
    <strong>Conversation:</strong> <span id="alertConversation">Lead #</span><br/>
    <strong>Agent:</strong> <span id="alertAgent">-</span><br/>
    <strong>Time Exceeded:</strong> <span id="alertTime">+0:01</span>
  </div>
  <div class="alert-actions">
    <button class="btn btn-primary" onclick="goToConversation()">Go to Conversation</button>
    <button class="btn btn-danger" onclick="reassignConversation()">Reassign</button>
  </div>
</div>

<script>
'use strict';

/* ======= CONFIG ======= */
const CAPACITY_LIMIT = 3;                 // <<< capacity 3
const MODEL_SOURCE = 'server';
const SCORE_ENDPOINT = 'https://web-production-11d29.up.railway.app/api/score';
const INITIAL_RESPONSE_TIMEOUT = 60;      // <<< 1 minute for first response
const ONGOING_RESPONSE_TIMEOUT = 60;      // <<< 1 minute ongoing
const DEBUG_MODE = false;

/* ======= GLOBAL STATE ======= */
let currentPage = 'agents';
let currentListView = {type:'all', id:null};
let selectedConversation = null;
let lastAlertConvId = null;

let leadChart = null;
let realTimeInterval;
let nextAgentIndex = 0;

// Agents
const agentOrder = ['agent1','agent2','agent3','agent4','agent5'];
const AGENTS = {
  agent1:{name:'Sarah Chen'},
  agent2:{name:'Mike Johnson'},
  agent3:{name:'Lisa Wong'},
  agent4:{name:'David Lim'},
  agent5:{name:'Jennifer Tan'}
};
// each agent starts 0/3
const agentConversations = {agent1:[],agent2:[],agent3:[],agent4:[],agent5:[]};

// conversations indexed by id
const activeConversations = {};
let nextLeadId = 2024010;
let completedLeads = [];
let allLeadsDatabase = [];

/* ======= UTILS ======= */
const clamp = (x,min,max)=>Math.max(min,Math.min(max,x));
const nowHHMMSS = ()=>new Date().toLocaleTimeString();

/* ======= INIT ======= */
document.addEventListener('DOMContentLoaded', () => {
  document.querySelectorAll('.nav-item').forEach(item=>{
    item.addEventListener('click',()=>switchPage(item.dataset.page));
  });

  renderAgentsGrid();
  renderQueueFromAgents();
  initializeDragAndDrop();
  startRealTimeLoop();
  seedInitialLeads();
});

/* ======= NAV ======= */
function switchPage(pageName){
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
  document.getElementById(pageName).classList.add('active');
  document.querySelector(`.nav-item[data-page="${pageName}"]`).classList.add('active');
  currentPage = pageName;
  const t={agents:'Agent Status Dashboard',leads:'Lead Management',chat:'AI Chat Interface',sla:'SLA Monitoring'};
  const s={agents:'Real-time agent monitoring and queue management',leads:'Lead scoring and progression tracking',chat:'AI-powered lead qualification system',sla:'Response time monitoring and escalation'};
  document.getElementById('pageTitle').textContent=t[pageName];
  document.getElementById('pageSubtitle').textContent=s[pageName];

  if(pageName==='chat'){ 
    setTimeout(initializeChat,200); 
    document.getElementById('scoreFloater').style.display = 'block';
  } else {
    document.getElementById('scoreFloater').style.display = 'none';
  }
  if(pageName==='sla'){ showAllConversations(); }
  if(pageName==='leads'){ refreshLeadsView(); }
}

/* ======= REAL-TIME LOOP ======= */
function startRealTimeLoop(){
  clearInterval(realTimeInterval);
  realTimeInterval = setInterval(()=>{
    document.getElementById('lastUpdate').textContent=new Date().toLocaleTimeString();
    syncAgentCapacitiesToConversations();
    tickSLATimers();
    if(currentPage === 'leads') refreshLeadsView();
  },1000);
}

/* ======= AGENTS ======= */
function currentStatusByCount(count){
  return count >= CAPACITY_LIMIT ? 'busy' : 'available';
}

function syncAgentCapacitiesToConversations(){
  agentOrder.forEach(agentId=>{
    const card = document.querySelector(`.agent-card[data-agent="${agentId}"]`);
    if(!card) return;
    const count = agentConversations[agentId].length;
    const bar = card.querySelector('.capacity-fill');
    const txt = card.querySelector('.capacity-text');
    const pct = Math.min(100, (count/CAPACITY_LIMIT)*100);
    bar.style.width = pct+'%';
    bar.className = 'capacity-fill ' + (pct<=33?'capacity-low':pct<=66?'capacity-medium':'capacity-high');
    txt.textContent = `Capacity: ${count}/${CAPACITY_LIMIT} chats`;

    // status chip + border color
    const statusEl = card.querySelector('.agent-status');
    const status = currentStatusByCount(count);
    statusEl.textContent = status==='busy' ? 'Busy' : 'Available';
    statusEl.className = 'agent-status ' + (status==='busy'?'status-busy':'status-available');
    card.classList.toggle('busy', status==='busy');
    card.classList.toggle('available', status==='available');
  });
}

function renderAgentsGrid(){
  const grid = document.getElementById('agentsGrid');
  grid.innerHTML = '';
  agentOrder.forEach((id, index)=>{
    const name = AGENTS[id].name;
    const cap = agentConversations[id].length;
    const status = currentStatusByCount(cap);
    grid.innerHTML += `
      <div class="agent-card ${status}" data-agent="${id}">
        <div class="agent-header">
          <div class="agent-name">${index===0?'üëë ':''}${name}</div>
          <div class="agent-status ${status==='busy'?'status-busy':'status-available'}">${status==='busy'?'Busy':'Available'}</div>
        </div>
        <div>${index===0?'Top Sales Agent':'Agent'} ‚Ä¢ Queue Position: ${index+1}</div>
        <div class="capacity-bar"><div class="capacity-fill capacity-low" style="width:${(cap/CAPACITY_LIMIT)*100}%"></div></div>
        <div class="capacity-text">Capacity: ${cap}/${CAPACITY_LIMIT} chats</div>
        <div class="agent-stats">
          <div class="stat-item"><div class="stat-number">${90-index*2}%</div><div class="stat-label">SLA Rate</div></div>
          <div class="stat-item"><div class="stat-number">${(8.7-index*0.2).toFixed(2)}</div><div class="stat-label">Avg Score</div></div>
          <div class="stat-item"><div class="stat-number">${24-index*3}</div><div class="stat-label">Leads Today</div></div>
        </div>
      </div>`;
  });
  // click-to-filter
  document.getElementById('agentsGrid').onclick = (e)=>{
    const card = e.target.closest('.agent-card');
    if(card) goToAgentConversations(card.dataset.agent);
  };
  syncAgentCapacitiesToConversations();
}

function renderQueueFromAgents(){
  const q = document.getElementById('queueList');
  q.innerHTML = '';
  agentOrder.forEach((id, i)=>{
    q.innerHTML += `
      <div class="queue-item" draggable="true" data-agent="${id}" data-position="${i+1}">
        <div style="display:flex;align-items:center;gap:12px">
          <div class="drag-handle">‚â°</div>
          <div>${i===0?'üëë ':''}<strong>${AGENTS[id].name}</strong> - ${i===0?'Top Sales':'Agent'}</div>
        </div>
        <div class="position-text">Position: ${i+1}</div>
      </div>`;
  });
}

function initializeDragAndDrop(){
  const list = document.getElementById('queueList');
  let dragEl = null;
  list.addEventListener('dragstart', e=>{
    dragEl = e.target.closest('.queue-item');
    e.dataTransfer.effectAllowed='move';
  });
  list.addEventListener('dragover', e=>{
    e.preventDefault();
    const item = e.target.closest('.queue-item');
    if(!item || item===dragEl) return;
    const rect = item.getBoundingClientRect();
    const after = (e.clientY - rect.top) > rect.height/2;
    list.insertBefore(dragEl, after ? item.nextSibling : item);
  });
  list.addEventListener('drop', ()=>{
    // rebuild agentOrder
    const ids = [...list.querySelectorAll('.queue-item')].map(x=>x.dataset.agent);
    agentOrder.splice(0, agentOrder.length, ...ids);
    renderAgentsGrid();
    renderQueueFromAgents();
    initializeDragAndDrop();
  });
}

/* ======= ROUND ROBIN AND MOST-AVAILABLE ======= */
function getNextAvailableAgent(){
  // round-robin first pass
  for(let i=0;i<agentOrder.length;i++){
    const agentId = agentOrder[nextAgentIndex];
    nextAgentIndex = (nextAgentIndex + 1) % agentOrder.length;
    if(agentConversations[agentId].length < CAPACITY_LIMIT){
      return {id: agentId, name: AGENTS[agentId].name};
    }
  }
  return null;
}

function getMostAvailableAgent(){
  // choose the agent with the fewest conversations (< capacity), tiebreak by order
  const candidates = agentOrder
    .map(id=>({id, load: agentConversations[id].length}))
    .filter(a=>a.load < CAPACITY_LIMIT);
  if(!candidates.length) return null;
  candidates.sort((a,b)=>a.load-b.load || agentOrder.indexOf(a.id)-agentOrder.indexOf(b.id));
  const a = candidates[0];
  return {id:a.id, name:AGENTS[a.id].name};
}

/* ======= LEADS MANAGEMENT ======= */
function leadCategory(score){
  if(score>50) return 'hot';
  if(score>40) return 'warm';
  return 'cold';
}

function seedInitialLeads(){
  // start empty; everything comes from chat or your own seeding
  allLeadsDatabase = [];
  refreshLeadsView();
}

function refreshLeadsView(){
  const ongoingContainer = document.getElementById('ongoingLeads');
  const pastContainer = document.getElementById('pastLeads');
  ongoingContainer.innerHTML = '';
  pastContainer.innerHTML = '';

  const renderLead = (lead)=>{
    const cls = leadCategory(lead.score);
    const scoreCls = cls==='hot' ? 'score-hot' : cls==='warm' ? 'score-warm' : 'score-cold';
    const el = document.createElement('div');
    el.className = `lead-item ${cls}`;
    el.setAttribute('data-lead', lead.id);
    el.onclick = () => showLeadChart(lead.id);
    el.innerHTML = `
      <div class="lead-score ${scoreCls}">${lead.score}</div>
      <div class="lead-info">
        <div class="lead-name">${cls==='hot'?'üî• ':''}Lead ${lead.leadNumber}</div>
        <div class="lead-details">Area: ${lead.area||'-'} ‚Ä¢ Budget: RM${lead.budget||'-'}<br/>Move-in: ${lead.movein||'-'} ‚Ä¢ Agent: ${lead.agent||'-'}</div>
        <div class="lead-timestamp">Started: ${lead.timestamp ? new Date(lead.timestamp).toLocaleTimeString() : nowHHMMSS()} ‚Ä¢ Status: ${getLeadStatusText(lead.status)}</div>
      </div>`;
    return el;
  };

  allLeadsDatabase.forEach(lead=>{
    const isOngoing = ['assigned','ai_handling','in_queue','ai_takeover','ongoing','waiting_agent_response','unassigned'].includes(lead.status);
    const container = isOngoing ? ongoingContainer : pastContainer;
    container.appendChild(renderLead(lead));
  });

  completedLeads.forEach(lead=>{
    const el = renderLead(lead);
    pastContainer.appendChild(el);
  });
}

/* ======= SERVER SCORING ======= */
async function recomputeScoreFromFeatures(features){
  if (MODEL_SOURCE !== 'server') {
    console.log('[ALPS] Using CLIENT heuristic (MODEL_SOURCE!=server)');
    return clientSideHeuristicScore(features);
  }
  try {
    console.log('[ALPS] POST ‚Üí', SCORE_ENDPOINT, 'payload:', features);
    const response = await fetch(SCORE_ENDPOINT, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(features)
    });
    if(!response.ok) {
      console.warn('[ALPS] Server returned non-OK', response.status);
      throw new Error(`HTTP error ${response.status}`);
    }
    const data = await response.json();
    console.log('[ALPS] Server response:', data);

    const score = clamp(Math.round(data.score ?? data.alps_score ?? 50), 0, 100);
    return score;
  } catch(e){
    console.error('[ALPS] Falling back to CLIENT heuristic due to:', e);
    return clientSideHeuristicScore(features);
  }
}


/* ======= SIMPLE CLIENT HEURISTIC (fallback only) ======= */
function clientSideHeuristicScore(features){
  let score = 0;
  if(features.area) score+=10;
  if(features.property) score+=10;
  if(features.budget){
    const b = parseInt(features.budget)||0;
    score += b>=1200?25:b>=900?20:b>=600?15:b>=400?10:b>0?5:0;
  }
  if(features.movein){
    try{
      const d = Math.ceil((new Date(features.movein)-new Date())/(1000*60*60*24));
      score += d<=7?20:d<=30?16:d<=90?12:8;
    }catch{score+=8}
  }
  return clamp(Math.round(score),0,100);
}

/* ======= CHAT (AI QUALIFICATION FLOW) ======= */
const AREAS = ["KL/Selangor","Perak","JB/Penang","Negeri Sembilan","Genting Highlands"];
const PROPERTIES = ["121 Residence","Ampang","Mont Kiara","Ara Damansara","Cheras","Subang Jaya","Petaling Jaya","M Vertica","Sunway Serene"];
const questions = [
  {id:'area',text:"Hi! Welcome to BeLive. Choose an area:",type:'select',options:AREAS},
  {id:'property',text:"Great choice! Pick a property:",type:'property_select'},
  {id:'budget',text:"What's your budget (RM)?",type:'input',placeholder:'e.g., 800'},
  {id:'pax',text:'How many people will be staying?',type:'select',options:['1 person','2 people','More than 2']},
  {id:'car',text:'Do you have a car?',type:'select',options:['Yes','No']},
  {id:'parking',text:'Do you need a car park lot?',type:'select',options:['Yes','No']},
  {id:'movein',text:'When are you planning to move in?',type:'date'},
  {id:'tenancy',text:"Preferred tenancy?",type:'select',options:['6 months','12 months']},
  {id:'gender',text:"What's your gender?",type:'select',options:['Male','Female']},
  {id:'unit_spec',text:'Unit type (multi-select)',type:'multiple',options:['Female unit','Male unit','Mixed Gender unit']},
  {id:'workplace',text:'Where is your workplace?',type:'input',placeholder:'KLCC, Cyberjaya'},
  {id:'nationality',text:"What's your nationality?",type:'select',options:['Malaysian','Others']}
];

let chatCurrentStep = 0;
let chatUserResponses = {};
let chatAlpsScore = 0;

function initializeChat(){
  chatCurrentStep = 0;
  chatUserResponses = {};
  chatAlpsScore = 0;
  document.getElementById('chatMessages').innerHTML = '';
  askNextQuestion();
  updateScoreFloater(0);
}

function updateScoreFloater(score){
  const bar = document.getElementById('chatScoreBar');
  const text = document.getElementById('chatScoreText');
  const cat = document.getElementById('chatScoreCategory');
  bar.style.width = score+'%';
  bar.className = 'score-fill ' + (score>50?'score-hot':score>40?'score-warm':'score-cold');
  text.textContent = `${score} / 100`;
  cat.textContent = score>50?'Hot Lead':score>40?'Warm Lead':'Cold Lead';
}

async function askNextQuestion(){
  const mbox = document.getElementById('chatMessages');
  if(chatCurrentStep>=questions.length){
    // ALL ANSWERED: decide routing
    const score = await recomputeScoreFromFeatures(chatUserResponses);
    chatAlpsScore = score;
    updateScoreFloater(score);
    routeLeadAfterQualification(score);
    return;
  }
  const q = questions[chatCurrentStep];
  const div = document.createElement('div');
  div.className = 'message message-bot';
  div.innerHTML = `<div>${q.text}</div>`;
  if(q.type==='select' || q.type==='property_select'){
    const opts = (q.type==='property_select') ? PROPERTIES : q.options;
    const box = document.createElement('div');
    box.className='options-container';
    opts.forEach(opt=>{
      const b = document.createElement('div');
      b.className='option-button';
      b.textContent = opt;
      b.onclick = ()=>handleChatAnswer(q.id,opt);
      box.appendChild(b);
    });
    div.appendChild(box);
  }else if(q.type==='input'){
    div.innerHTML += `<input class="input-field" id="input_${q.id}" placeholder="${q.placeholder||''}" />`;
    div.innerHTML += `<button class="continue-btn" onclick="submitInput('${q.id}')">Continue</button>`;
  }else if(q.type==='date'){
    div.innerHTML += `<input class="input-field" type="date" id="input_${q.id}" />`;
    div.innerHTML += `<button class="continue-btn" onclick="submitInput('${q.id}')">Continue</button>`;
  }else if(q.type==='multiple'){
    const box = document.createElement('div'); box.className='checkbox-group';
    q.options.forEach(opt=>{
      const item = document.createElement('label');
      item.className='checkbox-item';
      item.innerHTML = `<input type="checkbox" value="${opt}"/><span>${opt}</span>`;
      item.onclick = ()=>item.classList.toggle('selected');
      box.appendChild(item);
    });
    div.appendChild(box);
    div.innerHTML += `<button class="continue-btn" onclick="submitMultiple('${q.id}')">Continue</button>`;
  }
  mbox.appendChild(div);
  mbox.scrollTop = mbox.scrollHeight;
}

function submitInput(id){
  const el = document.getElementById(`input_${id}`);
  if(!el || !el.value.trim()) return;
  handleChatAnswer(id, el.value.trim());
}
function submitMultiple(id){
  const checks = [...document.querySelectorAll('.checkbox-group .checkbox-item input:checked')].map(c=>c.value);
  handleChatAnswer(id, checks);
}
async function handleChatAnswer(id, value){
  chatUserResponses[id] = value;
  echoUser(value);
  chatCurrentStep++;

  // recompute score incrementally to determine AI->Agent switch for cold leads
  const score = await recomputeScoreFromFeatures(chatUserResponses);
  chatAlpsScore = score;
  updateScoreFloater(score);

  askNextQuestion();
}
function echoUser(text){
  const mbox = document.getElementById('chatMessages');
  const d = document.createElement('div');
  d.className='message message-user';
  d.innerHTML = `<div>${Array.isArray(text)?text.join(', '):text}</div><div style="font-size:12px;color:#7f8c8d;margin-top:5px">${nowHHMMSS()}</div>`;
  mbox.appendChild(d);
  mbox.scrollTop = mbox.scrollHeight;
}

/* ======= ROUTING ======= */
function routeLeadAfterQualification(score){
  const category = leadCategory(score);
  const lead = {
    id:`lead${nextLeadId}`,
    leadNumber:`#${nextLeadId}`,
    score,
    area:chatUserResponses.area,
    budget:chatUserResponses.budget,
    movein:chatUserResponses.movein,
    property:chatUserResponses.property,
    status: category==='cold' ? 'ai_handling' : 'assigned',
    timestamp: Date.now(),
    responses: {...chatUserResponses}
  };
  nextLeadId++;

  if(category==='cold'){
    // keep with AI, visible in ongoing leads as AI handling
    lead.agent = 'AI Bot';
    allLeadsDatabase.push(lead);
    refreshLeadsView();
    switchPage('chat'); // stay
    return;
  }

  // Hot/Warm => assign via round-robin
  const pick = getNextAvailableAgent();
  if(!pick){
    lead.status = 'in_queue';
    lead.agent = 'In Queue';
    allLeadsDatabase.push(lead);
    refreshLeadsView();
    return;
  }

  lead.agent = pick.name;
  allLeadsDatabase.push(lead);

  // create conversation
  const convId = `conv_${Date.now()}_${Math.random().toString(36).slice(2,7)}`;
  const conv = {
    id: convId,
    leadNumber: lead.leadNumber,
    area: lead.area,
    score: lead.score,
    agentId: pick.id,
    agentName: pick.name,
    status: 'waiting_agent_response',
    messages: [{type:'system', text:`Assigned to ${pick.name} via round-robin`, time: nowHHMMSS()}],
    slaTimer: {type:'initial', timeRemaining: INITIAL_RESPONSE_TIMEOUT, alertTriggered:false, overdue:0},
    scoreHistory: [{time: nowHHMMSS(), score: lead.score}]
  };
  activeConversations[convId] = conv;
  agentConversations[pick.id].push(conv);
  refreshLeadsView();
  switchPage('sla');
  showAllConversations();
  openSLAChat(convId);
}

/* ======= SLA / CHAT WITH AGENTS ======= */
function tickSLATimers(){
  Object.values(activeConversations).forEach(conv=>{
    const t = conv.slaTimer;
    if(!t) return;

    if(t.timeRemaining > 0){
      t.timeRemaining--;
      if(t.timeRemaining <= 0){
        if(t.type === 'initial'){
          // reroute to MOST AVAILABLE (not round-robin)
          reassignToMostAvailable(conv);
        } else {
          t.alertTriggered = true;
          t.overdue = 1;
          showSlaAlert(conv.id);
        }
      }
    } else if(t.overdue > 0 || t.alertTriggered){
      t.overdue++;
    }
    updateConversationListItem(conv.id);
    if(selectedConversation === conv.id) openSLAChat(conv.id);
  });
}

function buildConversationRow(conv){
  const el = document.createElement('div');
  el.className = getConversationClass(conv) + ' conversation-item';
  el.dataset.conv = conv.id;
  el.onclick = () => openSLAChat(conv.id);
  const s = getConversationStatus(conv);
  const t = getConversationTimer(conv);
  const scoreColor = conv.score>50 ? '#e74c3c' : conv.score>40 ? '#f39c12' : '#95a5a6';
  el.innerHTML = `
    <div style="display:flex;justify-content:space-between;align-items:start">
      <div><div><strong>Lead ${conv.leadNumber}</strong> ‚Ä¢ ${conv.agentName}</div><div style="font-size:14px;color:#7f8c8d">${conv.area||'-'} ‚Ä¢ ALPS: ${conv.score}</div></div>
      <div style="text-align:right"><div class="status-indicator" style="font-size:12px">${s.status}</div></div>
    </div>
    <div class="sla-timer"><div class="timer-badge ${t.class}">${t.text}</div><div style="font-size:12px">${t.description}</div></div>
    <div class="live-score-badge" style="background:${scoreColor}">${conv.score}</div>`;
  return el;
}

function showAllConversations(){
  currentListView = {type:'all', id:null};
  const list = document.getElementById('conversationsList');
  list.innerHTML = `<h3 style="margin-bottom:12px">üí¨ Active Conversations</h3><div id="convList"></div>`;
  const container = list.querySelector('#convList');
  Object.values(activeConversations).forEach(c => container.appendChild(buildConversationRow(c)));
}

function goToAgentConversations(agentId){
  switchPage('sla');
  showAgentConversationsList(agentId);
}

function showAgentConversationsList(agentId){
  currentListView = {type:'agent', id:agentId};
  const list = document.getElementById('conversationsList');
  const name = AGENTS[agentId].name;
  const convs = agentConversations[agentId];

  list.innerHTML = `
    <h3 style="margin-bottom:12px">üí¨ ${name}'s Conversations</h3>
    <div style="margin-bottom:10px;font-size:14px;color:#7f8c8d">Active: ${convs.length} conversations</div>
    <button onclick="showAllConversations()" class="btn btn-primary" style="margin-bottom:10px">‚Üê Back to All</button>
    <div id="convList"></div>`;
  const container = list.querySelector('#convList');

  if(!convs.length){
    container.innerHTML = `<div style="text-align:center;color:#7f8c8d;margin-top:40px"><p>No active conversations</p></div>`;
    selectedConversation = null;
    document.getElementById('slaMessages').innerHTML = `<div style="text-align:center;color:#7f8c8d;margin-top:40px"><p>Select a conversation</p></div>`;
    document.getElementById('slaInputArea').style.display='none';
    document.getElementById('dealBtn').style.display='none';
    return;
  }
  convs.forEach(c => container.appendChild(buildConversationRow(c)));
  openSLAChat(convs[0].id);
}

function openSLAChat(id){
  selectedConversation = id;
  const conv = activeConversations[id];
  if(!conv) return;

  document.getElementById('slaCurrentChat').textContent = `Lead ${conv.leadNumber} - ${conv.agentName}`;
  document.getElementById('slaCurrentDetails').textContent = `${conv.area||'-'} ‚Ä¢ ALPS: ${conv.score} ‚Ä¢ ${getLeadStatusText(conv.status)}`;

  const info = getConversationTimer(conv);
  const tEl = document.getElementById('slaCurrentTimer');
  tEl.textContent = info.text;
  tEl.style.background = info.class === 'timer-positive' ? 'rgba(231,76,60,.2)' : 'rgba(46,204,113,.2)';

  // show Deal button for human agent only (not AI)
  document.getElementById('dealBtn').style.display = conv.agentId ? 'inline-block' : 'none';

  const box = document.getElementById('slaMessages');
  box.innerHTML = '';
  conv.messages.forEach(m=>{
    const div = document.createElement('div');
    const cls = m.type === 'customer' ? 'message-user' : (m.type === 'system' ? 'message-system' : 'message-bot');
    div.className = 'message ' + cls;
    div.style.position = 'relative';
    div.innerHTML = `<div>${m.text}</div><div style="font-size:12px;color:#7f8c8d;margin-top:5px">${m.time}</div>`;
    if(m.type==='customer' && m.score){
      const sb = document.createElement('div'); sb.className='message-score'; sb.textContent=m.score; div.appendChild(sb);
    }
    box.appendChild(div);
  });
  box.scrollTop = box.scrollHeight;
  document.getElementById('slaInputArea').style.display = 'flex';
}

function sendSLAMessage(){
  const input = document.getElementById('slaMessageInput');
  const text = (input.value||'').trim();
  if(!text) return;
  input.value='';

  const conv = activeConversations[selectedConversation];
  if(!conv) return;

  // append agent message
  conv.messages.push({type:'agent', text, time: nowHHMMSS()});
  const box = document.getElementById('slaMessages');
  const d = document.createElement('div');
  d.className='message message-bot';
  d.innerHTML = `<div>${text}</div><div style="font-size:12px;color:#7f8c8d;margin-top:5px">${nowHHMMSS()}</div>`;
  box.appendChild(d);
  box.scrollTop = box.scrollHeight;

  // timer rules
  if(conv.status === 'waiting_agent_response'){
    conv.status = 'ongoing';
    conv.slaTimer = {type:'ongoing', timeRemaining: ONGOING_RESPONSE_TIMEOUT, alertTriggered:false, overdue:0};
  } else {
    conv.slaTimer.timeRemaining = ONGOING_RESPONSE_TIMEOUT;
    conv.slaTimer.alertTriggered = false;
    conv.slaTimer.overdue = 0;
  }
  updateConversationListItem(conv.id);

  // fake customer reply to keep demo moving
  setTimeout(()=>{
    const replies = ["Thanks! That helps.","I'm interested to view.","Sounds good!","The price is too high","I changed my mind"];
    const r = replies[Math.floor(Math.random()*replies.length)];
    const newScore = calculateScoreFromResponse(r, conv.score);
    conv.score = newScore;
    conv.scoreHistory = conv.scoreHistory || [];
    conv.scoreHistory.push({time: nowHHMMSS(), score: newScore});
    if(newScore < 35){
      handoverToAI(conv);
      return;
    }
    conv.messages.push({type:'customer', text:r, time:nowHHMMSS(), score:newScore});
    conv.slaTimer.timeRemaining = ONGOING_RESPONSE_TIMEOUT;
    const u = document.createElement('div');
    u.className='message message-user'; u.style.position='relative';
    u.innerHTML = `<div>${r}</div><div style="font-size:12px;color:#7f8c8d;margin-top:5px">${nowHHMMSS()}</div>`;
    const sb = document.createElement('div'); sb.className='message-score'; sb.textContent=newScore; u.appendChild(sb);
    box.appendChild(u); box.scrollTop = box.scrollHeight;
    updateConversationListItem(conv.id);
  }, 1500);
}

function handleSLAMessage(e){ if(e.key==='Enter') sendSLAMessage(); }

function calculateScoreFromResponse(response,currentScore){
  const lower = response.toLowerCase();
  if(/not interested|changed my mind|too high|expensive|no thanks?/.test(lower)) return clamp(currentScore-15,5,100);
  if(/interested|good|sounds good|great|perfect|view/.test(lower)) return clamp(currentScore+8,5,100);
  return clamp(currentScore + (Math.floor(Math.random()*7)-3),5,100);
}

function getConversationClass(conv){
  if(!conv.slaTimer) return 'conversation-item';
  if(conv.slaTimer.type==='initial' && conv.slaTimer.timeRemaining<=20) return 'sla-warning';
  if(conv.slaTimer.overdue>0) return 'sla-breach';
  return '';
}
function getConversationStatus(conv){
  if(!conv.slaTimer) return {status:'Active', color:'#2ecc71'};
  if(conv.status==='waiting_agent_response') return {status:'Waiting', color:'#f39c12'};
  if(conv.slaTimer.overdue>0) return {status:'Breach', color:'#e74c3c'};
  return {status:'Active', color:'#2ecc71'};
}
function getConversationTimer(conv){
  if(!conv.slaTimer) return {text:'--:--', class:'timer-negative', description:'No timer'};
  const t = conv.slaTimer;
  if(t.overdue>0){
    const m = Math.floor(t.overdue/60), s = String(t.overdue%60).padStart(2,'0');
    return {text:`+${m}:${s}`, class:'timer-positive', description:t.type==='initial'?'Initial response overdue':'Response overdue'};
  }
  if(t.timeRemaining>0){
    const m = Math.floor(t.timeRemaining/60), s = String(t.timeRemaining%60).padStart(2,'0');
    return {text:`-${m}:${s}`, class:'timer-negative', description:t.type==='initial'?'Initial response due':'Next response due'};
  }
  return {text:'0:00', class:'timer-negative', description:'Timer expired'};
}
function updateConversationListItem(convId){
  const conv = activeConversations[convId]; if(!conv) return;
  const row = document.querySelector(`[data-conv="${convId}"]`); if(!row) return;
  const tInfo = getConversationTimer(conv);
  const sInfo = getConversationStatus(conv);
  row.querySelector('.status-indicator').textContent = sInfo.status;
  const timer = row.querySelector('.timer-badge');
  timer.textContent = tInfo.text; timer.className='timer-badge '+tInfo.class;
  row.className = getConversationClass(conv) + ' conversation-item';
  const scoreBadge = row.querySelector('.live-score-badge');
  if(scoreBadge){ scoreBadge.textContent = conv.score; scoreBadge.style.background = conv.score>50?'#e74c3c':(conv.score>40?'#f39c12':'#95a5a6'); }
}

/* ======= REROUTING ======= */
function reassignToMostAvailable(conv){
  // remove from current agent
  if(conv.agentId){
    const arr = agentConversations[conv.agentId];
    const ix = arr.findIndex(c=>c.id===conv.id);
    if(ix>-1) arr.splice(ix,1);
  }
  const next = getMostAvailableAgent();
  if(next){
    conv.agentId = next.id;
    conv.agentName = next.name;
    conv.assignedTime = Date.now();
    conv.status = 'waiting_agent_response';
    conv.slaTimer = {type:'initial', timeRemaining: INITIAL_RESPONSE_TIMEOUT, alertTriggered:false, overdue:0};
    agentConversations[next.id].push(conv);
    conv.messages.push({type:'system', text:`Auto-reassigned to ${next.name} (most available) due to no response.`, time: nowHHMMSS()});
    if(selectedConversation === conv.id) openSLAChat(conv.id);
    showAllConversations();
  }else{
    conv.status = 'unassigned';
    conv.slaTimer.overdue++;
    conv.messages.push({type:'system', text:`No agent available.`, time: nowHHMMSS()});
  }
}
/* ======To AI=========*/
function handoverToAI(conv){
  // free current agent capacity
  if(conv.agentId){
    const arr = agentConversations[conv.agentId];
    const ix = arr.findIndex(c=>c.id===conv.id);
    if(ix>-1) arr.splice(ix,1);
  }
  conv.agentId = null;
  conv.agentName = 'AI Bot';
  conv.status = 'ai_takeover';
  conv.slaTimer = null;
  conv.messages.push({type:'system', text:`AI has taken over (score dropped below 35).`, time: nowHHMMSS()});

  // reflect in leads list
  const lead = allLeadsDatabase.find(l=>l.leadNumber===conv.leadNumber);
  if(lead){ lead.agent='AI Bot'; lead.status='ai_takeover'; }

  showAllConversations();
  syncAgentCapacitiesToConversations();
  refreshLeadsView();
}

/* ======= SLA ALERT ======= */
let alertInterval=null;
function showSlaAlert(convId){
  lastAlertConvId = convId;
  const c = activeConversations[convId];
  document.getElementById('alertConversation').textContent = `Lead ${c.leadNumber}`;
  document.getElementById('alertAgent').textContent = c.agentName || '-';
  let secs = 1;
  clearInterval(alertInterval);
  alertInterval = setInterval(()=> {
    secs++; const m=Math.floor(secs/60), s=String(secs%60).padStart(2,'0');
    document.getElementById('alertTime').textContent = `+${m}:${s}`;
  },1000);
  document.getElementById('slaAlert').style.display='block';
}
function goToConversation(){
  document.getElementById('slaAlert').style.display='none';
  if(lastAlertConvId){ switchPage('sla'); setTimeout(()=>openSLAChat(lastAlertConvId),200); }
}
function reassignConversation(){
  document.getElementById('slaAlert').style.display='none';
  if(lastAlertConvId && activeConversations[lastAlertConvId]){
    reassignToMostAvailable(activeConversations[lastAlertConvId]);
  }
}

function escalateConversation(){
  if(!selectedConversation) return;
  const conv = activeConversations[selectedConversation];
  if(!conv) return;

  // free current agent capacity
  if(conv.agentId){
    const arr = agentConversations[conv.agentId];
    const ix = arr.findIndex(c=>c.id===conv.id);
    if(ix>-1) arr.splice(ix,1);
  }

  // attempt reassign to most-available
  const next = getMostAvailableAgent();
  if(next){
    conv.agentId = next.id;
    conv.agentName = next.name;
    conv.status = 'waiting_agent_response';
    conv.slaTimer = {type:'initial', timeRemaining: INITIAL_RESPONSE_TIMEOUT, alertTriggered:false, overdue:0};
    agentConversations[next.id].push(conv);
    conv.messages.push({type:'system', text:`Escalated and reassigned to ${next.name} (most available).`, time: nowHHMMSS()});
  }else{
    conv.agentId = null;
    conv.agentName = 'In Queue';
    conv.status = 'in_queue';
    conv.slaTimer = null;
    conv.messages.push({type:'system', text:`Escalated: no agents available right now.`, time: nowHHMMSS()});
  }

  showAllConversations();
  openSLAChat(conv.id);
  syncAgentCapacitiesToConversations();
}

/* ======= DEAL (CLOSE WON) ======= */
function markConversationAsDeal(){
  if(!selectedConversation) return;
  const conv = activeConversations[selectedConversation];
  if(!conv) return;

  // move lead to completed list
  const idx = allLeadsDatabase.findIndex(l=>l.leadNumber===conv.leadNumber);
  let lead;
  if(idx>-1){
    lead = allLeadsDatabase[idx];
    allLeadsDatabase.splice(idx,1);
  } else {
    // if not found (edge case), create a minimal lead object
    lead = { id:`lead_${conv.leadNumber}`, leadNumber:conv.leadNumber, score:conv.score, area:conv.area, budget:'-', movein:'-', agent:conv.agentName };
  }
  lead.status = 'completed';
  completedLeads.push(lead);

  // free capacity from agent
  if(conv.agentId){
    const arr = agentConversations[conv.agentId];
    const ix = arr.findIndex(c=>c.id===conv.id);
    if(ix>-1) arr.splice(ix,1);
  }

  // remove from active conversations
  delete activeConversations[selectedConversation];
  selectedConversation = null;

  // UI
  showAllConversations();
  document.getElementById('slaMessages').innerHTML =
    `<div style="text-align:center;color:#7f8c8d;margin-top:40px">
       <p>Conversation closed as <strong>Deal</strong>. Capacity freed.</p>
     </div>`;
  document.getElementById('slaInputArea').style.display='none';
  document.getElementById('dealBtn').style.display='none';
  refreshLeadsView();
  syncAgentCapacitiesToConversations();
}

/* ======= CHART (unchanged basics) ======= */
let leadTrendChart = null;

function showLeadChart(leadId){
  // Find by id in current lists
  const lead = allLeadsDatabase.find(l=>l.id===leadId) || completedLeads.find(l=>l.id===leadId);

  // try to pull score history from active conversation (if any)
  const conv = Object.values(activeConversations).find(c => c.leadNumber === (lead?.leadNumber || ''));
  const history = (conv && conv.scoreHistory?.length) ? conv.scoreHistory
                : [{time: nowHHMMSS(), score: lead?.score || 0}];

  // open modal
  document.getElementById('leadChartTitle').textContent =
    `Lead ${lead?.leadNumber || leadId} ‚Ä¢ Score trend`;
  document.getElementById('leadChartModal').style.display = 'block';

  const ctx = document.getElementById('leadTrendCanvas').getContext('2d');
  const labels = history.map(h=>h.time);
  const data = history.map(h=>h.score);

  if(leadTrendChart){ leadTrendChart.destroy(); }
  leadTrendChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels,
      datasets: [{ label:'ALPS Score', data, fill:false, tension:0.25 }]
    },
    options: {
      animation:false,
      scales:{ y:{ min:0, max:100 } }
    }
  });
}

function getLeadStatusText(status){
  switch(status){
    case 'assigned': return 'Assigned';
    case 'ai_handling': return 'AI Handling';
    case 'ai_takeover': return 'AI Takeover';
    case 'in_queue': return 'Queued';
    case 'completed': return 'Completed';
    case 'waiting_agent_response': return 'Waiting Agent';
    case 'ongoing': return 'Ongoing';
    default: return 'Pending';
  }
}

/* ==== LEGACY SHIMS ‚Äì add here ==== */
function getStatusText(status){
  // Alias to your existing labeler
  return getLeadStatusText(status);
}

function loadActiveConversation(conv){
  // Accept either an id string or a conversation object
  const id = (conv && typeof conv === 'object') ? conv.id : conv;
  if (!id) return;
  openSLAChat(id); // delegate to your existing renderer
}

</script>
  
<!-- Lead Chart Modal -->
<div id="leadChartModal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="document.getElementById('leadChartModal').style.display='none'">&times;</span>
    <h3 id="leadChartTitle" style="margin-bottom:12px">Lead Progress</h3>
    <canvas id="leadTrendCanvas" height="120"></canvas>
  </div>
</div>
  
</body>
</html>






